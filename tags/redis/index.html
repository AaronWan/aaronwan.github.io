<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>Tag: redis | é“ - è‡ªç„¶ ğŸƒ</title>
  <meta name="description" content="ç”Ÿæ´»ç‚¹æ»´å’ŒçŸ¥è¯†åˆ†äº«" />
  <meta name="keywords" content="" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="/">
  <link rel="alternate" href="/atom.xml" title="é“ - è‡ªç„¶ ğŸƒ" type="application/atom+xml">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="ç”Ÿæ´»ç‚¹æ»´å’ŒçŸ¥è¯†åˆ†äº«">
<meta property="og:type" content="website">
<meta property="og:title" content="é“ - è‡ªç„¶ ğŸƒ">
<meta property="og:url" content="http://example.com/tags/redis/index.html">
<meta property="og:site_name" content="é“ - è‡ªç„¶ ğŸƒ">
<meta property="og:description" content="ç”Ÿæ´»ç‚¹æ»´å’ŒçŸ¥è¯†åˆ†äº«">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="ä¸‡æ¾">
<meta name="twitter:card" content="summary">
    
  <link href="https://fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <link href='//cdn.bootcss.com/node-waves/0.7.5/waves.min.css' rel='stylesheet'>
  
<link rel="stylesheet" href="/style.css">

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>


  <script>setLoadingBarProgress(20)</script> 
  <header class="l_header">
	<div class='wrapper'>
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href='/' >
				é“ - è‡ªç„¶ ğŸƒ
			</a>

			<div class='menu'>
				<ul class='h-list'>
					
						<li>
							<a class='flat-box nav-home' href='/'>
								ä¸»é¡µ
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-archives' href='/archives'>
								åˆ†ç±»æŸ¥çœ‹
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-about' href='/about'>
								å…³äºæˆ‘
							</a>
						</li>
					
				</ul>
				<div class='underline'></div>
			</div>
			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search" />
						<span class="icon icon-search"></span>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a href='javascript:void(0)'><span class="icon icon-search flat-box"></span></a></li>
				
				<li class='s-menu'><a href='javascript:void(0)'><span class="icon icon-menu flat-box"></span></a></li>
			</ul>
		</div>
		
		<div class='nav-sub container container--flex'>
			<a class="logo" class="flat-box" href='javascript:void(0)'>
				Word of Forks
			</a>

			<ul class='switcher h-list'>
				<li class='s-comment'><a href='javascript:void(0)'><span class="icon icon-chat_bubble_outline flat-box"></span></a></li>
				<li class='s-top'><a href='javascript:void(0)'><span class="icon icon-arrow_upward flat-box"></span></a></li>
				<li class='s-toc'><a href='javascript:void(0)'><span class="icon icon-format_list_numbered flat-box"></span></a></li>
			</ul>
		</div>
	</div>
</header>
<aside class="menu-phone">
	<nav>
		
			<a href="/" class="nav-home nav">
				ä¸»é¡µ
			</a>
		
			<a href="/archives" class="nav-archives nav">
				åˆ†ç±»æŸ¥çœ‹
			</a>
		
			<a href="/about" class="nav-about nav">
				å…³äºæˆ‘
			</a>
		
	</nav>
</aside>

    <script>setLoadingBarProgress(40);</script>
  <div class="l_body">
    <div class='container clearfix'>
      <div class='l_main'>
        
  <script>
    window.subData= { title:'Tag : redis'}
  </script>

<section class="post-list">
	
    <div class='post-wrapper'>
      <article class="post reveal">
    <section class="meta">
        
            <h2 class="title">
                <a href="/2018/04/15/redis/">
                    redis
                </a>
            </h2>
        
        <time>
            4æœˆ 15, 2018
        </time>
        
    
    <div class='cats'>
        <a href="/categories/%E6%8A%80%E6%9C%AF/">æŠ€æœ¯</a>
    </div>

    </section>
    <section class="article typo">
        <h2 id="ä¸€-redis-å®ç°åŸç†"><a href="#ä¸€-redis-å®ç°åŸç†" class="headerlink" title="ä¸€. redis å®ç°åŸç†"></a>ä¸€. redis å®ç°åŸç†</h2><h3 id="äº”ç§ç±»å‹çš„é”®çš„åº•å±‚å®ç°æ•°æ®ç»“æ„"><a href="#äº”ç§ç±»å‹çš„é”®çš„åº•å±‚å®ç°æ•°æ®ç»“æ„" class="headerlink" title="äº”ç§ç±»å‹çš„é”®çš„åº•å±‚å®ç°æ•°æ®ç»“æ„"></a>äº”ç§ç±»å‹çš„é”®çš„åº•å±‚å®ç°æ•°æ®ç»“æ„</h3><p>å…·ä½“å‘½ä»¤å¯å‚è€ƒ<a href="2015/11/10/redis%E7%B4%A2%E5%BC%95/">å‘½ä»¤</a></p>
<ol>
<li><p>SDS( simple dynamic string) ç®€å•åŠ¨æ€å­—ç¬¦ä¸²</p>
 <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sdshdr</span>&#123;</span></span><br><span class="line"><span class="keyword">int</span> len;</span><br><span class="line"><span class="keyword">int</span> <span class="built_in">free</span>;</span><br><span class="line"><span class="keyword">char</span> buf[];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>é“¾è¡¨</p>
 <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">listNode</span>&#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">listNode</span> *<span class="title">prev</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">listNode</span> *<span class="title">next</span>;</span></span><br><span class="line"><span class="keyword">void</span> *value;</span><br><span class="line">&#125;listNode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">list</span>&#123;</span></span><br><span class="line">listNode *head;</span><br><span class="line">listNode *tail;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> len;</span><br><span class="line"><span class="keyword">void</span> *(*dup)(<span class="keyword">void</span> *ptr);</span><br><span class="line"><span class="keyword">void</span> (*<span class="built_in">free</span>)(<span class="keyword">void</span> *ptr);</span><br><span class="line"><span class="keyword">int</span> (*match)(<span class="keyword">void</span> *ptr,<span class="keyword">void</span> *key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>å­—å…¸</p>
<p> Redis çš„å­—å…¸ä½¿ç”¨å“ˆå¸Œè¡¨ä½œä¸ºåº•å±‚å®ç°,ä¸€ä¸ªå“ˆå¸Œæ•·è¡é‡Œé¢å¯ä»¥æœ‰å¤šä¸ªèŠ‚ç‚¹,æ¯ä¸ªèŠ‚ç‚¹å°±ä¿å­˜äº†å­—å…¸ä¸­çš„ä¸€ä¸ªé”®å€¼å¯¹;</p>
<p> æ–°æ·»åŠ ä¸€ä¸ªé”®å€¼å¯¹åˆ°å­—å…¸é‡Œæ—¶,ç¨‹åºéœ€è¦å…ˆæ ¹æ®é”®å€¼å¯¹çš„é”®è®¡ç®—å‡ºå“ˆå¸Œå€¼å’Œç´¢å¼•å€¼,ç„¶åæ ¹æ®ç´¢å¼•å€¼,å°†åŒ…å«æ–°é”®å€¼å¯¹çš„å“ˆå¸Œè¡¨èŠ‚ç‚¹æ”¾åˆ°å“ˆå¸Œè¡¨æ•°ç»„çš„æŒ‡å®šç´¢å¼•ä¸Šé¢.å½“æœ‰ä¸¤ä¸ªæˆ–ä»¥ä¸Šæ•°é‡çš„é”®è¢«åˆ†é…åˆ°å“ˆå¸Œæ•°ç»„çš„åŒä¸€ä¸ªç´¢å¼•ä¸Šé¢æ—¶,æˆ‘ä»¬ç§°ä¸ºå†²çª.è¿™é‡Œä½¿ç”¨é“¾åœ°å€æ³•è§£å†³é”®å†²çª.</p>
<ul>
<li><p>å“ˆå¸Œè¡¨</p>
  <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictht</span>&#123;</span></span><br><span class="line">dictEntry **table;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> size;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> sizemask;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> used;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  sizemask å€¼å’Œå“ˆå¸Œå€¼ä¸€èµ·å†³å®šä¸€ä¸ªé”®åº”è¯¥è¢«æ”¾åˆ°tableæ•°ç»„çš„å“ªä¸ªç´¢å¼•ä¸Šé¢.</p>
</li>
<li><p>å“ˆå¸Œè¡¨èŠ‚ç‚¹</p>
  <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span>&#123;</span></span><br><span class="line"><span class="keyword">void</span> *key;</span><br><span class="line"><span class="keyword">union</span>&#123;</span><br><span class="line"><span class="keyword">void</span> *val;</span><br><span class="line">uint64_tu64;</span><br><span class="line">int64_ts64;</span><br><span class="line">&#125; v;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> *<span class="title">next</span>;</span> <span class="comment">//è§£å†³é”®å†²çªçš„é—®é¢˜</span></span><br><span class="line">&#125; dictEntry;</span><br></pre></td></tr></table></figure></li>
<li><p>å­—å…¸</p>
  <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dict</span>&#123;</span></span><br><span class="line">dictType *type; <span class="comment">//ç±»å‹ç‰¹å®šå‡½æ•°</span></span><br><span class="line"><span class="keyword">void</span> *privdata;<span class="comment">//ç§æœ‰æ•°æ®</span></span><br><span class="line">dictht ht[<span class="number">2</span>];<span class="comment">//å“ˆå¸Œè¡¨</span></span><br><span class="line"><span class="keyword">int</span> trehashidx;<span class="comment">//ç´¢å¼•</span></span><br><span class="line">&#125; dict;</span><br></pre></td></tr></table></figure></li>
<li><p>rehash(å®é™…è¿‡ç¨‹,æ˜¯æ¸è¿›å¼çš„)</p>
<p>  å½“å“ˆå¸Œè¡¨ä¸­é”®å€¼çš„æ•°é‡å¤ªå¤šæˆ–å¤ªå°‘æ—¶,ä¸ºäº†è®©å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­ç»´æŒåœ¨ä¸€ä¸ªåˆç†çš„èŒƒå›´ä¹‹å†…,ç¨‹åºéœ€è¦å¯¹å“ˆå¸Œè¡¨çš„å¤§å°è¿›è¡Œç›¸åº”çš„æ‰©å±•æˆ–è€…æ”¶ç¼©.</p>
<ol>
<li><p>ä¸ºå­—æ®µçš„ht[1]å“ˆå¸Œè¡¨åˆ†é…ç©ºé—´,è¿™ä¸ªç©ºé—´å¤§å°å–å†³äºè¦æ‰§è¡Œçš„æ“ä½œ,ä»¥åŠht[0]å½“å‰åŒ…å«çš„é”®å€¼å¯¹æ•°é‡</p>
<ol>
<li>å¦‚æœæ˜¯æ‰©å±•æ“ä½œ,é‚£ä¹ˆå¤§å°ä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äºht[0].used*2çš„2çš„næ¬¡æ–¹</li>
<li>å¦‚æœæ‰§è¡Œçš„æ˜¯æ”¶ç¼©æ“ä½œ,é‚£ä¹ˆht[1]çš„å¤§å°ä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äºht[0].usedçš„2çš„næ¬¡æ–¹</li>
</ol>
</li>
<li><p>å°†ä¿å­˜åœ¨ht[0]ä¸­çš„æ‰€æœ‰é”®å€¼å¯¹rehashåˆ°ht[1]ä¸Šé¢:rehashæŒ‡é‡æ–°è®¡ç®—é”®çš„å“ˆå¸Œå€¼å’Œç´¢å¼•å€¼,ç„¶åå°†é”®å€¼å¯¹æ”¾ç½®åˆ°ht[1]å“ˆå¸Œè¡¨çš„æŒ‡å®šä½ç½®ä¸Š</p>
</li>
<li><p>å°†ht[0]é‡Šæ”¾ç©ºé—´,åŒæ—¶å°†ht[0]å’Œht[1]æ¢ä½ç½®</p>
<p>ä½•æ—¶è¿›è¡Œæ‰©å±•å’Œæ”¶ç¼©<br>è´Ÿè½½å› å­= ht[0].used(å·²ä¿å­˜çš„èŠ‚ç‚¹æ•°é‡)/å“ˆå¸Œè¡¨çš„å¤§å°</p>
<p>å½“è´Ÿè½½å› å­å¤§äº 5 (å¾…ç¡®è®¤),æˆ–&lt;0.1 æ—¶</p>
</li>
</ol>
</li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="http://daoluan.net/%E6%9C%AA%E5%88%86%E7%B1%BB/2014/06/26/decode-redis-data-struct-skiplist.html">è·³è·ƒè¡¨</a></p>
<p> skiplist æ˜¯ä¸€ç§æœ‰åºçš„æ•°æ®ç»“æ„,å®ƒé€šè¿‡åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸­ç»´æŒå¤šä¸ªæŒ‡å‘å…¶ä»–èŠ‚ç‚¹çš„æŒ‡é’ˆ,ä»è€Œè¾¾åˆ°å¿«é€Ÿè®¿é—®èŠ‚ç‚¹çš„ç›®çš„.<br> redisåœ¨ä»¥ä¸‹ä¸¤ä¸ªåœ°æ–¹ç”¨åˆ°äº†è·³è·ƒè¡¨:</p>
<ol>
<li>æœ‰åºé›†åˆé”® zset</li>
<li>åœ¨é›†ç¾¤èŠ‚ç‚¹ä¸­ç”¨é€”å†…éƒ¨æ•°æ®ç»“æ„</li>
</ol>
</li>
<li><p>æ•´æ•°é›†åˆ</p>
<p> intset æ˜¯é›†åˆé”®çš„åº•å±‚å®ç°ä¹‹ä¸€,å½“ä¸€ä¸ªé›†åˆåªåŒ…å«æ•´æ•°å€¼å…ƒç´ ,å¹¶ä¸”è¿™ä¸ªé›†åˆçš„å…ƒç´ æ•°é‡ä¸å¤šæ—¶,Rediså°±ä¼šä½¿ç”¨æ•´æ•°é›†åˆä½œä¸ºé›†åˆé”®çš„åº•å±‚å®ç°.</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6379&gt; SADD numbers 1 3 5 6 7</span><br><span class="line">(integer) 5</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; OBJECT ENCODING numbers</span><br><span class="line">&quot;intset&quot;</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; sadd numbers 0943890384093845903845094385</span><br><span class="line">(integer) 1</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; smembers numbers</span><br><span class="line">1) &quot;3&quot;</span><br><span class="line">2) &quot;0943890384093845903845094385&quot;</span><br><span class="line">3) &quot;7&quot;</span><br><span class="line">4) &quot;2&quot;</span><br><span class="line">5) &quot;6&quot;</span><br><span class="line">6) &quot;1&quot;</span><br><span class="line">7) &quot;9&quot;</span><br><span class="line">8) &quot;5&quot;</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; OBJECT ENCODING numbers</span><br><span class="line">&quot;hashtable&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="æ¯å½“æˆ‘ä»¬è¦å°†ä¸€ä¸ªæ–°å…ƒç´ æ·»åŠ åˆ°æ•´æ•°é›†åˆé‡Œé¢-å¹¶ä¸”æ–°å…ƒç´ çš„ç±»å‹æ¯”æ•´æ•°é›†åˆç°æœ‰çš„æ‰€æœ‰å…ƒç´ çš„ç±»å‹éƒ½è¦é•¿æ—¶-æ•´æ•°é›†åˆéœ€è¦å…ˆè¿›è¡Œå‡çº§-ç„¶åæ‰èƒ½å°†æ–°å…ƒç´ æ·»åŠ åˆ°æ•´æ•°é›†åˆé‡Œé¢-è¯·è®°ä½-è¿™é‡Œä¸ä¼šé™çº§çš„"><a href="#æ¯å½“æˆ‘ä»¬è¦å°†ä¸€ä¸ªæ–°å…ƒç´ æ·»åŠ åˆ°æ•´æ•°é›†åˆé‡Œé¢-å¹¶ä¸”æ–°å…ƒç´ çš„ç±»å‹æ¯”æ•´æ•°é›†åˆç°æœ‰çš„æ‰€æœ‰å…ƒç´ çš„ç±»å‹éƒ½è¦é•¿æ—¶-æ•´æ•°é›†åˆéœ€è¦å…ˆè¿›è¡Œå‡çº§-ç„¶åæ‰èƒ½å°†æ–°å…ƒç´ æ·»åŠ åˆ°æ•´æ•°é›†åˆé‡Œé¢-è¯·è®°ä½-è¿™é‡Œä¸ä¼šé™çº§çš„" class="headerlink" title=" æ¯å½“æˆ‘ä»¬è¦å°†ä¸€ä¸ªæ–°å…ƒç´ æ·»åŠ åˆ°æ•´æ•°é›†åˆé‡Œé¢,å¹¶ä¸”æ–°å…ƒç´ çš„ç±»å‹æ¯”æ•´æ•°é›†åˆç°æœ‰çš„æ‰€æœ‰å…ƒç´ çš„ç±»å‹éƒ½è¦é•¿æ—¶,æ•´æ•°é›†åˆéœ€è¦å…ˆè¿›è¡Œå‡çº§,ç„¶åæ‰èƒ½å°†æ–°å…ƒç´ æ·»åŠ åˆ°æ•´æ•°é›†åˆé‡Œé¢,è¯·è®°ä½,è¿™é‡Œä¸ä¼šé™çº§çš„"></a> æ¯å½“æˆ‘ä»¬è¦å°†ä¸€ä¸ªæ–°å…ƒç´ æ·»åŠ åˆ°æ•´æ•°é›†åˆé‡Œé¢,å¹¶ä¸”æ–°å…ƒç´ çš„ç±»å‹æ¯”æ•´æ•°é›†åˆç°æœ‰çš„æ‰€æœ‰å…ƒç´ çš„ç±»å‹éƒ½è¦é•¿æ—¶,æ•´æ•°é›†åˆéœ€è¦å…ˆè¿›è¡Œå‡çº§,ç„¶åæ‰èƒ½å°†æ–°å…ƒç´ æ·»åŠ åˆ°æ•´æ•°é›†åˆé‡Œé¢,è¯·è®°ä½,è¿™é‡Œä¸ä¼šé™çº§çš„</h2><p> å…¶æ˜¯Redisä¿å­˜æ•´æ•°å€¼çš„é›†åˆæŠ½è±¡æ•°æ®ç»“æ„,å®ƒå¯ä»¥ä¿å­˜int16_t,int32_t,int64_tçš„æ•´æ•°å€¼,å¹¶ä¸”ä¿è¯é›†åˆä¸­ä¸ä¼šå‡ºç°é‡å¤å…ƒç´ .</p>
 <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">intset</span>&#123;</span></span><br><span class="line"><span class="keyword">uint32_t</span> encoding;<span class="comment">//ç¼–ç æ–¹å¼ INTSET_ENC_INT16,INTSET_ENC_INT32,INTSET_ENC_INT64</span></span><br><span class="line"><span class="keyword">uint32_t</span> length;<span class="comment">//é›†åˆåŒ…å«çš„å…ƒç´ æ•°é‡</span></span><br><span class="line"><span class="keyword">int8_t</span> contents[]; <span class="comment">//ä¿å­˜å…ƒç´ çš„æ•°ç»„,æ•°ç»„ä¸­æŒ‰å€¼çš„å¤§å°ä»å°åˆ°å¤§æœ‰åºæ’åˆ—,å¹¶ä¸”æ•°ç»„ä¸­ä¸åŒ…å«ä»»ä½•é‡å¤é¡¹;å…¶çœŸæ­£çš„ç±»å‹å–å†³äºencodingå±æ€§çš„å€¼:</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>å‹ç¼©åˆ—è¡¨<br> ziplist,æ˜¯åˆ—è¡¨é”®å’Œå“ˆå¸Œé”®çš„åº•å±‚å®ç°ä¹‹ä¸€.å½“ä¸€ä¸ªåˆ—è¡¨é”®åªåŒ…å«å°‘é‡åˆ—è¡¨é¡¹,å¹¶ä¸”æ¯ä¸ªåˆ—è¡¨é¡¹è¦ä¹ˆå°±æ˜¯å°æ•´æ•°å€¼,è¦ä¹ˆå°±æ˜¯é•¿åº¦æ¯”è¾ƒçŸ­çš„å­—ç¬¦ä¸²,é‚£ä¹ˆRediså°±ä¼šä½¿ç”¨å‹ç¼©åˆ—è¡¨æ¥åšåˆ—è¡¨é”®çš„åº•å±‚å®ç°.</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6379&gt; rpush kdf djf f df d f d f &quot;sdf&quot;</span><br><span class="line">(integer) 8</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; OBJECT ENCODING kdf</span><br><span class="line">&quot;ziplist&quot;</span><br></pre></td></tr></table></figure>

<p> å‹ç¼©åˆ—è¡¨æ˜¯ä¸ºäº†èŠ‚çº¦å†…å­˜è€Œå¼€å‘çš„,æ˜¯ç”±ä¸€ç³»åˆ—ç‰¹æ®Šçš„è¿ç»­å†…å­˜å—ç»„æˆçš„é¡ºåºå‹æ•°æ®ç»“æ„.ä¸€ä¸ªå‹ç¼©åˆ—è¡¨å¯ä»¥åŒ…å«ä»»æ„å¤šä¸ªèŠ‚ç‚¹,æ¯ä¸ªèŠ‚ç‚¹å¯ä»¥ä¿å­˜ä¸€ä¸ªå­—èŠ‚æ•°ç»„æˆ–è€…ä¸€ä¸ªæ•´æ•°å€¼.</p>
</li>
</ol>
<h3 id="å¯¹è±¡å¤„ç†æœºåˆ¶ä»¥åŠæ•°æ®åº“çš„å®ç°åŸç†"><a href="#å¯¹è±¡å¤„ç†æœºåˆ¶ä»¥åŠæ•°æ®åº“çš„å®ç°åŸç†" class="headerlink" title="å¯¹è±¡å¤„ç†æœºåˆ¶ä»¥åŠæ•°æ®åº“çš„å®ç°åŸç†"></a>å¯¹è±¡å¤„ç†æœºåˆ¶ä»¥åŠæ•°æ®åº“çš„å®ç°åŸç†</h3><ol>
<li><p>å¯¼å…¥</p>
<ol>
<li>Redis åŸºäºè¿™äº›æ•°æ®ç»“æ„åˆ›å»ºä¸€ä¸ªå¯¹è±¡ç³»ç»Ÿ,å…¶åŒ…å« å­—ç¬¦ä¸²,åˆ—è¡¨å¯¹è±¡,å“ˆå¸Œå¯¹è±¡,é›†åˆå¯¹è±¡å’Œæœ‰åºé›†åˆå¯¹è±¡ äº”ç§ç±»å‹çš„å¯¹è±¡,æ¯ç§å¯¹è±¡éƒ½è‡³å°‘ä¸€ç§æˆ‘ä»¬å‰é¢æ‰€ä»‹ç»çš„æ•°æ®ç»“æ„.</li>
<li>ä½¿ç”¨å¯¹è±¡çš„å¥½å¤„,æˆ‘ä»¬å¯ä»¥é’ˆå¯¹ä¸åŒçš„ä½¿ç”¨åœºæ™¯,ä¸ºå¯¹è±¡è®¾ç½®å¤šç§ä¸åŒçš„æ•°æ®ç»“æ„pugmwwè€Œä¼˜åŒ–å¯¹è±¡åœ¨ä¸åŒåœºæ™¯ä¸‹çš„ä½¿ç”¨æ•ˆç‡.</li>
<li>å¯¹è±¡ç³»ç»ŸåŸºäºå¼•ç”¨è®¡æ•°æŠ€æœ¯çš„å†…å­˜å›æ”¶æœºåˆ¶,å½“ç¨‹åºä¸å†ä½¿ç”¨æŸä¸ªå¯¹è±¡çš„æ—¶å€™,è¿™ä¸ªå¯¹è±¡æ‰€æˆ˜èƒœçš„å†…å­˜å°±ä¼šè¢«è‡ªåŠ¨é‡Šæ”¾;å¦å¤–,Redisè¿˜é€šè¿‡å¼•ç”¨è®¡æ•°æŠ€æœ¯å®ç°äº†å¯¹è±¡å…±äº«æœºåˆ¶,è¿™ä¸€æœºåˆ¶å¯ä»¥åœ¨é€‚å½“çš„æ¡ä»¶ä¸‹,é€šè¿‡è®©å¤šä¸ªæ•°æ®åº“é”®å…±äº«åŒä¸€ä¸ªå¯¹è±¡æ¥èŠ‚çº¦å†…å­˜.</li>
<li>å¯¹è±¡å¸¦æœ‰è®¿é—®æ—¶é—´è®°å½•ä¿¡æ¯,è¯¥ä¿¡æ¯å¯ä»¥ç”¨äºè®¡ç®—æ•°æ®åº“çš„ç©ºè½¬æ—¶é•¿ ,åœ¨æœåŠ¡å™¨å¯ç”¨äº†maxmemoryåŠŸèƒ½çš„æƒ…å†µä¸‹,ç©ºè½¬æ—¶é•¿è¾ƒå¤§çš„é‚£äº›é”®å¯èƒ½ä¼šä¼˜å…ˆè¢«æœåŠ¡å™¨åˆ é™¤.</li>
</ol>
</li>
<li><p>å¯¹è±¡çš„ç±»å‹å’Œç¼–ç  type</p>
<p> Redisä½¿ç”¨å¯¹è±¡æ¥è¡¨ç¤ºæ•°æ®åº“ä¸­çš„é”®å€¼,æ¯æ¬¡æˆ‘ä»¬åœ¨åº“ä¸­æ–°åˆ›å»ºä¸€ä¸ªé”®å€¼å¯¹æ—¶,æˆ‘ä»¬è‡³å°‘ä¼šåˆ›å»ºä¸¤ä¸ªå¯¹è±¡,ä¸€ä¸ªæ˜¯é”®å¯¹è±¡,å¦ä¸€ä¸ªæ˜¯å€¼å¯¹è±¡.</p>
 <figure class="highlight accesslog"><table><tr><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; set name aaron</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; get name</span><br><span class="line"><span class="string">&quot;aaron&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; OBJECT ENCODING name</span><br><span class="line"><span class="string">&quot;embstr&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; type name</span><br><span class="line">string</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; OBJECT idletime name</span><br><span class="line">(integer) <span class="number">46</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<p> æ¯ä¸€ä¸ªå¯¹è±¡éƒ½ç”±ä¸€ä¸ªredisObjectç»“æ„è¡¨ç¤º,è¯¥ç»“æ„ä¸­å’Œä¿å­˜æ•°æ®æœ‰å…³çš„ä¸‰ä¸ªå±æ€§åˆ†åˆ«æ˜¯typeå±æ€§,encodingå±æ€§å’Œptrå±æ€§:</p>
 <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisObject</span>&#123;</span></span><br><span class="line"><span class="keyword">unsigned</span> type:<span class="number">4</span>;</span><br><span class="line"><span class="keyword">unsigned</span> encoding:<span class="number">4</span>;</span><br><span class="line"><span class="keyword">void</span> *ptr;<span class="comment">//æ¯æ—¥å‘åº•å±‚å®ç°æ•°æ®ç»“æ„çš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="keyword">int</span> refcount;<span class="comment">//å¼•ç”¨è®¡æ•°</span></span><br><span class="line"><span class="keyword">unsigned</span> lru:<span class="number">22</span>;<span class="comment">//è¯¥å¯¹è±¡æœ€åä¸€æ¬¡è¢«è®¿é—®çš„æ—¶é—´</span></span><br><span class="line">&#125;robj;</span><br></pre></td></tr></table></figure>
<p> typeè®°å½•äº†å¯¹è±¡çš„ç±»å‹,è¿™ä¸ªå±æ€§çš„å€¼æœ‰ string,list,hash,set,zset</p>
</li>
<li><p>ç¼–ç å’Œåº•å±‚å®ç°  OBJECT ENCODING<br> å¯¹è±¡çš„ptræŒ‡é’ˆæŒ‡å‘å¯¹è±¡çš„åº•å±‚å®ç°æ•°æ®ç»“æ„,è€Œè¿™äº›æ•°æ®ç»“æ„ç”±å¯¹è±¡çš„encodingå±æ€§å†³å®š.ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªå¯¹è±¡ä½¿ç”¨äº†ä»€ä¹ˆæ•°æ®ç»“æ„ä½œä¸ºå¯¹è±¡çš„åº•å±‚å®ç°,è¿™ä¸ªå±æ€§å€¼å¯ä»¥æ˜¯</p>
 <figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">int (<span class="name">long</span> ç±»å‹)</span><br><span class="line">embstr (<span class="name">embstr</span>ç¼–ç çš„ç®€å•åŠ¨æ€å­—ç¬¦ä¸²)</span><br><span class="line">raw (ç®€å•åŠ¨æ€å­—ç¬¦ä¸²)</span><br><span class="line">ht (å­—å…¸)</span><br><span class="line">linkedlist (åŒç«¯é“¾è¡¨)</span><br><span class="line">ziplist (å‹ç¼©é“¾è¡¨)</span><br><span class="line">intset (æ•´æ•°é›†åˆ)</span><br><span class="line">skiplist (è·³è·ƒé“¾è¡¨å’Œå­—å…¸)</span><br></pre></td></tr></table></figure>
<p> æ¯ç§ç±»å‹å¯¹è±¡éƒ½è‡³å°‘ä½¿ç”¨äº†ä¸¤ç§ä¸åŒçš„ç¼–ç .</p>
 <figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">string int/embstr/raw</span><br><span class="line">list ziplist/linkedlist</span><br><span class="line">hash ziplist/ht</span><br><span class="line"><span class="builtin-name">set</span>  intset/ht</span><br><span class="line">zset  ziplist/skiplist</span><br></pre></td></tr></table></figure></li>
<li><p>æ•°æ®å…±äº« åªå…±äº«0-9999çš„å­—ç¬¦ä¸²å¯¹è±¡</p>
 <figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; SET a <span class="number">100</span></span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; OBJECT <span class="built_in">ref</span>count a</span><br><span class="line">(<span class="built_in">int</span>eger) <span class="number">2</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; OBJECT <span class="built_in">ref</span>count a</span><br><span class="line">(<span class="built_in">int</span>eger) <span class="number">2</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; SET b <span class="number">100</span></span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; OBJECT <span class="built_in">ref</span>count a</span><br><span class="line">(<span class="built_in">int</span>eger) <span class="number">3</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


</li>
</ol>
<h3 id="å•æœºæ•°æ®åº“çš„å®ç°"><a href="#å•æœºæ•°æ®åº“çš„å®ç°" class="headerlink" title="å•æœºæ•°æ®åº“çš„å®ç°"></a>å•æœºæ•°æ®åº“çš„å®ç°</h3><ol>
<li><p>åœ¨redisServerç»“æ„çš„dbæ•°ç»„ä¸­,æ¯ä¸ªredisDb ç»“æ„ä»£è¡¨ä¸€ä¸ªæ•°æ®åº“,å¯åŠ¨æœåŠ¡å™¨æ—¶,æœåŠ¡å™¨ä¼šæ ¹æ®dbnumæ¥å†³å®šåº”è¯¥åˆ›å»ºå¤šå°‘ä¸ªæ•°æ®åº“:</p>
 <figure class="highlight python-repl"><table><tr><td class="code"><pre><span class="line">struct redisServer&#123;</span><br><span class="line"><span class="meta">...</span></span><br><span class="line">redisDb *db;</span><br><span class="line">int dbnum;</span><br><span class="line"><span class="meta">...</span></span><br><span class="line">&#125;redisClient</span><br></pre></td></tr></table></figure>
<p> å®¢æˆ·ç«¯å¯ä»¥æ ¹æ®å‘½ä»¤selectæ¥è¿›è¡Œåˆ‡æ¢ç›®æ ‡æ•°æ®åº“</p>
</li>
<li><p>æ•°æ®åº“é”®ç©ºé—´</p>
<p> æ˜¯ä¸€ä¸ªé”®å€¼å¯¹æ•°æ®åº“æœåŠ¡å™¨,å…¶ä¸­æ¯ä¸ªæ•°æ®åº“éƒ½ç”±ä¸€ä¸ªredisDbç»“æ„è¡¨ç¤º,å…¶ä¸­redisDbç»“æ„çš„dictå­—å…¸ä¿å­˜äº†æ•°æ®åº“ä¸­çš„æ‰€æœ‰é”®å€¼å¯¹,æˆ‘ä»¬ç§°è¿™ä¸ªå­—å…¸ä¸º é”®ç©ºé—´<br> typedef struct redisDb{<br> dict *dict;<br> dict *expires;  key æ˜¯å¯¹è±¡,value æ˜¯è¿‡æœŸæ—¶é—´<br> }redisDb</p>
</li>
<li><p>è®¾ç½®ç”Ÿå­˜æ—¶é—´æˆ–è¿‡æœŸæ—¶é—´</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set name wansong</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; expire name 10</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">&quot;wansong&quot;</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">(nil)</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>æ•°æ®åº“é€šçŸ¥<br> 2.8 æ–°ç‰ˆæœ¬ä¸­å¢åŠ çš„åŠŸèƒ½,å¯ä»¥é€šè¿‡è®¢é˜…ç»™å®ƒçš„é¢‘é“æˆ–è€…æ¨¡å¼,æ¥è·çŸ¥æ•°æ®åº“ä¸­é”®çš„å˜åŒ–.åŠæ•°æ®åº“ä¸­å‘½ä»¤çš„æ‰§è¡Œæƒ…å†µ.</p>
</li>
</ol>
<h3 id="RDB-æŒä¹…åŒ–å’Œ-AOF-æŒä¹…åŒ–çš„å®ç°åŸç†"><a href="#RDB-æŒä¹…åŒ–å’Œ-AOF-æŒä¹…åŒ–çš„å®ç°åŸç†" class="headerlink" title="RDB æŒä¹…åŒ–å’Œ AOF æŒä¹…åŒ–çš„å®ç°åŸç†"></a>RDB æŒä¹…åŒ–å’Œ AOF æŒä¹…åŒ–çš„å®ç°åŸç†</h3><p>RDBæŒä¹…åŒ–åŠŸèƒ½,å¯ä»¥å°†Redisåœ¨å†…å­˜ä¸­çš„æ•°æ®åº“çŠ¶æ€ä¿å­˜åˆ°ç£ç›˜é‡Œé¢,é¿å…æ•°æ®æ„å¤–ä¸¢å¤±.ä¹Ÿå¯ä»¥æ ¹æ®æœåŠ¡å™¨é…ç½®é€‰é¡¹å®šæœŸæ‰§è¡Œ.<br>è¯¥åŠŸèƒ½å¯ä»¥å°†æŸä¸ªæ—¶é—´ç‚¹ä¸Šçš„æ•°æ®åº“çŠ¶æ€ä¿å­˜åˆ°ä¸€ä¸ªRDBæ–‡ä»¶ä¸­.è¯¥æ–‡ä»¶æ˜¯ä¸€ä¸ªç»è¿‡å‹ç¼©çš„äºŒè¿›åˆ¶æ–‡ä»¶,é€šè¿‡è¯¥æ–‡ä»¶å¯ä»¥è¿˜åŸç”ŸæˆRDBæ–‡ä»¶æ—¶çš„æ•°æ®åº“çŠ¶æ€.</p>
<ol>
<li><p>RDBæ–‡ä»¶çš„åˆ›å»ºä¸è½½å…¥</p>
<p> save å‘½ä»¤ä¼šé˜»å¡RedisæœåŠ¡å™¨è¿›ç¨‹,ç›´åˆ°RDBæ–‡ä»¶åˆ›å»ºå®Œæ¯•ä¸ºæ­¢,åœ¨æœåŠ¡å™¨è¿›ç¨‹é˜»å¡æœŸé—´,æœåŠ¡å™¨ä¸å¤„ç†ä»»åŠ¡å‘½ä»¤è¯·æ±‚.</p>
<p> bgsave background saving started è¯¥å‘½ä»¤ä¼šæ´¾ç”Ÿå‡ºä¸€ä¸ªå­è¿›ç¨‹,ç„¶åç”±å­è¿›ç¨‹è´Ÿè´£åˆ›å»ºRDBæ–‡ä»¶,æœåŠ¡å™¨è¿›ç¨‹ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚</p>
<p> åˆ›å»ºæ–‡ä»¶çš„å®é™…å·¥ä½œç”±rdbSaveå‡½æ•°å®Œæˆ,saveå’Œbgsaveå‘½ä»¤ä¼šä»¥ä¸åŒçš„æ–¹å¼è°ƒç”¨è¿™ä¸ªå‡½æ•°.</p>
<p> RDBæ–‡ä»¶çš„è½½å…¥æ˜¯è‡ªåŠ¨çš„,å½“ç¨‹åºå¯åŠ¨æ—¶ä¼šè‡ªåŠ¨è½½å…¥,å¦å¤–æ³¨æ„AOFæ–‡ä»¶çš„æ›´æ–°é¢‘ç‡é€šå¸¸æ¯”RDBé«˜,æ‰€ä»¥:</p>
<ol>
<li><p>å¦‚æœæœåŠ¡å™¨å¼€å¯äº†AOFæŒä¹…åŒ–åŠŸèƒ½,é‚£ä¹ˆæœåŠ¡å™¨ä¼šä¼˜å…ˆä½¿ç”¨AOFæ–‡ä»¶è¿˜åŸæ•°æ®åº“çŠ¶æ€</p>
</li>
<li><p>åªæœ‰åœ¨AOFæŒä¹…åŒ–åŠŸèƒ½å¤„äºå…³é—­çŠ¶æ€æ—¶,æœåŠ¡å™¨æ‰ä¼šä½¿ç”¨RDBæ–‡ä»¶æ¥è¿˜åŸæ•°æ®åº“çŠ¶æ€.</p>
<p>è½½å…¥RDBæ–‡ä»¶çš„å®é™…å·¥ä½œç”±rdbLoadå‡½æ•°å®Œæˆ;æ–‡ä»¶è½½å…¥æ—¶æœåŠ¡å™¨å¤„äºé˜»å¡çŠ¶æ€.</p>
</li>
</ol>
</li>
<li><p>è‡ªåŠ¨é—´éš”æ€§ä¿å­˜</p>
<p>å¯ä»¥é€šè¿‡saveé€‰é¡¹è®¾ç½®å¤šä¸ªä¿å­˜æ¡ä»¶,ä½†åªè¦å…¶ä¸­ä»»æ„ä¸€ä¸ªæ¡ä»¶è¢«æ»¡è¶³,æœåŠ¡å™¨å°±ä¼šæ‰§è¡Œbgsave.</p>
<p>save 900 1  æœåŠ¡å™¨900ç§’ä¹‹å†…,å¯¹æ•°æ®åº“è¿›è¡Œè‡³å°‘ä¸€æ¬¡ä¿®æ”¹,å°±è¿›è¡Œbgsave</p>
</li>
</ol>
<h3 id="äº‹ä»¶"><a href="#äº‹ä»¶" class="headerlink" title="äº‹ä»¶"></a>äº‹ä»¶</h3><h4 id="Redis-åŸºäº-Reactoræ¨¡å¼å¼€å‘çš„ç½‘ç»œäº‹ä»¶å¤„ç†å™¨-ç§°ä½œ-æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨-File-Event-Handler"><a href="#Redis-åŸºäº-Reactoræ¨¡å¼å¼€å‘çš„ç½‘ç»œäº‹ä»¶å¤„ç†å™¨-ç§°ä½œ-æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨-File-Event-Handler" class="headerlink" title="Redis åŸºäº Reactoræ¨¡å¼å¼€å‘çš„ç½‘ç»œäº‹ä»¶å¤„ç†å™¨,ç§°ä½œ æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ (File Event Handler)"></a>Redis åŸºäº Reactoræ¨¡å¼å¼€å‘çš„ç½‘ç»œäº‹ä»¶å¤„ç†å™¨,ç§°ä½œ æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ (File Event Handler)</h4><ol>
<li>ä½¿ç”¨I/Oå¤šè·¯å¤ç”¨ç¨‹åºæ¥åŒæ—¶ç›‘å¬å¤šä¸ªå¥—æ¥å­—,å¹¶æ ¹æ®ç›®å‰æ‰§è¡Œçš„ä»»åŠ¡æ¥ä¸ºå¥—æ¥å­—å…³è”ä¸åŒçš„äº‹ä»¶</li>
<li>å½“è¢«ç›‘å¬çš„å¥—æ¥å­—å‡†å¤‡å¥½æ‰§è¡Œè¿æ¥åº”ç­”,è¯»å–,å†™å…¥,å…³é—­ ç­‰æ“ä½œæ—¶,ä¸å…¶å¯¹åº”çš„æ–‡ä»¶äº‹ä»¶å°±ä¼šäº§ç”Ÿ,è¿™æ—¶1ä¸­æ³¨å†Œå¥½çš„äº‹ä»¶å¤„ç†å™¨å°±æ¥è¿›è¡Œå¤„ç†è¿™äº›äº‹ä»¶</li>
</ol>
<h4 id="æ—¶é—´äº‹ä»¶-id-when-handlers"><a href="#æ—¶é—´äº‹ä»¶-id-when-handlers" class="headerlink" title="æ—¶é—´äº‹ä»¶ id/when/handlers"></a>æ—¶é—´äº‹ä»¶ id/when/handlers</h4><ol>
<li>å®šæ—¶äº‹ä»¶</li>
<li>å‘¨æœŸæ€§äº‹ä»¶</li>
</ol>
<h3 id="äº‹åŠ¡å®ç°åŸç†-ACID"><a href="#äº‹åŠ¡å®ç°åŸç†-ACID" class="headerlink" title="äº‹åŠ¡å®ç°åŸç† ACID"></a>äº‹åŠ¡å®ç°åŸç† ACID</h3><h3 id="ServerCronå‡½æ•°"><a href="#ServerCronå‡½æ•°" class="headerlink" title="ServerCronå‡½æ•°"></a>ServerCronå‡½æ•°</h3><blockquote>
<blockquote>
<p>æœåŠ¡å™¨ é»˜è®¤æ¯100æ¯«ç§’æ‰§è¡Œä¸€æ¬¡</p>
</blockquote>
</blockquote>
<ol>
<li>æ›´æ–°æœåŠ¡å™¨æ—¶é—´ç¼“å­˜</li>
<li>æ›´æ–°LRUæ—¶é’Ÿ(å¦‚ Rediså¯¹è±¡éƒ½ä¼šæœ‰ä¸€ä¸ªLRUå±æ€§,è¿™ä¸ªå±æ€§ä¿å­˜äº†å¯¹è±¡æœ€åä¸€æ¬¡è¢«å‘½ä»¤è®¿é—®çš„æ—¶é—´)</li>
<li>æ›´æ–°æœåŠ¡å™¨æ¯ç§’æ‰§è¡Œå‘½ä»¤çš„æ¬¡æ•°(INFO status)</li>
<li>æ›´æ–°æœåŠ¡å™¨å†…å­˜å³°å€¼è®°å½•</li>
<li>å¤„ç†SIGTERMä¿¡å· æ¯æ¬¡è¿è¡Œæ—¶,ç¨‹åºä¼šå¯¹æœåŠ¡å™¨çŠ¶æ€çš„shutdown_asapå±æ€§è¿›è¡Œæ£€æŸ¥,çœ‹æ˜¯å¦è¦å…³é—­æœåŠ¡å™¨</li>
<li>ç®¡ç†å®¢æˆ·ç«¯èµ„æº: å·²è¶…æ—¶ æˆ– æ˜¯å¦æ¸…ç†è¾“å‡ºç¼“å†²åŒº</li>
<li>ç®¡ç†æ•°æ®åº“èµ„æº: åˆ é™¤è¿‡æœŸé”®,å¹¶åœ¨éœ€è¦æ—¶ å¯¹å­—å…¸è¿›è¡Œæ”¶ç¼©æ“ä½œ</li>
<li>æ£€æŸ¥æŒä¹…åŒ–æ“ä½œçš„è¿è¡ŒçŠ¶æ€</li>
<li>å°†AOFç¼“å†²åŒºçš„å†…å®¹å†™å…¥åˆ°AOFæ–‡ä»¶</li>
<li>å…³é—­å¼‚æ­¥å®¢æˆ·ç«¯</li>
<li>å¢åŠ cronloopsè®¡æ•°å™¨çš„å€¼</li>
</ol>
<h3 id="åˆå§‹åŒ–è¿‡ç¨‹"><a href="#åˆå§‹åŒ–è¿‡ç¨‹" class="headerlink" title="åˆå§‹åŒ–è¿‡ç¨‹"></a>åˆå§‹åŒ–è¿‡ç¨‹</h3><p>åˆå§‹åŒ–æœåŠ¡å™¨çŠ¶æ€ç»“æ„,è½½å…¥é…ç½®é€‰é¡¹,è¿˜åŸæ•°æ®åº“çŠ¶æ€,æ‰§è¡Œäº‹ä»¶å¾ªç¯</p>
<h3 id="è®¢é˜…ä¸å‘å¸ƒå®ç°åŸç†"><a href="#è®¢é˜…ä¸å‘å¸ƒå®ç°åŸç†" class="headerlink" title="è®¢é˜…ä¸å‘å¸ƒå®ç°åŸç†"></a>è®¢é˜…ä¸å‘å¸ƒå®ç°åŸç†</h3><h3 id="Lua-è„šæœ¬åŠŸèƒ½çš„å®ç°åŸç†ã€‚"><a href="#Lua-è„šæœ¬åŠŸèƒ½çš„å®ç°åŸç†ã€‚" class="headerlink" title="Lua è„šæœ¬åŠŸèƒ½çš„å®ç°åŸç†ã€‚"></a>Lua è„šæœ¬åŠŸèƒ½çš„å®ç°åŸç†ã€‚</h3><h3 id="SORT-å‘½ä»¤çš„å®ç°åŸç†ã€‚"><a href="#SORT-å‘½ä»¤çš„å®ç°åŸç†ã€‚" class="headerlink" title="SORT å‘½ä»¤çš„å®ç°åŸç†ã€‚"></a>SORT å‘½ä»¤çš„å®ç°åŸç†ã€‚</h3><h3 id="æ…¢æŸ¥è¯¢æ—¥å¿—çš„å®ç°åŸç†ã€‚-æ‰“å¼€æ…¢æŸ¥è¯¢-æŸ¥çœ‹æ—¥æœŸ-SLOWLOG-GET"><a href="#æ…¢æŸ¥è¯¢æ—¥å¿—çš„å®ç°åŸç†ã€‚-æ‰“å¼€æ…¢æŸ¥è¯¢-æŸ¥çœ‹æ—¥æœŸ-SLOWLOG-GET" class="headerlink" title="æ…¢æŸ¥è¯¢æ—¥å¿—çš„å®ç°åŸç†ã€‚ æ‰“å¼€æ…¢æŸ¥è¯¢,æŸ¥çœ‹æ—¥æœŸ SLOWLOG GET"></a>æ…¢æŸ¥è¯¢æ—¥å¿—çš„å®ç°åŸç†ã€‚ æ‰“å¼€æ…¢æŸ¥è¯¢,æŸ¥çœ‹æ—¥æœŸ SLOWLOG GET</h3><h3 id="é«˜å¹¶å‘å¦‚ä½•åšåˆ°"><a href="#é«˜å¹¶å‘å¦‚ä½•åšåˆ°" class="headerlink" title="é«˜å¹¶å‘å¦‚ä½•åšåˆ°"></a>é«˜å¹¶å‘å¦‚ä½•åšåˆ°</h3><pre><code>è™½æ˜¯å•çº¿ç¨‹å•è¿›è¡Œ,ä½† ä½¿ç”¨I/Oå¤šè·¯å¤ç”¨(select/epoll,evport,kqueue)ç¨‹åºæ¥åŒæ—¶ç›‘å¬å¤šä¸ªå¥—æ¥å­— çš„æ–¹å¼æ¥å¤„ç†å‘½ä»¤è¯·æ±‚,å¹¶ä¸å¤šä¸ªå®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡.</code></pre>
<h2 id="äºŒ-redis-ä¸»è¦å…³æ³¨ç‚¹"><a href="#äºŒ-redis-ä¸»è¦å…³æ³¨ç‚¹" class="headerlink" title="äºŒ. redis ä¸»è¦å…³æ³¨ç‚¹"></a>äºŒ. redis ä¸»è¦å…³æ³¨ç‚¹</h2><h3 id="redis-ä¸ºä»€ä¹ˆæ˜¯å•çº¿ç¨‹"><a href="#redis-ä¸ºä»€ä¹ˆæ˜¯å•çº¿ç¨‹" class="headerlink" title="redis ä¸ºä»€ä¹ˆæ˜¯å•çº¿ç¨‹"></a><a target="_blank" rel="noopener" href="https://blog.csdn.net/qqqqq1993qqqqq/article/details/77538202">redis ä¸ºä»€ä¹ˆæ˜¯å•çº¿ç¨‹</a></h3><h3 id="redis-è¿‡æœŸç´¢å¼•æ˜¯å¦‚ä½•åšåˆ°çš„"><a href="#redis-è¿‡æœŸç´¢å¼•æ˜¯å¦‚ä½•åšåˆ°çš„" class="headerlink" title="redis è¿‡æœŸç´¢å¼•æ˜¯å¦‚ä½•åšåˆ°çš„"></a>redis è¿‡æœŸç´¢å¼•æ˜¯å¦‚ä½•åšåˆ°çš„</h3><ol>
<li><p>redis çš„å­˜å‚¨ç»“æ„</p>
</li>
<li><p>åˆ é™¤ç­–ç•¥</p>
 <figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line"><span class="bullet">* </span>å®šæ—¶åˆ é™¤:åœ¨è®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´çš„åŒæ—¶,åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨,è®©å®šæ—¶å™¨åœ¨é”®çš„è¿‡æœŸæ—¶é—´æ¥ä¸´æ—¶,ç«‹å³å¯¹é”®æ‰§è¡Œåˆ é™¤æ“ä½œ(å¯¹å†…å­˜å‹å¥½,æœ€åŠæ—¶)</span><br><span class="line"><span class="bullet">* </span>å®šæœŸåˆ é™¤:æ¯ä¸€æ®µæ—¶é—´,è¿›è¡Œæ•°æ®åº“è¿‡æœŸç´¢å¼•çš„æ‰«ç„,å°†å·²ç»è¿‡æœŸçš„é”® è¿›è¡Œåˆ é™¤; è‡³äºåˆ é™¤å¤šå°‘è¿‡æœŸé”®å’Œæ£€æŸ¥å“ªäº›æ•°æ®åº“,éƒ½ç”±ç®—æ³•å†³å®š</span><br><span class="line"><span class="bullet">* </span>æƒ°æ€§åˆ é™¤: æ¯æ¬¡å–é”®æ—¶,æ ¡éªŒä¸€ä¸‹æ˜¯å¦è¿‡æœŸ,è‹¥å·²ç»è¿‡æœŸ å°±è¿›è¡Œåˆ é™¤</span><br><span class="line"></span><br><span class="line">å…¶å®æœ€ç»ˆä½¿ç”¨çš„æ˜¯ å®šæœŸå’Œæƒ°æ€§ ä¸¤ä¸ªç­–ç•¥ é…åˆå®ç°</span><br></pre></td></tr></table></figure>
<h3 id="redis-æœåŠ¡å™¨é…ç½®"><a href="#redis-æœåŠ¡å™¨é…ç½®" class="headerlink" title="redis æœåŠ¡å™¨é…ç½®"></a><a target="_blank" rel="noopener" href="https://www.cnblogs.com/joshua317/p/5635297.html">redis æœåŠ¡å™¨é…ç½®</a></h3><h3 id="redis-æœ‰å“ªäº›åŠŸèƒ½"><a href="#redis-æœ‰å“ªäº›åŠŸèƒ½" class="headerlink" title="redis æœ‰å“ªäº›åŠŸèƒ½"></a><a href="">redis æœ‰å“ªäº›åŠŸèƒ½</a></h3><h3 id="redis-å¦‚ä½•Failover"><a href="#redis-å¦‚ä½•Failover" class="headerlink" title="redis å¦‚ä½•Failover()"></a>redis å¦‚ä½•Failover()</h3> <figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">å“¨å…µï¼ˆSentinelï¼‰å’Œå¤åˆ¶ï¼ˆ<span class="keyword">Replication</span>ï¼‰</span><br><span class="line">Sentinelå¯ä»¥ç®¡ç†å¤šä¸ªRedisæœåŠ¡å™¨ï¼Œå®ƒæä¾›äº†ç›‘æ§ï¼Œæé†’ä»¥åŠè‡ªåŠ¨çš„æ•…éšœè½¬ç§»çš„åŠŸèƒ½ï¼›<span class="keyword">Replication</span>åˆ™æ˜¯è´Ÿè´£è®©ä¸€ä¸ªRedisæœåŠ¡å™¨å¯ä»¥é…å¤‡å¤šä¸ªå¤‡ä»½çš„æœåŠ¡å™¨</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="redis-ç›®å‰æµç¨‹çš„å®æ–½æ¶æ„æœ‰å“ªäº›"><a href="#redis-ç›®å‰æµç¨‹çš„å®æ–½æ¶æ„æœ‰å“ªäº›" class="headerlink" title="redis ç›®å‰æµç¨‹çš„å®æ–½æ¶æ„æœ‰å“ªäº›"></a>redis ç›®å‰æµç¨‹çš„å®æ–½æ¶æ„æœ‰å“ªäº›</h3><ol>
<li>å“¨å…µSentinel,å¤åˆ¶ï¼ˆreplicationï¼‰</li>
<li>é›†ç¾¤ï¼ˆclusterï¼‰</li>
</ol>
<h2 id="ä¸‰-redis-åº”ç”¨åœºæ™¯"><a href="#ä¸‰-redis-åº”ç”¨åœºæ™¯" class="headerlink" title="ä¸‰. redis åº”ç”¨åœºæ™¯"></a>ä¸‰. <a target="_blank" rel="noopener" href="https://www.cnblogs.com/NiceCui/p/7794659.html">redis åº”ç”¨åœºæ™¯</a></h2><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><a target="_blank" rel="noopener" href="https://item.jd.com/11486101.html">Redisè®¾è®¡ä¸å®ç°</a></li>
</ol>


        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/java/">java</a>
                
                    <a href="/tags/%E7%BC%93%E5%AD%98/">ç¼“å­˜</a>
                
                    <a href="/tags/redis/">redis</a>
                
            </div>
        
    </section>
</article>

    </div>
  
    <div class='post-wrapper'>
      <article class="post reveal">
    <section class="meta">
        
            <h2 class="title">
                <a href="/2015/11/22/redis%E8%87%B4%E5%91%BD%E9%94%99%E8%AF%AF%E7%9A%84%E5%87%BA%E7%8E%B0/">
                    redisè‡´å‘½é”™è¯¯çš„å‡ºç°
                </a>
            </h2>
        
        <time>
            11æœˆ 22, 2015
        </time>
        
    
    <div class='cats'>
        <a href="/categories/%E6%8A%80%E6%9C%AF/">æŠ€æœ¯</a>, <a href="/categories/%E6%8A%80%E6%9C%AF/%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/">é—®é¢˜æ€»ç»“</a>
    </div>

    </section>
    <section class="article typo">
        <p>#é”™è¯¯æè¿°<br>æˆ‘ä»¬å°†æ–‡ä»¶ç¼“å­˜åˆ°redis,ä½†æ˜¯åœ¨çº¿ä¸Šå‡ºç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯Aä¼ä¸šç¾¤ä¸­å‘çš„æ–‡ä»¶ï¼Œåœ¨Bä¼ä¸šç¾¤ä¸­çœ‹æ–‡ä»¶æ—¶å´çœ‹åˆ°äº†Aä¼ä¸šç¾¤ä¸­çš„å›¾ç‰‡ã€‚</p>
<p>#ç»æ’æŸ¥ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<p>##æ¡ˆä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code>    import com.google.common.collect.Lists;
    import org.apache.commons.lang3.StringUtils;
    import org.apache.commons.pool2.impl.GenericObjectPoolConfig;
    import org.slf4j.Logger;
    import org.slf4j.LoggerFactory;
    import redis.clients.jedis.Jedis;
    import redis.clients.jedis.JedisPool;

    import java.util.Arrays;
    import java.util.Collections;
    import java.util.List;
    import java.util.concurrent.*;

    /**
     * Created by Aaron on 15/11/12.
     */
    public class FileRedisFactory &#123;
        private static Logger log = LoggerFactory.getLogger(FileRedisFactory.class);
        public ThreadPoolExecutor threadPoolExecutor;
        // æ ¼å¼ä¸º ï¼š 127.0.0.1:6379#0;127.0.0.2:6379#1    IP:PORT#index
        private String hosts;
        private String password;
        private int size;
        private List&lt;JedisPool&gt; pools=Lists.newArrayList();//è¿æ¥æ± 

        public FileRedisFactory(String hosts, String password) &#123;
            this.hosts = hosts;
            this.password = password;
            this.init(hosts, password);
        &#125;

        public FileRedisFactory(String hosts) &#123;
            this.hosts = hosts;
            this.init(hosts, null);
        &#125;


        private synchronized void init(String hosts, String password) &#123;
            if (StringUtils.isNotEmpty(hosts)) &#123;
                String[] hostsArray = hosts.split(&quot;;&quot;);
                List&lt;String&gt; hostList = Arrays.asList(hostsArray);
                Collections.sort(hostList);
                System.out.println(hostList);
                for (String host : hostList) &#123;
                    try &#123;
                        String[] uriDb=host.split(&quot;#&quot;);
                        String[] host_port = uriDb[0].split(&quot;:&quot;);
                        String ip = host_port[0];
                        String port = host_port[1];
                        int index=uriDb.length&gt;0?Integer.valueOf(uriDb[1]):0;
                        GenericObjectPoolConfig poolConfig = new GenericObjectPoolConfig();

                        poolConfig.setMaxTotal(16);
                        poolConfig.setMaxIdle(16);
                        if (StringUtils.isNotEmpty(password)) &#123;
                            pools.add(new JedisPool(poolConfig, ip, Integer.valueOf(port), 2000, password, index));
                        &#125; else &#123;
                            pools.add(new JedisPool(poolConfig, ip, Integer.valueOf(port), 2000, null, index));
                        &#125;
                    &#125; catch (Exception e) &#123;
                        pools = Lists.newArrayList();
                        e.printStackTrace();
                        log.error(&quot;[ShardedRedisFactory] [initByShard] [error] [hosts:&quot; + hosts + &quot;] [password:&quot; + password + &quot;]&quot;, e);
                    &#125;
                &#125;
                size = pools.size();
            &#125;
            this.threadPoolExecutor = new ThreadPoolExecutor(10,20,3, TimeUnit.MINUTES,new LinkedBlockingDeque&lt;&gt;(),new ThreadPoolExecutor.DiscardPolicy());

            // æ„é€ æ± 
            log.info(&quot;[ShardedRedisFactory] [initByShard] [success] [hosts:&#123;&#125;] [password:&#123;&#125;] [masterName:&#123;&#125;] [pool:&#123;&#125;]&quot;, hosts, password);
        &#125;

        private JedisPool getJedisPool(int c) &#123;
            int index = c % size;
            return pools.get(index);
        &#125;

        private static int getIndexFromPath(String path) &#123;
            String first=path.split(&quot;\\.&quot;)[0];
            return  first.charAt(first.length() - 1);
        &#125;

        /**
         * @param filePath file path
         * @return
         */
        public byte[] get(String filePath) &#123;
            if (cacheIsAvailable()) return null;
            JedisPool jedisPool = getJedisPool(getIndexFromPath(filePath));
            Jedis jedis = null;
            try &#123;
                jedis = jedisPool.getResource();
                return jedis.get(filePath.getBytes());
            &#125; catch (Exception e) &#123;
                log.error(e.getMessage());
                return null;
            &#125; finally &#123;
                if (jedis != null)
                    jedisPool.returnResource(jedis);
            &#125;
        &#125;

        public void asynSet(String filePath, byte[] datas)&#123;
            if (cacheIsAvailable()) return;
            threadPoolExecutor.execute(()-&gt;&#123;
                    JedisPool jedisPool = getJedisPool(getIndexFromPath(filePath));
                    Jedis jedis = null;
                    try &#123;
                        jedis = jedisPool.getResource();
                        jedis.set(filePath.getBytes(), datas);
                    &#125; catch (Exception e) &#123;
                        log.error(e.getMessage());
                    &#125; finally &#123;
                        if (jedis != null)
                            jedisPool.returnResource(jedis);
                    &#125;
            &#125;);
        &#125;
        private boolean cacheIsAvailable() &#123;
            if(pools.size()==0)&#123;
                return true;
            &#125;
            return false;
        &#125;

    &#125;</code></pre>
<p>##æµ‹è¯•ä»£ç å¦‚ä¸‹</p>
<pre><code>        public static void main(String[] args) &#123;
            FileRedisFactory fileRedisFactory = new FileRedisFactory(&quot;172.31.xxx.xxx:6379#0;172.31.xx.xxx:6379#1;172.31.xxx.xxx:6379#2;172.31.xxx.xxx:6379#3&quot;);
            System.out.println(fileRedisFactory);
            Map&lt;String,String&gt; map=new HashMap&lt;&gt;();

            for(int i=0;i&lt;20;i++)&#123;
                map.put(&quot;&quot;+i,&quot;&quot;+i);
            &#125;

            for (int j = 0; j &lt;50 ; j++) &#123;
                Thread thread=new Thread()&#123;
                    @Override
                    public void run() &#123;
                        while(true)&#123;
                            Set&lt;String&gt; s=map.keySet();

                            s.forEach(i-&gt;&#123;
                                fileRedisFactory.set(i + &quot;&quot;, (i + &quot;&quot;).getBytes());
                            &#125;);
                        &#125;
                    &#125;
                &#125;;
                thread.start();
            &#125;
            for (int k = 0; k &lt;50 ; k++) &#123;
                Thread thread=new Thread()&#123;
                    @Override
                    public void run() &#123;
                        while(true)&#123;
                            Set&lt;String&gt; s=map.keySet();
                            s.forEach(i-&gt;&#123;
                                byte[] first=fileRedisFactory.get(i+&quot;&quot;);
                                if(first==null)&#123;
                                    System.out.println(i+&quot;&quot;+first);
                                    return;
                                &#125;
                                try&#123;
                                String temp=(new String(first));
                                if(!temp.equals(i+&quot;&quot;))&#123;
                                    System.out.println(i+&quot;======&quot;+temp);
                                    System.exit(-1);
                                &#125;&#125;catch(Exception e)&#123;
                                    e.printStackTrace();
                                &#125;
                            &#125;);
                        &#125;
                    &#125;
                &#125;;
                thread.start();
            &#125;
        &#125;</code></pre>
<p>è‹¥ä½ å’Œè¿æ¥åˆ°redisæœåŠ¡å™¨ä¹‹é—´çš„ç½‘ç»œä¸æ˜¯å¾ˆç¨³å®š<br>åœ¨è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œæœ‰å¥‡æ€ªçš„ç°åƒå‡ºç°ï¼š</p>
<pre><code>    1======2
    3======8</code></pre>
<p>è¿™æ—¶ï¼Œæˆ‘ä»¬å°±åœ¨å¯¹redisæ“ä½œæ—¶ï¼Œå¼‚å¸¸çš„åœ°æ–¹ä¿®æ”¹æˆå¦‚ä¸‹ä»£ç ï¼š</p>
<pre><code>    catch (Exception e) &#123;
          log.error(e.getMessage());
          e.printStackTrace();
          return null;
    &#125; </code></pre>
<p>å°±ä¼šçœ‹åˆ°æŠ¥TimeOutçš„Exception</p>
<pre><code>æˆ‘ä»¬å°†ï¼š
        &lt;dependency&gt;
            &lt;groupId&gt;redis.clients&lt;/groupId&gt;
            &lt;artifactId&gt;jedis&lt;/artifactId&gt;
            &lt;version&gt;2.6.2&lt;/version&gt;
        &lt;/dependency&gt;

æ›¿æ¢æˆï¼š
        &lt;dependency&gt;
            &lt;groupId&gt;redis.clients&lt;/groupId&gt;
            &lt;artifactId&gt;jedis&lt;/artifactId&gt;
            &lt;version&gt;2.7.3&lt;/version&gt;
        &lt;/dependency&gt;</code></pre>
<p>è¿™æ—¶æˆ‘ä»¬å»Googleä¸ŠæŸ¥è¯¢çš„åŒæ—¶ä¹Ÿçœ‹äº†ä¸€ä¸‹æ–°çš„ä»£ç ï¼Œ<br>     æˆ‘ä»¬åŸæ¥ç”¨çš„ï¼š</p>
<pre><code>    jedisPool.returnResource(jedis);

 å·²ç»å˜æˆäº†ï¼š


   /**
    * @deprecated starting from Jedis 3.0 this method won&#39;t exist. Resouce cleanup should be done
    *             using @see &#123;@link redis.clients.jedis.Jedis#close()&#125;
    */
   @Deprecated
   public void returnResource(final Jedis resource) &#123;
     if (resource != null) &#123;
       try &#123;
         resource.resetState();
         returnResourceObject(resource);
       &#125; catch (Exception e) &#123;
         returnBrokenResource(resource);
         throw new JedisException(&quot;Could not return the resource to the pool&quot;, e);
       &#125;
     &#125;
   &#125;</code></pre>
<p>åŒæ—¶æˆ‘ä»¬ä¹ŸæŸ¥åˆ°äº†ä¸€ä¸ªæ–‡ç« <a target="_blank" rel="noopener" href="http://www.cnblogs.com/wcd144140/p/4883139.html">JedisPoolå¼‚å¸¸Jedisé“¾æ¥å¤„ç†</a></p>
<p>#ä¿®æ”¹åçš„ä»£ç ï¼š</p>
<pre><code>import com.google.common.collect.Lists;
import org.apache.commons.lang3.StringUtils;
import org.apache.commons.pool2.impl.GenericObjectPoolConfig;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import redis.clients.jedis.Jedis;
import redis.clients.jedis.JedisPool;

import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.concurrent.*;

/**
 * Created by Aaron on 15/11/12.
 */
public class FileRedisFactory &#123;
    private static Logger log = LoggerFactory.getLogger(FileRedisFactory.class);
    public ThreadPoolExecutor threadPoolExecutor;
    // æ ¼å¼ä¸º ï¼š 127.0.0.1:6379#0;127.0.0.2:6379#1    IP:PORT#index
    private String hosts;
    private String password;
    private int size;
    private List&lt;JedisPool&gt; pools=Lists.newArrayList();//è¿æ¥æ± 

    public FileRedisFactory(String hosts, String password) &#123;
        this.hosts = hosts;
        this.password = password;
        this.init(hosts, password);
    &#125;

    public FileRedisFactory(String hosts) &#123;
        this.hosts = hosts;
        this.init(hosts, null);
    &#125;


    private synchronized void init(String hosts, String password) &#123;
        if (StringUtils.isNotEmpty(hosts)) &#123;
            String[] hostsArray = hosts.split(&quot;;&quot;);
            List&lt;String&gt; hostList = Arrays.asList(hostsArray);
            Collections.sort(hostList);
            System.out.println(hostList);
            for (String host : hostList) &#123;
                try &#123;
                    String[] uriDb=host.split(&quot;#&quot;);
                    String[] host_port = uriDb[0].split(&quot;:&quot;);
                    String ip = host_port[0];
                    String port = host_port[1];
                    int index=uriDb.length&gt;0?Integer.valueOf(uriDb[1]):0;
                    GenericObjectPoolConfig poolConfig = new GenericObjectPoolConfig();

                    poolConfig.setMaxTotal(16);
                    poolConfig.setMaxIdle(16);
                    if (StringUtils.isNotEmpty(password)) &#123;
                        pools.add(new JedisPool(poolConfig, ip, Integer.valueOf(port), 2000, password, index));
                    &#125; else &#123;
                        pools.add(new JedisPool(poolConfig, ip, Integer.valueOf(port), 2000, null, index));
                    &#125;
                &#125; catch (Exception e) &#123;
                    pools = Lists.newArrayList();
                    log.error(&quot;[ShardedRedisFactory] [initByShard] [error] [hosts:&quot; + hosts + &quot;] [password:&quot; + password + &quot;]&quot;, e);
                &#125;
            &#125;
            size = pools.size();
        &#125;

        this.threadPoolExecutor = new ThreadPoolExecutor(10,20,3, TimeUnit.MINUTES,new LinkedBlockingDeque&lt;&gt;(50),new ThreadPoolExecutor.DiscardPolicy());

        // æ„é€ æ± 
        log.info(&quot;[ShardedRedisFactory] [initByShard] [success] [hosts:&#123;&#125;] [password:&#123;&#125;] [masterName:&#123;&#125;] [pool:&#123;&#125;]&quot;, hosts, password);
    &#125;

    private JedisPool getJedisPool(int c) &#123;
        int index = c % size;
        return pools.get(index);
    &#125;

    private static int getIndexFromPath(String path) &#123;
        String first=path.split(&quot;\\.&quot;)[0];
        return  first.charAt(first.length() - 1);
    &#125;

    /**
     * @param filePath file path
     * @return
     */
    public byte[] get(String filePath) &#123;
        if (cacheIsAvailable()) return null;
        JedisPool jedisPool = getJedisPool(getIndexFromPath(filePath));
        Jedis jedis = null;
        try &#123;
            jedis = jedisPool.getResource();
            return jedis.get(filePath.getBytes());
        &#125; catch (Exception e) &#123;
            log.error(e.getMessage());
            return null;
        &#125; finally &#123;
            if (jedis != null)
                jedis.close();
        &#125;
    &#125;

    public String set(String filePath, byte[] datas) &#123;
        if (cacheIsAvailable()) return null;
        JedisPool jedisPool = getJedisPool(getIndexFromPath(filePath));
        Jedis jedis = null;
        try &#123;
            jedis = jedisPool.getResource();
            return jedis.set(filePath.getBytes(), datas);
        &#125; catch (Exception e) &#123;
            log.error(e.getMessage());
            return null;
        &#125; finally &#123;
            if (jedis != null)
                jedis.close();
        &#125;
    &#125;

    public void asynSet(String filePath, byte[] datas,long expx)&#123;
        if (cacheIsAvailable()) return;
        threadPoolExecutor.execute(()-&gt;&#123;
                JedisPool jedisPool = getJedisPool(getIndexFromPath(filePath));
                Jedis jedis = null;
                try &#123;
                    jedis = jedisPool.getResource();
                    jedis.set(filePath.getBytes(), datas,&quot;NX&quot;.getBytes(),&quot;EX&quot;.getBytes(),expx);
                &#125; catch (Exception e) &#123;
                    log.error(e.getMessage());
                &#125; finally &#123;
                    if (jedis != null)
                        jedis.close();
                &#125;
        &#125;);
    &#125;
    private boolean cacheIsAvailable() &#123;
        if(pools.size()==0)&#123;
            return true;
        &#125;
        return false;
    &#125;

&#125;</code></pre>
<p>#æ€»ç»“ï¼š</p>
<ol>
<li>åœ¨ä½¿ç”¨åšæ–°åŠŸèƒ½æ—¶ï¼Œæ–¹ä¾¿æ—¶è¦æ·»åŠ å¼€å…³æˆ–åˆç†çš„å›æ»šæ–¹æ¡ˆï¼Œæ–¹ä¾¿å¿«é€Ÿçš„å›æ»šå‡å°‘äº‹æ•…çš„å½±å“</li>
<li>æ’æŸ¥é”™è¯¯ï¼Œä¸€æŸ¥åˆ°åº•</li>
</ol>


        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/bug/">bug</a>
                
                    <a href="/tags/%E7%BC%93%E5%AD%98/">ç¼“å­˜</a>
                
                    <a href="/tags/redis/">redis</a>
                
            </div>
        
    </section>
</article>

    </div>
  
</section>


      </div>
      <aside class='l_side'>
        
  <section class='m_widget about'>

<img class='avatar waves-image' src='/images/head/photo2.jpeg' />

<div class='header'>ä¸‡æ¾</div>
<div class='content'>
<div class='desc'>ç”Ÿæ´»ç‚¹æ»´å’ŒçŸ¥è¯†åˆ†äº«</div>
</div>
</section>


  <section class='m_widget links'>
<div class='header'>å‹æƒ…é“¾æ¥</div>
<div class='content'>
    <ul class="entry">
    
        <li><a class="flat-box" target="_blank" href="https://www.fxiaoke.com/">
            <div class='name'>fxiaoke</div>
        </a></li>
    
    </ul>
</div>
</section>


  <section class='m_widget categories'>
<div class='header'>æ‰€æœ‰åˆ†ç±»</div>
<div class='content'>
    
    <ul class="entry">
    
        <li><a class="flat-box" href="/categories/BPMN/"><div class='name'>BPMN</div><div class='badget'>6</div></a></li>
    
        <li><a class="flat-box" href="/categories/BPMN/Flow/"><div class='name'>Flow</div><div class='badget'>1</div></a></li>
    
        <li><a class="flat-box" href="/categories/%E6%89%A9%E5%B1%95%E7%9F%A5%E8%AF%86/linux/"><div class='name'>linux</div><div class='badget'>2</div></a></li>
    
        <li><a class="flat-box" href="/categories/%E6%97%A5%E5%B8%B8%E5%B7%A5%E5%85%B7/mac/"><div class='name'>mac</div><div class='badget'>1</div></a></li>
    
        <li><a class="flat-box" href="/categories/%E4%B9%A6%E6%9E%B6/"><div class='name'>ä¹¦æ¶</div><div class='badget'>1</div></a></li>
    
        <li><a class="flat-box" href="/categories/BPMN/%E5%85%83%E7%B4%A0/"><div class='name'>å…ƒç´ </div><div class='badget'>5</div></a></li>
    
        <li><a class="flat-box" href="/categories/%E6%89%A9%E5%B1%95%E7%9F%A5%E8%AF%86/"><div class='name'>æ‰©å±•çŸ¥è¯†</div><div class='badget'>7</div></a></li>
    
        <li><a class="flat-box" href="/categories/%E6%8A%80%E6%9C%AF/"><div class='name'>æŠ€æœ¯</div><div class='badget'>28</div></a></li>
    
        <li><a class="flat-box" href="/categories/%E6%96%B9%E6%A1%88/"><div class='name'>æ–¹æ¡ˆ</div><div class='badget'>4</div></a></li>
    
        <li><a class="flat-box" href="/categories/%E6%97%A5%E5%B8%B8%E5%B7%A5%E5%85%B7/"><div class='name'>æ—¥å¸¸å·¥å…·</div><div class='badget'>3</div></a></li>
    
        <li><a class="flat-box" href="/categories/%E7%94%9F%E6%B4%BB/"><div class='name'>ç”Ÿæ´»</div><div class='badget'>5</div></a></li>
    
        <li><a class="flat-box" href="/categories/%E6%8A%80%E6%9C%AF/%E7%AE%97%E6%B3%95/"><div class='name'>ç®—æ³•</div><div class='badget'>1</div></a></li>
    
        <li><a class="flat-box" href="/categories/%E8%89%BA%E6%9C%AF/"><div class='name'>è‰ºæœ¯</div><div class='badget'>1</div></a></li>
    
        <li><a class="flat-box" href="/categories/%E6%8A%80%E6%9C%AF/%E8%AF%AD%E8%A8%80/"><div class='name'>è¯­è¨€</div><div class='badget'>1</div></a></li>
    
        <li><a class="flat-box" href="/categories/%E6%89%A9%E5%B1%95%E7%9F%A5%E8%AF%86/%E8%AF%BB%E4%B9%A6%E5%AD%A6%E4%B9%A0/"><div class='name'>è¯»ä¹¦å­¦ä¹ </div><div class='badget'>5</div></a></li>
    
        <li><a class="flat-box" href="/categories/%E8%AF%BB%E4%B9%A6%E5%AD%A6%E4%B9%A0/"><div class='name'>è¯»ä¹¦å­¦ä¹ </div><div class='badget'>1</div></a></li>
    
        <li><a class="flat-box" href="/categories/%E6%8A%80%E6%9C%AF/%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/"><div class='name'>é—®é¢˜æ€»ç»“</div><div class='badget'>1</div></a></li>
    
    </ul>
    
</div>
</section>


  
<div class="m_widget tagcloud">
    <div class="header">æ ‡ç­¾äº‘</div>
    <div class='content'>
        <a href="/tags/BPMN/" style="font-size: 19px; color: #151515">BPMN</a> <a href="/tags/CAP/" style="font-size: 15px; color: #6b6b6b">CAP</a> <a href="/tags/Flow/" style="font-size: 19px; color: #151515">Flow</a> <a href="/tags/GIS/" style="font-size: 14px; color: #808080">GIS</a> <a href="/tags/Protobuf/" style="font-size: 14px; color: #808080">Protobuf</a> <a href="/tags/alfred/" style="font-size: 14px; color: #808080">alfred</a> <a href="/tags/angularjs/" style="font-size: 17px; color: #404040">angularjs</a> <a href="/tags/ansible/" style="font-size: 14px; color: #808080">ansible</a> <a href="/tags/arm/" style="font-size: 14px; color: #808080">arm</a> <a href="/tags/book/" style="font-size: 15px; color: #6b6b6b">book</a> <a href="/tags/bug/" style="font-size: 14px; color: #808080">bug</a> <a href="/tags/django/" style="font-size: 14px; color: #808080">django</a> <a href="/tags/dubbo/" style="font-size: 14px; color: #808080">dubbo</a> <a href="/tags/fastcgi/" style="font-size: 14px; color: #808080">fastcgi</a> <a href="/tags/fastfs/" style="font-size: 14px; color: #808080">fastfs</a> <a href="/tags/git/" style="font-size: 14px; color: #808080">git</a> <a href="/tags/ionic/" style="font-size: 17px; color: #404040">ionic</a> <a href="/tags/java/" style="font-size: 20px; color: #000">java</a> <a href="/tags/jdk/" style="font-size: 14px; color: #808080">jdk</a> <a href="/tags/jdk8-java/" style="font-size: 15px; color: #6b6b6b">jdk8.java</a> <a href="/tags/jmeter/" style="font-size: 14px; color: #808080">jmeter</a> <a href="/tags/linux/" style="font-size: 14px; color: #808080">linux</a> <a href="/tags/linux%E5%91%BD%E4%BB%A4/" style="font-size: 14px; color: #808080">linuxå‘½ä»¤</a> <a href="/tags/mac/" style="font-size: 15px; color: #6b6b6b">mac</a> <a href="/tags/maven/" style="font-size: 14px; color: #808080">maven</a> <a href="/tags/mp3/" style="font-size: 14px; color: #808080">mp3</a> <a href="/tags/mysql/" style="font-size: 14px; color: #808080">mysql</a> <a href="/tags/nginx/" style="font-size: 14px; color: #808080">nginx</a> <a href="/tags/nocomment/" style="font-size: 14px; color: #808080">nocomment</a> <a href="/tags/poi/" style="font-size: 14px; color: #808080">poi</a> <a href="/tags/python/" style="font-size: 17px; color: #404040">python</a> <a href="/tags/redis/" style="font-size: 15px; color: #6b6b6b">redis</a> <a href="/tags/rpc/" style="font-size: 14px; color: #808080">rpc</a> <a href="/tags/rsa/" style="font-size: 14px; color: #808080">rsa</a> <a href="/tags/schedule/" style="font-size: 14px; color: #808080">schedule</a> <a href="/tags/workflow/" style="font-size: 14px; color: #808080">workflow</a> <a href="/tags/zookeeper/" style="font-size: 14px; color: #808080">zookeeper</a> <a href="/tags/%E4%B8%80%E8%87%B4%E6%80%A7%E7%AE%97%E6%B3%95/" style="font-size: 14px; color: #808080">ä¸€è‡´æ€§ç®—æ³•</a> <a href="/tags/%E4%BA%BA%E7%94%9F/" style="font-size: 16px; color: #555">äººç”Ÿ</a> <a href="/tags/%E4%BA%BA%E7%94%9F%E6%84%9F%E6%82%9F/" style="font-size: 14px; color: #808080">äººç”Ÿæ„Ÿæ‚Ÿ</a> <a href="/tags/%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/" style="font-size: 14px; color: #808080">äººè„¸è¯†åˆ«</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E4%BB%93%E5%BA%93/" style="font-size: 14px; color: #808080">ä»£ç ä»“åº“</a> <a href="/tags/%E5%81%A5%E5%BA%B7/" style="font-size: 14px; color: #808080">å¥åº·</a> <a href="/tags/%E5%85%83%E7%B4%A0/" style="font-size: 18px; color: #2b2b2b">å…ƒç´ </a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 18px; color: #2b2b2b">åˆ†å¸ƒå¼</a> <a href="/tags/%E5%8A%A0%E5%AF%86%E8%A7%A3%E5%AF%86/" style="font-size: 14px; color: #808080">åŠ å¯†è§£å¯†</a> <a href="/tags/%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/" style="font-size: 14px; color: #808080">å‹åŠ›æµ‹è¯•</a> <a href="/tags/%E5%9B%BE%E7%89%87%E5%A4%84%E7%90%86/" style="font-size: 15px; color: #6b6b6b">å›¾ç‰‡å¤„ç†</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 17px; color: #404040">å¤šçº¿ç¨‹</a> <a href="/tags/%E5%AD%98%E5%82%A8/" style="font-size: 14px; color: #808080">å­˜å‚¨</a> <a href="/tags/%E5%AE%9A%E6%97%B6/" style="font-size: 14px; color: #808080">å®šæ—¶</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 14px; color: #808080">å·¥å…·</a> <a href="/tags/%E5%B9%B6%E5%8F%91/" style="font-size: 14px; color: #808080">å¹¶å‘</a> <a href="/tags/%E5%BE%90%E6%82%B2%E9%B8%BF/" style="font-size: 14px; color: #808080">å¾æ‚²é¸¿</a> <a href="/tags/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/" style="font-size: 14px; color: #808080">æ€§èƒ½æµ‹è¯•</a> <a href="/tags/%E6%84%9F%E6%82%9F/" style="font-size: 15px; color: #6b6b6b">æ„Ÿæ‚Ÿ</a> <a href="/tags/%E6%8E%92%E5%BA%8F/" style="font-size: 14px; color: #808080">æ’åº</a> <a href="/tags/%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86/" style="font-size: 15px; color: #6b6b6b">æœåŠ¡æ²»ç†</a> <a href="/tags/%E6%9F%A5%E6%89%BE/" style="font-size: 14px; color: #808080">æŸ¥æ‰¾</a> <a href="/tags/%E6%B5%81%E7%A8%8B/" style="font-size: 19px; color: #151515">æµç¨‹</a> <a href="/tags/%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8E/" style="font-size: 19px; color: #151515">æµç¨‹å¼•æ“</a> <a href="/tags/%E6%B5%8B%E8%AF%95/" style="font-size: 14px; color: #808080">æµ‹è¯•</a> <a href="/tags/%E7%88%AC%E5%B1%B1/" style="font-size: 14px; color: #808080">çˆ¬å±±</a> <a href="/tags/%E7%96%91%E6%83%91/" style="font-size: 15px; color: #6b6b6b">ç–‘æƒ‘</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 19px; color: #151515">ç®—æ³•</a> <a href="/tags/%E7%BB%8F%E9%AA%8C/" style="font-size: 14px; color: #808080">ç»éªŒ</a> <a href="/tags/%E7%BB%98%E7%94%BB/" style="font-size: 14px; color: #808080">ç»˜ç”»</a> <a href="/tags/%E7%BC%93%E5%AD%98/" style="font-size: 15px; color: #6b6b6b">ç¼“å­˜</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 17px; color: #404040">è®¾è®¡æ¨¡å¼</a> <a href="/tags/%E8%BD%AF%E4%BB%B6/" style="font-size: 14px; color: #808080">è½¯ä»¶</a> <a href="/tags/%E8%BF%90%E5%8A%A8/" style="font-size: 14px; color: #808080">è¿åŠ¨</a> <a href="/tags/%E8%BF%90%E7%BB%B4/" style="font-size: 15px; color: #6b6b6b">è¿ç»´</a> <a href="/tags/%E9%9F%B3%E4%B9%90/" style="font-size: 14px; color: #808080">éŸ³ä¹</a> <a href="/tags/%E9%9F%B3%E9%A2%91%E8%BD%AC%E6%8D%A2/" style="font-size: 14px; color: #808080">éŸ³é¢‘è½¬æ¢</a>
    </div>
</div>



      </aside>
      <script>setLoadingBarProgress(60);</script>
    </div>
  </div>
  <footer id="footer" class="clearfix">

	<div class="social-wrapper">
  	
      
        <a href="https://github.com/AaronWan" class="social github"
          target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
        <a href="/atom.xml" class="social rss"
          target="_blank" rel="external">
          <span class="icon icon-rss"></span>
        </a>
      
    
  </div>
  
    
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <span id="busuanzi_container_site_pv">æœ¬ç«™æµè§ˆæ€»è®¿é—®é‡: <span id="busuanzi_value_site_pv"></span></span>
        <span class="post-meta-divider">|</span>
        <span id="busuanzi_container_site_uv">æœ¬ç«™è®¿é—®äººæ•°: <span id="busuanzi_value_site_uv"></span></span>
    
</footer>

  <script>setLoadingBarProgress(80);</script>
  

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src='//cdn.bootcss.com/node-waves/0.7.5/waves.min.js'></script>
<script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script>

<script src="/js/jquery.fitvids.js"></script>

<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "hexo";
  var ROOT = "/"||"/";
  if(!ROOT.endsWith('/'))ROOT += '/';
</script>

<script src="/js/search.js"></script>


<script src="/js/app.js"></script>



  <script>setLoadingBarProgress(100);</script>
</body>
</html>
