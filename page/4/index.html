<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>Share</title>
  <meta name="description" content="生活点滴和知识分享" />
  <meta name="keywords" content="" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="/">
  <link rel="alternate" href="/atom.xml" title="Share" type="application/atom+xml">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="生活点滴和知识分享">
<meta property="og:type" content="website">
<meta property="og:title" content="Share">
<meta property="og:url" content="http://example.com/page/4/index.html">
<meta property="og:site_name" content="Share">
<meta property="og:description" content="生活点滴和知识分享">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="万松">
<meta name="twitter:card" content="summary">
    
  <link href="https://fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <link href='//cdn.bootcss.com/node-waves/0.7.5/waves.min.css' rel='stylesheet'>
  
<link rel="stylesheet" href="/style.css">

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>


  <script>setLoadingBarProgress(20)</script> 
  <header class="l_header">
	<div class='wrapper'>
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href='/' >
				Share
			</a>

			<div class='menu'>
				<ul class='h-list'>
					
						<li>
							<a class='flat-box nav-home' href='/'>
								主页
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-archives' href='/archives'>
								分类查看
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-about' href='/about'>
								关于我
							</a>
						</li>
					
				</ul>
				<div class='underline'></div>
			</div>
			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search" />
						<span class="icon icon-search"></span>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a href='javascript:void(0)'><span class="icon icon-search flat-box"></span></a></li>
				
				<li class='s-menu'><a href='javascript:void(0)'><span class="icon icon-menu flat-box"></span></a></li>
			</ul>
		</div>
		
		<div class='nav-sub container container--flex'>
			<a class="logo" class="flat-box" href='javascript:void(0)'>
				Word of Forks
			</a>

			<ul class='switcher h-list'>
				<li class='s-comment'><a href='javascript:void(0)'><span class="icon icon-chat_bubble_outline flat-box"></span></a></li>
				<li class='s-top'><a href='javascript:void(0)'><span class="icon icon-arrow_upward flat-box"></span></a></li>
				<li class='s-toc'><a href='javascript:void(0)'><span class="icon icon-format_list_numbered flat-box"></span></a></li>
			</ul>
		</div>
	</div>
</header>
<aside class="menu-phone">
	<nav>
		
			<a href="/" class="nav-home nav">
				主页
			</a>
		
			<a href="/archives" class="nav-archives nav">
				分类查看
			</a>
		
			<a href="/about" class="nav-about nav">
				关于我
			</a>
		
	</nav>
</aside>

    <script>setLoadingBarProgress(40);</script>
  <div class="l_body">
    <div class='container clearfix'>
      <div class='l_main'>
        
<section class="post-list">
	
    <div class='post-wrapper'>
      <article class="post reveal">
    <section class="meta">
        
            <h2 class="title">
                <a href="/2015/09/13/%E5%B7%A5%E4%BD%9C%E4%B8%AD%E4%BD%BF%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7%E6%95%B4%E7%90%86/">
                    工作中使用的工具整理
                </a>
            </h2>
        
        <time>
            9月 13, 2015
        </time>
        
    
    <div class='cats'>
        <a href="/categories/%E6%97%A5%E5%B8%B8%E5%B7%A5%E5%85%B7/">日常工具</a>, <a href="/categories/%E6%97%A5%E5%B8%B8%E5%B7%A5%E5%85%B7/mac/">mac</a>
    </div>

    </section>
    <section class="article typo">
        <blockquote>
<p>2015目前我日常工作中常用的工具，在这里进行一次整理备份</p>
</blockquote>
<ul>
<li>IntelliJ IDEA</li>
<li>Web Storm</li>
<li>PyCharm</li>
<li>MindPreview Lite</li>
<li>SQLPro <a target="_blank" rel="noopener" href="http://www.macsqlclient.com/">http://www.macsqlclient.com/</a></li>
<li>rdm</li>
<li>redis</li>
<li>mongodb</li>
<li>zkcli</li>
<li>alfred</li>
<li>hexo </li>
</ul>
<p>zsh + iterm + powerline</p>


        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/mac/">mac</a>
                
                    <a href="/tags/%E8%BD%AF%E4%BB%B6/">软件</a>
                
            </div>
        
    </section>
</article>

    </div>
  
    <div class='post-wrapper'>
      <article class="post reveal">
    <section class="meta">
        
            <h2 class="title">
                <a href="/2015/09/13/MVN%E6%97%A5%E5%B8%B8%E4%BD%BF%E7%94%A8/">
                    MVN日常使用
                </a>
            </h2>
        
        <time>
            9月 13, 2015
        </time>
        
    
    <div class='cats'>
        <a href="/categories/%E6%97%A5%E5%B8%B8%E5%B7%A5%E5%85%B7/">日常工具</a>
    </div>

    </section>
    <section class="article typo">
        <blockquote>
<p>工作中日常使用</p>
</blockquote>
<p>#command</p>
<p>跳过测试进行</p>
<pre><code>mvn  -Dmaven.test.skip=true package</code></pre>
<h1 id="指定打包的环境"><a href="#指定打包的环境" class="headerlink" title="指定打包的环境"></a>指定打包的环境</h1><pre><code>mvn -DskipTests clean package -P FTE2</code></pre>
<blockquote>
<p>mvn -U clean package -Dmaven.test.skip=true -pl biz/pom.xml -am<br>    <a target="_blank" rel="noopener" href="http://www.mzone.cc/article/277.html">maven中snapshot快照库和release发布库的区别和作用</a></p>
</blockquote>
<blockquote>
<p>mvn -am -DskipTests -U -pl biz-web clean package       </p>
</blockquote>


        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/java/">java</a>
                
                    <a href="/tags/maven/">maven</a>
                
            </div>
        
    </section>
</article>

    </div>
  
    <div class='post-wrapper'>
      <article class="post reveal">
    <section class="meta">
        
            <h2 class="title">
                <a href="/2015/09/12/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BExecutorService/">
                    Java thread 多线程 ExecutorService
                </a>
            </h2>
        
        <time>
            9月 12, 2015
        </time>
        
    
    <div class='cats'>
        <a href="/categories/%E6%8A%80%E6%9C%AF/">技术</a>
    </div>

    </section>
    <section class="article typo">
        

        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/java/">java</a>
                
                    <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">多线程</a>
                
            </div>
        
    </section>
</article>

    </div>
  
    <div class='post-wrapper'>
      <article class="post reveal">
    <section class="meta">
        
            <h2 class="title">
                <a href="/2015/09/12/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BExecutors/">
                    多线程 Executors
                </a>
            </h2>
        
        <time>
            9月 12, 2015
        </time>
        
    
    <div class='cats'>
        <a href="/categories/%E6%8A%80%E6%9C%AF/">技术</a>
    </div>

    </section>
    <section class="article typo">
        

        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/java/">java</a>
                
                    <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">多线程</a>
                
            </div>
        
    </section>
</article>

    </div>
  
    <div class='post-wrapper'>
      <article class="post reveal">
    <section class="meta">
        
            <h2 class="title">
                <a href="/2015/09/12/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BThreadPoolExecutor/">
                    ThreadPoolExecutor 源码分析
                </a>
            </h2>
        
        <time>
            9月 12, 2015
        </time>
        
    
    <div class='cats'>
        <a href="/categories/%E6%8A%80%E6%9C%AF/">技术</a>
    </div>

    </section>
    <section class="article typo">
        <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ORACLE PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Written by Doug Lea with assistance from members of JCP JSR-166</span></span><br><span class="line"><span class="comment"> * Expert Group and released to the public domain, as explained at</span></span><br><span class="line"><span class="comment"> * http://creativecommons.org/publicdomain/zero/1.0/</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> java.util.concurrent;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.AbstractQueuedSynchronizer;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Condition;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *一个ExecutorService执行每个被提交入到线程池中的任务，通过Executors工厂方法进行配置。</span></span><br><span class="line"><span class="comment"> *线程池处理两种不同的问题：通过减少每个任务调用的开销、提供边界和资源管理，包括线程，</span></span><br><span class="line"><span class="comment"> *任务集合的执行，从而改进了执行大量异步任务时的性能问题。ThreadPoolExcecutor也维护着一</span></span><br><span class="line"><span class="comment"> *些统计数据，如已完成任务的数目。</span></span><br><span class="line"><span class="comment"> *面对一个提供了许多可调用参数和可扩展性的hooks.程序员通常比较喜欢用Executors的工厂方法。</span></span><br><span class="line"><span class="comment"> *如Executors.newCachedThreadPool(无限大小的线程池，自动线程回收)、Executors.newFixedThreadPool</span></span><br><span class="line"><span class="comment"> *(固定大小的线程池)、Executors.newSingleThreadExecutor(单个后台线程)，为最常用的场</span></span><br><span class="line"><span class="comment"> *景进行预配置。或者，使用这个类进行手动配置实现同样的效果的线程池，</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 核心和最大的线程池</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ThreadPoolExecutor会根据线程池的大小配置corePoolSize和maximumPoolSize来自动调整池的大小，</span></span><br><span class="line"><span class="comment"> *可以通过getPoolSize查看池的大小。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * When a new task is submitted in method &#123;<span class="doctag">@link</span> #execute(Runnable)&#125;,</span></span><br><span class="line"><span class="comment"> * and fewer than corePoolSize threads are running, a new thread is</span></span><br><span class="line"><span class="comment"> * created to handle the request, even if other worker threads are</span></span><br><span class="line"><span class="comment"> * idle.  If there are more than corePoolSize but less than</span></span><br><span class="line"><span class="comment"> * maximumPoolSize threads running, a new thread will be created only</span></span><br><span class="line"><span class="comment"> * if the queue is full.  By setting corePoolSize and maximumPoolSize</span></span><br><span class="line"><span class="comment"> * the same, you create a fixed-size thread pool. By setting</span></span><br><span class="line"><span class="comment"> * maximumPoolSize to an essentially unbounded value such as &#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment"> * Integer.MAX_VALUE&#125;, you allow the pool to accommodate an arbitrary</span></span><br><span class="line"><span class="comment"> * number of concurrent tasks. Most typically, core and maximum pool</span></span><br><span class="line"><span class="comment"> * sizes are set only upon construction, but they may also be changed</span></span><br><span class="line"><span class="comment"> * dynamically using &#123;<span class="doctag">@link</span> #setCorePoolSize&#125; and &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment"> * #setMaximumPoolSize&#125;. &lt;/dd&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;dt&gt;On-demand construction&lt;/dt&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;dd&gt;By default, even core threads are initially created and</span></span><br><span class="line"><span class="comment"> * started only when new tasks arrive, but this can be overridden</span></span><br><span class="line"><span class="comment"> * dynamically using method &#123;<span class="doctag">@link</span> #prestartCoreThread&#125; or &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment"> * #prestartAllCoreThreads&#125;.  You probably want to prestart threads if</span></span><br><span class="line"><span class="comment"> * you construct the pool with a non-empty queue. &lt;/dd&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;dt&gt;Creating new threads&lt;/dt&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;dd&gt;New threads are created using a &#123;<span class="doctag">@link</span> ThreadFactory&#125;.  If not</span></span><br><span class="line"><span class="comment"> * otherwise specified, a &#123;<span class="doctag">@link</span> Executors#defaultThreadFactory&#125; is</span></span><br><span class="line"><span class="comment"> * used, that creates threads to all be in the same &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment"> * ThreadGroup&#125; and with the same &#123;<span class="doctag">@code</span> NORM_PRIORITY&#125; priority and</span></span><br><span class="line"><span class="comment"> * non-daemon status. By supplying a different ThreadFactory, you can</span></span><br><span class="line"><span class="comment"> * alter the thread&#x27;s name, thread group, priority, daemon status,</span></span><br><span class="line"><span class="comment"> * etc. If a &#123;<span class="doctag">@code</span> ThreadFactory&#125; fails to create a thread when asked</span></span><br><span class="line"><span class="comment"> * by returning null from &#123;<span class="doctag">@code</span> newThread&#125;, the executor will</span></span><br><span class="line"><span class="comment"> * continue, but might not be able to execute any tasks. Threads</span></span><br><span class="line"><span class="comment"> * should possess the &quot;modifyThread&quot; &#123;<span class="doctag">@code</span> RuntimePermission&#125;. If</span></span><br><span class="line"><span class="comment"> * worker threads or other threads using the pool do not possess this</span></span><br><span class="line"><span class="comment"> * permission, service may be degraded: configuration changes may not</span></span><br><span class="line"><span class="comment"> * take effect in a timely manner, and a shutdown pool may remain in a</span></span><br><span class="line"><span class="comment"> * state in which termination is possible but not completed.&lt;/dd&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;dt&gt;Keep-alive times&lt;/dt&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;dd&gt;If the pool currently has more than corePoolSize threads,</span></span><br><span class="line"><span class="comment"> * excess threads will be terminated if they have been idle for more</span></span><br><span class="line"><span class="comment"> * than the keepAliveTime (see &#123;<span class="doctag">@link</span> #getKeepAliveTime(TimeUnit)&#125;).</span></span><br><span class="line"><span class="comment"> * This provides a means of reducing resource consumption when the</span></span><br><span class="line"><span class="comment"> * pool is not being actively used. If the pool becomes more active</span></span><br><span class="line"><span class="comment"> * later, new threads will be constructed. This parameter can also be</span></span><br><span class="line"><span class="comment"> * changed dynamically using method &#123;<span class="doctag">@link</span> #setKeepAliveTime(long,</span></span><br><span class="line"><span class="comment"> * TimeUnit)&#125;.  Using a value of &#123;<span class="doctag">@code</span> Long.MAX_VALUE&#125; &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment"> * TimeUnit#NANOSECONDS&#125; effectively disables idle threads from ever</span></span><br><span class="line"><span class="comment"> * terminating prior to shut down. By default, the keep-alive policy</span></span><br><span class="line"><span class="comment"> * applies only when there are more than corePoolSize threads. But</span></span><br><span class="line"><span class="comment"> * method &#123;<span class="doctag">@link</span> #allowCoreThreadTimeOut(boolean)&#125; can be used to</span></span><br><span class="line"><span class="comment"> * apply this time-out policy to core threads as well, so long as the</span></span><br><span class="line"><span class="comment"> * keepAliveTime value is non-zero. &lt;/dd&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;dt&gt;Queuing&lt;/dt&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;dd&gt;Any &#123;<span class="doctag">@link</span> BlockingQueue&#125; may be used to transfer and hold</span></span><br><span class="line"><span class="comment"> * submitted tasks.  The use of this queue interacts with pool sizing:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;ul&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;li&gt; If fewer than corePoolSize threads are running, the Executor</span></span><br><span class="line"><span class="comment"> * always prefers adding a new thread</span></span><br><span class="line"><span class="comment"> * rather than queuing.&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;li&gt; If corePoolSize or more threads are running, the Executor</span></span><br><span class="line"><span class="comment"> * always prefers queuing a request rather than adding a new</span></span><br><span class="line"><span class="comment"> * thread.&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;li&gt; If a request cannot be queued, a new thread is created unless</span></span><br><span class="line"><span class="comment"> * this would exceed maximumPoolSize, in which case, the task will be</span></span><br><span class="line"><span class="comment"> * rejected.&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * There are three general strategies for queuing:</span></span><br><span class="line"><span class="comment"> * &lt;ol&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;li&gt; &lt;em&gt; Direct handoffs.&lt;/em&gt; A good default choice for a work</span></span><br><span class="line"><span class="comment"> * queue is a &#123;<span class="doctag">@link</span> SynchronousQueue&#125; that hands off tasks to threads</span></span><br><span class="line"><span class="comment"> * without otherwise holding them. Here, an attempt to queue a task</span></span><br><span class="line"><span class="comment"> * will fail if no threads are immediately available to run it, so a</span></span><br><span class="line"><span class="comment"> * new thread will be constructed. This policy avoids lockups when</span></span><br><span class="line"><span class="comment"> * handling sets of requests that might have internal dependencies.</span></span><br><span class="line"><span class="comment"> * Direct handoffs generally require unbounded maximumPoolSizes to</span></span><br><span class="line"><span class="comment"> * avoid rejection of new submitted tasks. This in turn admits the</span></span><br><span class="line"><span class="comment"> * possibility of unbounded thread growth when commands continue to</span></span><br><span class="line"><span class="comment"> * arrive on average faster than they can be processed.  &lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;&lt;em&gt; Unbounded queues.&lt;/em&gt; Using an unbounded queue (for</span></span><br><span class="line"><span class="comment"> * example a &#123;<span class="doctag">@link</span> LinkedBlockingQueue&#125; without a predefined</span></span><br><span class="line"><span class="comment"> * capacity) will cause new tasks to wait in the queue when all</span></span><br><span class="line"><span class="comment"> * corePoolSize threads are busy. Thus, no more than corePoolSize</span></span><br><span class="line"><span class="comment"> * threads will ever be created. (And the value of the maximumPoolSize</span></span><br><span class="line"><span class="comment"> * therefore doesn&#x27;t have any effect.)  This may be appropriate when</span></span><br><span class="line"><span class="comment"> * each task is completely independent of others, so tasks cannot</span></span><br><span class="line"><span class="comment"> * affect each others execution; for example, in a web page server.</span></span><br><span class="line"><span class="comment"> * While this style of queuing can be useful in smoothing out</span></span><br><span class="line"><span class="comment"> * transient bursts of requests, it admits the possibility of</span></span><br><span class="line"><span class="comment"> * unbounded work queue growth when commands continue to arrive on</span></span><br><span class="line"><span class="comment"> * average faster than they can be processed.  &lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;&lt;em&gt;Bounded queues.&lt;/em&gt; A bounded queue (for example, an</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> ArrayBlockingQueue&#125;) helps prevent resource exhaustion when</span></span><br><span class="line"><span class="comment"> * used with finite maximumPoolSizes, but can be more difficult to</span></span><br><span class="line"><span class="comment"> * tune and control.  Queue sizes and maximum pool sizes may be traded</span></span><br><span class="line"><span class="comment"> * off for each other: Using large queues and small pools minimizes</span></span><br><span class="line"><span class="comment"> * CPU usage, OS resources, and context-switching overhead, but can</span></span><br><span class="line"><span class="comment"> * lead to artificially low throughput.  If tasks frequently block (for</span></span><br><span class="line"><span class="comment"> * example if they are I/O bound), a system may be able to schedule</span></span><br><span class="line"><span class="comment"> * time for more threads than you otherwise allow. Use of small queues</span></span><br><span class="line"><span class="comment"> * generally requires larger pool sizes, which keeps CPUs busier but</span></span><br><span class="line"><span class="comment"> * may encounter unacceptable scheduling overhead, which also</span></span><br><span class="line"><span class="comment"> * decreases throughput.  &lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;/ol&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;/dd&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;dt&gt;Rejected tasks&lt;/dt&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;dd&gt;New tasks submitted in method &#123;<span class="doctag">@link</span> #execute(Runnable)&#125; will be</span></span><br><span class="line"><span class="comment"> * &lt;em&gt;rejected&lt;/em&gt; when the Executor has been shut down, and also when</span></span><br><span class="line"><span class="comment"> * the Executor uses finite bounds for both maximum threads and work queue</span></span><br><span class="line"><span class="comment"> * capacity, and is saturated.  In either case, the &#123;<span class="doctag">@code</span> execute&#125; method</span></span><br><span class="line"><span class="comment"> * invokes the &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment"> * RejectedExecutionHandler#rejectedExecution(Runnable, ThreadPoolExecutor)&#125;</span></span><br><span class="line"><span class="comment"> * method of its &#123;<span class="doctag">@link</span> RejectedExecutionHandler&#125;.  Four predefined handler</span></span><br><span class="line"><span class="comment"> * policies are provided:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;ol&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;li&gt; In the default &#123;<span class="doctag">@link</span> ThreadPoolExecutor.AbortPolicy&#125;, the</span></span><br><span class="line"><span class="comment"> * handler throws a runtime &#123;<span class="doctag">@link</span> RejectedExecutionException&#125; upon</span></span><br><span class="line"><span class="comment"> * rejection. &lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;li&gt; In &#123;<span class="doctag">@link</span> ThreadPoolExecutor.CallerRunsPolicy&#125;, the thread</span></span><br><span class="line"><span class="comment"> * that invokes &#123;<span class="doctag">@code</span> execute&#125; itself runs the task. This provides a</span></span><br><span class="line"><span class="comment"> * simple feedback control mechanism that will slow down the rate that</span></span><br><span class="line"><span class="comment"> * new tasks are submitted. &lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;li&gt; In &#123;<span class="doctag">@link</span> ThreadPoolExecutor.DiscardPolicy&#125;, a task that</span></span><br><span class="line"><span class="comment"> * cannot be executed is simply dropped.  &lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;In &#123;<span class="doctag">@link</span> ThreadPoolExecutor.DiscardOldestPolicy&#125;, if the</span></span><br><span class="line"><span class="comment"> * executor is not shut down, the task at the head of the work queue</span></span><br><span class="line"><span class="comment"> * is dropped, and then execution is retried (which can fail again,</span></span><br><span class="line"><span class="comment"> * causing this to be repeated.) &lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;/ol&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * It is possible to define and use other kinds of &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment"> * RejectedExecutionHandler&#125; classes. Doing so requires some care</span></span><br><span class="line"><span class="comment"> * especially when policies are designed to work only under particular</span></span><br><span class="line"><span class="comment"> * capacity or queuing policies. &lt;/dd&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;dt&gt;Hook methods&lt;/dt&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;dd&gt;This class provides &#123;<span class="doctag">@code</span> protected&#125; overridable</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #beforeExecute(Thread, Runnable)&#125; and</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #afterExecute(Runnable, Throwable)&#125; methods that are called</span></span><br><span class="line"><span class="comment"> * before and after execution of each task.  These can be used to</span></span><br><span class="line"><span class="comment"> * manipulate the execution environment; for example, reinitializing</span></span><br><span class="line"><span class="comment"> * ThreadLocals, gathering statistics, or adding log entries.</span></span><br><span class="line"><span class="comment"> * Additionally, method &#123;<span class="doctag">@link</span> #terminated&#125; can be overridden to perform</span></span><br><span class="line"><span class="comment"> * any special processing that needs to be done once the Executor has</span></span><br><span class="line"><span class="comment"> * fully terminated.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;If hook or callback methods throw exceptions, internal worker</span></span><br><span class="line"><span class="comment"> * threads may in turn fail and abruptly terminate.&lt;/dd&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;dt&gt;Queue maintenance&lt;/dt&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;dd&gt;Method &#123;<span class="doctag">@link</span> #getQueue()&#125; allows access to the work queue</span></span><br><span class="line"><span class="comment"> * for purposes of monitoring and debugging.  Use of this method for</span></span><br><span class="line"><span class="comment"> * any other purpose is strongly discouraged.  Two supplied methods,</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #remove(Runnable)&#125; and &#123;<span class="doctag">@link</span> #purge&#125; are available to</span></span><br><span class="line"><span class="comment"> * assist in storage reclamation when large numbers of queued tasks</span></span><br><span class="line"><span class="comment"> * become cancelled.&lt;/dd&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;dt&gt;Finalization&lt;/dt&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;dd&gt;A pool that is no longer referenced in a program &lt;em&gt;AND&lt;/em&gt;</span></span><br><span class="line"><span class="comment"> * has no remaining threads will be &#123;<span class="doctag">@code</span> shutdown&#125; automatically. If</span></span><br><span class="line"><span class="comment"> * you would like to ensure that unreferenced pools are reclaimed even</span></span><br><span class="line"><span class="comment"> * if users forget to call &#123;<span class="doctag">@link</span> #shutdown&#125;, then you must arrange</span></span><br><span class="line"><span class="comment"> * that unused threads eventually die, by setting appropriate</span></span><br><span class="line"><span class="comment"> * keep-alive times, using a lower bound of zero core threads and/or</span></span><br><span class="line"><span class="comment"> * setting &#123;<span class="doctag">@link</span> #allowCoreThreadTimeOut(boolean)&#125;.  &lt;/dd&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;/dl&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;&lt;b&gt;Extension example&lt;/b&gt;. Most extensions of this class</span></span><br><span class="line"><span class="comment"> * override one or more of the protected hook methods. For example,</span></span><br><span class="line"><span class="comment"> * here is a subclass that adds a simple pause/resume feature:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  &lt;pre&gt; &#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment"> * class PausableThreadPoolExecutor extends ThreadPoolExecutor &#123;</span></span><br><span class="line"><span class="comment"> *   private boolean isPaused;</span></span><br><span class="line"><span class="comment"> *   private ReentrantLock pauseLock = new ReentrantLock();</span></span><br><span class="line"><span class="comment"> *   private Condition unpaused = pauseLock.newCondition();</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   public PausableThreadPoolExecutor(...) &#123; super(...); &#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   protected void beforeExecute(Thread t, Runnable r) &#123;</span></span><br><span class="line"><span class="comment"> *     super.beforeExecute(t, r);</span></span><br><span class="line"><span class="comment"> *     pauseLock.lock();</span></span><br><span class="line"><span class="comment"> *     try &#123;</span></span><br><span class="line"><span class="comment"> *       while (isPaused) unpaused.await();</span></span><br><span class="line"><span class="comment"> *     &#125; catch (InterruptedException ie) &#123;</span></span><br><span class="line"><span class="comment"> *       t.interrupt();</span></span><br><span class="line"><span class="comment"> *     &#125; finally &#123;</span></span><br><span class="line"><span class="comment"> *       pauseLock.unlock();</span></span><br><span class="line"><span class="comment"> *     &#125;</span></span><br><span class="line"><span class="comment"> *   &#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   public void pause() &#123;</span></span><br><span class="line"><span class="comment"> *     pauseLock.lock();</span></span><br><span class="line"><span class="comment"> *     try &#123;</span></span><br><span class="line"><span class="comment"> *       isPaused = true;</span></span><br><span class="line"><span class="comment"> *     &#125; finally &#123;</span></span><br><span class="line"><span class="comment"> *       pauseLock.unlock();</span></span><br><span class="line"><span class="comment"> *     &#125;</span></span><br><span class="line"><span class="comment"> *   &#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   public void resume() &#123;</span></span><br><span class="line"><span class="comment"> *     pauseLock.lock();</span></span><br><span class="line"><span class="comment"> *     try &#123;</span></span><br><span class="line"><span class="comment"> *       isPaused = false;</span></span><br><span class="line"><span class="comment"> *       unpaused.signalAll();</span></span><br><span class="line"><span class="comment"> *     &#125; finally &#123;</span></span><br><span class="line"><span class="comment"> *       pauseLock.unlock();</span></span><br><span class="line"><span class="comment"> *     &#125;</span></span><br><span class="line"><span class="comment"> *   &#125;</span></span><br><span class="line"><span class="comment"> * &#125;&#125;&lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Doug Lea</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractExecutorService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The main pool control state, ctl, is an atomic integer packing</span></span><br><span class="line"><span class="comment">     * two conceptual fields</span></span><br><span class="line"><span class="comment">     *   workerCount, indicating the effective number of threads</span></span><br><span class="line"><span class="comment">     *   runState,    indicating whether running, shutting down etc</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * In order to pack them into one int, we limit workerCount to</span></span><br><span class="line"><span class="comment">     * (2^29)-1 (about 500 million) threads rather than (2^31)-1 (2</span></span><br><span class="line"><span class="comment">     * billion) otherwise representable. If this is ever an issue in</span></span><br><span class="line"><span class="comment">     * the future, the variable can be changed to be an AtomicLong,</span></span><br><span class="line"><span class="comment">     * and the shift/mask constants below adjusted. But until the need</span></span><br><span class="line"><span class="comment">     * arises, this code is a bit faster and simpler using an int.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * The workerCount is the number of workers that have been</span></span><br><span class="line"><span class="comment">     * permitted to start and not permitted to stop.  The value may be</span></span><br><span class="line"><span class="comment">     * transiently different from the actual number of live threads,</span></span><br><span class="line"><span class="comment">     * for example when a ThreadFactory fails to create a thread when</span></span><br><span class="line"><span class="comment">     * asked, and when exiting threads are still performing</span></span><br><span class="line"><span class="comment">     * bookkeeping before terminating. The user-visible pool size is</span></span><br><span class="line"><span class="comment">     * reported as the current size of the workers set.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * The runState provides the main lifecycle control, taking on values:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *   RUNNING:  Accept new tasks and process queued tasks</span></span><br><span class="line"><span class="comment">     *   SHUTDOWN: Don&#x27;t accept new tasks, but process queued tasks</span></span><br><span class="line"><span class="comment">     *   STOP:     Don&#x27;t accept new tasks, don&#x27;t process queued tasks,</span></span><br><span class="line"><span class="comment">     *             and interrupt in-progress tasks</span></span><br><span class="line"><span class="comment">     *   TIDYING:  All tasks have terminated, workerCount is zero,</span></span><br><span class="line"><span class="comment">     *             the thread transitioning to state TIDYING</span></span><br><span class="line"><span class="comment">     *             will run the terminated() hook method</span></span><br><span class="line"><span class="comment">     *   TERMINATED: terminated() has completed</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * The numerical order among these values matters, to allow</span></span><br><span class="line"><span class="comment">     * ordered comparisons. The runState monotonically increases over</span></span><br><span class="line"><span class="comment">     * time, but need not hit each state. The transitions are:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * RUNNING -&gt; SHUTDOWN</span></span><br><span class="line"><span class="comment">     *    On invocation of shutdown(), perhaps implicitly in finalize()</span></span><br><span class="line"><span class="comment">     * (RUNNING or SHUTDOWN) -&gt; STOP</span></span><br><span class="line"><span class="comment">     *    On invocation of shutdownNow()</span></span><br><span class="line"><span class="comment">     * SHUTDOWN -&gt; TIDYING</span></span><br><span class="line"><span class="comment">     *    When both queue and pool are empty</span></span><br><span class="line"><span class="comment">     * STOP -&gt; TIDYING</span></span><br><span class="line"><span class="comment">     *    When pool is empty</span></span><br><span class="line"><span class="comment">     * TIDYING -&gt; TERMINATED</span></span><br><span class="line"><span class="comment">     *    When the terminated() hook method has completed</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Threads waiting in awaitTermination() will return when the</span></span><br><span class="line"><span class="comment">     * state reaches TERMINATED.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Detecting the transition from SHUTDOWN to TIDYING is less</span></span><br><span class="line"><span class="comment">     * straightforward than you&#x27;d like because the queue may become</span></span><br><span class="line"><span class="comment">     * empty after non-empty and vice versa during SHUTDOWN state, but</span></span><br><span class="line"><span class="comment">     * we can only terminate if, after seeing that it is empty, we see</span></span><br><span class="line"><span class="comment">     * that workerCount is 0 (which sometimes entails a recheck -- see</span></span><br><span class="line"><span class="comment">     * below).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger ctl = <span class="keyword">new</span> AtomicInteger(ctlOf(RUNNING, <span class="number">0</span>));</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COUNT_BITS = Integer.SIZE - <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CAPACITY   = (<span class="number">1</span> &lt;&lt; COUNT_BITS) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// runState is stored in the high-order bits</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RUNNING    = -<span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SHUTDOWN   =  <span class="number">0</span> &lt;&lt; COUNT_BITS;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STOP       =  <span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TIDYING    =  <span class="number">2</span> &lt;&lt; COUNT_BITS;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TERMINATED =  <span class="number">3</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Packing and unpacking ctl</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">runStateOf</span><span class="params">(<span class="keyword">int</span> c)</span>     </span>&#123; <span class="keyword">return</span> c &amp; ~CAPACITY; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">workerCountOf</span><span class="params">(<span class="keyword">int</span> c)</span>  </span>&#123; <span class="keyword">return</span> c &amp; CAPACITY; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ctlOf</span><span class="params">(<span class="keyword">int</span> rs, <span class="keyword">int</span> wc)</span> </span>&#123; <span class="keyword">return</span> rs | wc; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Bit field accessors that don&#x27;t require unpacking ctl.</span></span><br><span class="line"><span class="comment">     * These depend on the bit layout and on workerCount being never negative.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">runStateLessThan</span><span class="params">(<span class="keyword">int</span> c, <span class="keyword">int</span> s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> c &lt; s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">runStateAtLeast</span><span class="params">(<span class="keyword">int</span> c, <span class="keyword">int</span> s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> c &gt;= s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isRunning</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> c &lt; SHUTDOWN;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Attempts to CAS-increment the workerCount field of ctl.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">compareAndIncrementWorkerCount</span><span class="params">(<span class="keyword">int</span> expect)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ctl.compareAndSet(expect, expect + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Attempts to CAS-decrement the workerCount field of ctl.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">compareAndDecrementWorkerCount</span><span class="params">(<span class="keyword">int</span> expect)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ctl.compareAndSet(expect, expect - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Decrements the workerCount field of ctl. This is called only on</span></span><br><span class="line"><span class="comment">     * abrupt termination of a thread (see processWorkerExit). Other</span></span><br><span class="line"><span class="comment">     * decrements are performed within getTask.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">decrementWorkerCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;&#125; <span class="keyword">while</span> (! compareAndDecrementWorkerCount(ctl.get()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The queue used for holding tasks and handing off to worker</span></span><br><span class="line"><span class="comment">     * threads.  We do not require that workQueue.poll() returning</span></span><br><span class="line"><span class="comment">     * null necessarily means that workQueue.isEmpty(), so rely</span></span><br><span class="line"><span class="comment">     * solely on isEmpty to see if the queue is empty (which we must</span></span><br><span class="line"><span class="comment">     * do for example when deciding whether to transition from</span></span><br><span class="line"><span class="comment">     * SHUTDOWN to TIDYING).  This accommodates special-purpose</span></span><br><span class="line"><span class="comment">     * queues such as DelayQueues for which poll() is allowed to</span></span><br><span class="line"><span class="comment">     * return null even if it may later return non-null when delays</span></span><br><span class="line"><span class="comment">     * expire.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; workQueue;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Lock held on access to workers set and related bookkeeping.</span></span><br><span class="line"><span class="comment">     * While we could use a concurrent set of some sort, it turns out</span></span><br><span class="line"><span class="comment">     * to be generally preferable to use a lock. Among the reasons is</span></span><br><span class="line"><span class="comment">     * that this serializes interruptIdleWorkers, which avoids</span></span><br><span class="line"><span class="comment">     * unnecessary interrupt storms, especially during shutdown.</span></span><br><span class="line"><span class="comment">     * Otherwise exiting threads would concurrently interrupt those</span></span><br><span class="line"><span class="comment">     * that have not yet interrupted. It also simplifies some of the</span></span><br><span class="line"><span class="comment">     * associated statistics bookkeeping of largestPoolSize etc. We</span></span><br><span class="line"><span class="comment">     * also hold mainLock on shutdown and shutdownNow, for the sake of</span></span><br><span class="line"><span class="comment">     * ensuring workers set is stable while separately checking</span></span><br><span class="line"><span class="comment">     * permission to interrupt and actually interrupting.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set containing all worker threads in pool. Accessed only when</span></span><br><span class="line"><span class="comment">     * holding mainLock.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;Worker&gt; workers = <span class="keyword">new</span> HashSet&lt;Worker&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Wait condition to support awaitTermination</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Condition termination = mainLock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Tracks largest attained pool size. Accessed only under</span></span><br><span class="line"><span class="comment">     * mainLock.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> largestPoolSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Counter for completed tasks. Updated only on termination of</span></span><br><span class="line"><span class="comment">     * worker threads. Accessed only under mainLock.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> completedTaskCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * All user control parameters are declared as volatiles so that</span></span><br><span class="line"><span class="comment">     * ongoing actions are based on freshest values, but without need</span></span><br><span class="line"><span class="comment">     * for locking, since no internal invariants depend on them</span></span><br><span class="line"><span class="comment">     * changing synchronously with respect to other actions.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Factory for new threads. All threads are created using this</span></span><br><span class="line"><span class="comment">     * factory (via method addWorker).  All callers must be prepared</span></span><br><span class="line"><span class="comment">     * for addWorker to fail, which may reflect a system or user&#x27;s</span></span><br><span class="line"><span class="comment">     * policy limiting the number of threads.  Even though it is not</span></span><br><span class="line"><span class="comment">     * treated as an error, failure to create threads may result in</span></span><br><span class="line"><span class="comment">     * new tasks being rejected or existing ones remaining stuck in</span></span><br><span class="line"><span class="comment">     * the queue.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * We go further and preserve pool invariants even in the face of</span></span><br><span class="line"><span class="comment">     * errors such as OutOfMemoryError, that might be thrown while</span></span><br><span class="line"><span class="comment">     * trying to create threads.  Such errors are rather common due to</span></span><br><span class="line"><span class="comment">     * the need to allocate a native stack in Thread.start, and users</span></span><br><span class="line"><span class="comment">     * will want to perform clean pool shutdown to clean up.  There</span></span><br><span class="line"><span class="comment">     * will likely be enough memory available for the cleanup code to</span></span><br><span class="line"><span class="comment">     * complete without encountering yet another OutOfMemoryError.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> ThreadFactory threadFactory;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handler called when saturated or shutdown in execute.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> RejectedExecutionHandler handler;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Timeout in nanoseconds for idle threads waiting for work.</span></span><br><span class="line"><span class="comment">     * Threads use this timeout when there are more than corePoolSize</span></span><br><span class="line"><span class="comment">     * present or if allowCoreThreadTimeOut. Otherwise they wait</span></span><br><span class="line"><span class="comment">     * forever for new work.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> keepAliveTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * If false (default), core threads stay alive even when idle.</span></span><br><span class="line"><span class="comment">     * If true, core threads use keepAliveTime to time out waiting</span></span><br><span class="line"><span class="comment">     * for work.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> allowCoreThreadTimeOut;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Core pool size is the minimum number of workers to keep alive</span></span><br><span class="line"><span class="comment">     * (and not allow to time out etc) unless allowCoreThreadTimeOut</span></span><br><span class="line"><span class="comment">     * is set, in which case the minimum is zero.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> corePoolSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Maximum pool size. Note that the actual maximum is internally</span></span><br><span class="line"><span class="comment">     * bounded by CAPACITY.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> maximumPoolSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The default rejected execution handler</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> RejectedExecutionHandler defaultHandler =</span><br><span class="line">        <span class="keyword">new</span> AbortPolicy();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Permission required for callers of shutdown and shutdownNow.</span></span><br><span class="line"><span class="comment">     * We additionally require (see checkShutdownAccess) that callers</span></span><br><span class="line"><span class="comment">     * have permission to actually interrupt threads in the worker set</span></span><br><span class="line"><span class="comment">     * (as governed by Thread.interrupt, which relies on</span></span><br><span class="line"><span class="comment">     * ThreadGroup.checkAccess, which in turn relies on</span></span><br><span class="line"><span class="comment">     * SecurityManager.checkAccess). Shutdowns are attempted only if</span></span><br><span class="line"><span class="comment">     * these checks pass.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * All actual invocations of Thread.interrupt (see</span></span><br><span class="line"><span class="comment">     * interruptIdleWorkers and interruptWorkers) ignore</span></span><br><span class="line"><span class="comment">     * SecurityExceptions, meaning that the attempted interrupts</span></span><br><span class="line"><span class="comment">     * silently fail. In the case of shutdown, they should not fail</span></span><br><span class="line"><span class="comment">     * unless the SecurityManager has inconsistent policies, sometimes</span></span><br><span class="line"><span class="comment">     * allowing access to a thread and sometimes not. In such cases,</span></span><br><span class="line"><span class="comment">     * failure to actually interrupt threads may disable or delay full</span></span><br><span class="line"><span class="comment">     * termination. Other uses of interruptIdleWorkers are advisory,</span></span><br><span class="line"><span class="comment">     * and failure to actually interrupt will merely delay response to</span></span><br><span class="line"><span class="comment">     * configuration changes so is not handled exceptionally.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> RuntimePermission shutdownPerm =</span><br><span class="line">        <span class="keyword">new</span> RuntimePermission(<span class="string">&quot;modifyThread&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Class Worker mainly maintains interrupt control state for</span></span><br><span class="line"><span class="comment">     * threads running tasks, along with other minor bookkeeping.</span></span><br><span class="line"><span class="comment">     * This class opportunistically extends AbstractQueuedSynchronizer</span></span><br><span class="line"><span class="comment">     * to simplify acquiring and releasing a lock surrounding each</span></span><br><span class="line"><span class="comment">     * task execution.  This protects against interrupts that are</span></span><br><span class="line"><span class="comment">     * intended to wake up a worker thread waiting for a task from</span></span><br><span class="line"><span class="comment">     * instead interrupting a task being run.  We implement a simple</span></span><br><span class="line"><span class="comment">     * non-reentrant mutual exclusion lock rather than use</span></span><br><span class="line"><span class="comment">     * ReentrantLock because we do not want worker tasks to be able to</span></span><br><span class="line"><span class="comment">     * reacquire the lock when they invoke pool control methods like</span></span><br><span class="line"><span class="comment">     * setCorePoolSize.  Additionally, to suppress interrupts until</span></span><br><span class="line"><span class="comment">     * the thread actually starts running tasks, we initialize lock</span></span><br><span class="line"><span class="comment">     * state to a negative value, and clear it upon start (in</span></span><br><span class="line"><span class="comment">     * runWorker).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Worker</span></span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Runnable</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * This class will never be serialized, but we provide a</span></span><br><span class="line"><span class="comment">         * serialVersionUID to suppress a javac warning.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">6138294804551838833L</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** Thread this worker is running in.  Null if factory fails. */</span></span><br><span class="line">        <span class="keyword">final</span> Thread thread;</span><br><span class="line">        <span class="comment">/** Initial task to run.  Possibly null. */</span></span><br><span class="line">        Runnable firstTask;</span><br><span class="line">        <span class="comment">/** Per-thread task counter */</span></span><br><span class="line">        <span class="keyword">volatile</span> <span class="keyword">long</span> completedTasks;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Creates with given first task and thread from ThreadFactory.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> firstTask the first task (null if none)</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Worker(Runnable firstTask) &#123;</span><br><span class="line">            setState(-<span class="number">1</span>); <span class="comment">// inhibit interrupts until runWorker</span></span><br><span class="line">            <span class="keyword">this</span>.firstTask = firstTask;</span><br><span class="line">            <span class="keyword">this</span>.thread = getThreadFactory().newThread(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** Delegates main run loop to outer runWorker  */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            runWorker(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Lock methods</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// The value 0 represents the unlocked state.</span></span><br><span class="line">        <span class="comment">// The value 1 represents the locked state.</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isHeldExclusively</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> getState() != <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> unused)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> unused)</span> </span>&#123;</span><br><span class="line">            setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">            setState(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span>        </span>&#123; acquire(<span class="number">1</span>); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">()</span>  </span>&#123; <span class="keyword">return</span> tryAcquire(<span class="number">1</span>); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span>      </span>&#123; release(<span class="number">1</span>); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLocked</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> isHeldExclusively(); &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">interruptIfStarted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Thread t;</span><br><span class="line">            <span class="keyword">if</span> (getState() &gt;= <span class="number">0</span> &amp;&amp; (t = thread) != <span class="keyword">null</span> &amp;&amp; !t.isInterrupted()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    t.interrupt();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SecurityException ignore) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Methods for setting control state</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Transitions runState to given target, or leaves it alone if</span></span><br><span class="line"><span class="comment">     * already at least the given target.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> targetState the desired state, either SHUTDOWN or STOP</span></span><br><span class="line"><span class="comment">     *        (but not TIDYING or TERMINATED -- use tryTerminate for that)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">advanceRunState</span><span class="params">(<span class="keyword">int</span> targetState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">            <span class="keyword">if</span> (runStateAtLeast(c, targetState) ||</span><br><span class="line">                ctl.compareAndSet(c, ctlOf(targetState, workerCountOf(c))))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Transitions to TERMINATED state if either (SHUTDOWN and pool</span></span><br><span class="line"><span class="comment">     * and queue empty) or (STOP and pool empty).  If otherwise</span></span><br><span class="line"><span class="comment">     * eligible to terminate but workerCount is nonzero, interrupts an</span></span><br><span class="line"><span class="comment">     * idle worker to ensure that shutdown signals propagate. This</span></span><br><span class="line"><span class="comment">     * method must be called following any action that might make</span></span><br><span class="line"><span class="comment">     * termination possible -- reducing worker count or removing tasks</span></span><br><span class="line"><span class="comment">     * from the queue during shutdown. The method is non-private to</span></span><br><span class="line"><span class="comment">     * allow access from ScheduledThreadPoolExecutor.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">tryTerminate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">            <span class="keyword">if</span> (isRunning(c) ||</span><br><span class="line">                runStateAtLeast(c, TIDYING) ||</span><br><span class="line">                (runStateOf(c) == SHUTDOWN &amp;&amp; ! workQueue.isEmpty()))</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            <span class="keyword">if</span> (workerCountOf(c) != <span class="number">0</span>) &#123; <span class="comment">// Eligible to terminate</span></span><br><span class="line">                interruptIdleWorkers(ONLY_ONE);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">            mainLock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (ctl.compareAndSet(c, ctlOf(TIDYING, <span class="number">0</span>))) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        terminated();</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        ctl.set(ctlOf(TERMINATED, <span class="number">0</span>));</span><br><span class="line">                        termination.signalAll();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                mainLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// else retry on failed CAS</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Methods for controlling interrupts to worker threads.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * If there is a security manager, makes sure caller has</span></span><br><span class="line"><span class="comment">     * permission to shut down threads in general (see shutdownPerm).</span></span><br><span class="line"><span class="comment">     * If this passes, additionally makes sure the caller is allowed</span></span><br><span class="line"><span class="comment">     * to interrupt each worker thread. This might not be true even if</span></span><br><span class="line"><span class="comment">     * first check passed, if the SecurityManager treats some threads</span></span><br><span class="line"><span class="comment">     * specially.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkShutdownAccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SecurityManager security = System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">            security.checkPermission(shutdownPerm);</span><br><span class="line">            <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">            mainLock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (Worker w : workers)</span><br><span class="line">                    security.checkAccess(w.thread);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                mainLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Interrupts all threads, even if active. Ignores SecurityExceptions</span></span><br><span class="line"><span class="comment">     * (in which case some threads may remain uninterrupted).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">interruptWorkers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">        mainLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (Worker w : workers)</span><br><span class="line">                w.interruptIfStarted();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mainLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Interrupts threads that might be waiting for tasks (as</span></span><br><span class="line"><span class="comment">     * indicated by not being locked) so they can check for</span></span><br><span class="line"><span class="comment">     * termination or configuration changes. Ignores</span></span><br><span class="line"><span class="comment">     * SecurityExceptions (in which case some threads may remain</span></span><br><span class="line"><span class="comment">     * uninterrupted).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> onlyOne If true, interrupt at most one worker. This is</span></span><br><span class="line"><span class="comment">     * called only from tryTerminate when termination is otherwise</span></span><br><span class="line"><span class="comment">     * enabled but there are still other workers.  In this case, at</span></span><br><span class="line"><span class="comment">     * most one waiting worker is interrupted to propagate shutdown</span></span><br><span class="line"><span class="comment">     * signals in case all threads are currently waiting.</span></span><br><span class="line"><span class="comment">     * Interrupting any arbitrary thread ensures that newly arriving</span></span><br><span class="line"><span class="comment">     * workers since shutdown began will also eventually exit.</span></span><br><span class="line"><span class="comment">     * To guarantee eventual termination, it suffices to always</span></span><br><span class="line"><span class="comment">     * interrupt only one idle worker, but shutdown() interrupts all</span></span><br><span class="line"><span class="comment">     * idle workers so that redundant workers exit promptly, not</span></span><br><span class="line"><span class="comment">     * waiting for a straggler task to finish.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">interruptIdleWorkers</span><span class="params">(<span class="keyword">boolean</span> onlyOne)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">        mainLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (Worker w : workers) &#123;</span><br><span class="line">                Thread t = w.thread;</span><br><span class="line">                <span class="keyword">if</span> (!t.isInterrupted() &amp;&amp; w.tryLock()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        t.interrupt();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (SecurityException ignore) &#123;</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        w.unlock();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (onlyOne)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mainLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Common form of interruptIdleWorkers, to avoid having to</span></span><br><span class="line"><span class="comment">     * remember what the boolean argument means.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">interruptIdleWorkers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        interruptIdleWorkers(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> ONLY_ONE = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Misc utilities, most of which are also exported to</span></span><br><span class="line"><span class="comment">     * ScheduledThreadPoolExecutor</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Invokes the rejected execution handler for the given command.</span></span><br><span class="line"><span class="comment">     * Package-protected for use by ScheduledThreadPoolExecutor.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">reject</span><span class="params">(Runnable command)</span> </span>&#123;</span><br><span class="line">        handler.rejectedExecution(command, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Performs any further cleanup following run state transition on</span></span><br><span class="line"><span class="comment">     * invocation of shutdown.  A no-op here, but used by</span></span><br><span class="line"><span class="comment">     * ScheduledThreadPoolExecutor to cancel delayed tasks.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onShutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * State check needed by ScheduledThreadPoolExecutor to</span></span><br><span class="line"><span class="comment">     * enable running tasks during shutdown.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shutdownOK true if should return true if SHUTDOWN</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isRunningOrShutdown</span><span class="params">(<span class="keyword">boolean</span> shutdownOK)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> rs = runStateOf(ctl.get());</span><br><span class="line">        <span class="keyword">return</span> rs == RUNNING || (rs == SHUTDOWN &amp;&amp; shutdownOK);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Drains the task queue into a new list, normally using</span></span><br><span class="line"><span class="comment">     * drainTo. But if the queue is a DelayQueue or any other kind of</span></span><br><span class="line"><span class="comment">     * queue for which poll or drainTo may fail to remove some</span></span><br><span class="line"><span class="comment">     * elements, it deletes them one by one.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;Runnable&gt; <span class="title">drainQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        BlockingQueue&lt;Runnable&gt; q = workQueue;</span><br><span class="line">        ArrayList&lt;Runnable&gt; taskList = <span class="keyword">new</span> ArrayList&lt;Runnable&gt;();</span><br><span class="line">        q.drainTo(taskList);</span><br><span class="line">        <span class="keyword">if</span> (!q.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Runnable r : q.toArray(<span class="keyword">new</span> Runnable[<span class="number">0</span>])) &#123;</span><br><span class="line">                <span class="keyword">if</span> (q.remove(r))</span><br><span class="line">                    taskList.add(r);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> taskList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Methods for creating, running and cleaning up after workers</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Checks if a new worker can be added with respect to current</span></span><br><span class="line"><span class="comment">     * pool state and the given bound (either core or maximum). If so,</span></span><br><span class="line"><span class="comment">     * the worker count is adjusted accordingly, and, if possible, a</span></span><br><span class="line"><span class="comment">     * new worker is created and started, running firstTask as its</span></span><br><span class="line"><span class="comment">     * first task. This method returns false if the pool is stopped or</span></span><br><span class="line"><span class="comment">     * eligible to shut down. It also returns false if the thread</span></span><br><span class="line"><span class="comment">     * factory fails to create a thread when asked.  If the thread</span></span><br><span class="line"><span class="comment">     * creation fails, either due to the thread factory returning</span></span><br><span class="line"><span class="comment">     * null, or due to an exception (typically OutOfMemoryError in</span></span><br><span class="line"><span class="comment">     * Thread.start()), we roll back cleanly.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> firstTask the task the new thread should run first (or</span></span><br><span class="line"><span class="comment">     * null if none). Workers are created with an initial first task</span></span><br><span class="line"><span class="comment">     * (in method execute()) to bypass queuing when there are fewer</span></span><br><span class="line"><span class="comment">     * than corePoolSize threads (in which case we always start one),</span></span><br><span class="line"><span class="comment">     * or when the queue is full (in which case we must bypass queue).</span></span><br><span class="line"><span class="comment">     * Initially idle threads are usually created via</span></span><br><span class="line"><span class="comment">     * prestartCoreThread or to replace other dying workers.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> core if true use corePoolSize as bound, else</span></span><br><span class="line"><span class="comment">     * maximumPoolSize. (A boolean indicator is used here rather than a</span></span><br><span class="line"><span class="comment">     * value to ensure reads of fresh values after checking other pool</span></span><br><span class="line"><span class="comment">     * state).</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true if successful</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addWorker</span><span class="params">(Runnable firstTask, <span class="keyword">boolean</span> core)</span> </span>&#123;</span><br><span class="line">        retry:</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">            <span class="keyword">int</span> rs = runStateOf(c);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check if queue empty only if necessary.</span></span><br><span class="line">            <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp;</span><br><span class="line">                ! (rs == SHUTDOWN &amp;&amp;</span><br><span class="line">                   firstTask == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                   ! workQueue.isEmpty()))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="keyword">int</span> wc = workerCountOf(c);</span><br><span class="line">                <span class="keyword">if</span> (wc &gt;= CAPACITY ||</span><br><span class="line">                    wc &gt;= (core ? corePoolSize : maximumPoolSize))</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">if</span> (compareAndIncrementWorkerCount(c))</span><br><span class="line">                    <span class="keyword">break</span> retry;</span><br><span class="line">                c = ctl.get();  <span class="comment">// Re-read ctl</span></span><br><span class="line">                <span class="keyword">if</span> (runStateOf(c) != rs)</span><br><span class="line">                    <span class="keyword">continue</span> retry;</span><br><span class="line">                <span class="comment">// else CAS failed due to workerCount change; retry inner loop</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> workerStarted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">boolean</span> workerAdded = <span class="keyword">false</span>;</span><br><span class="line">        Worker w = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            w = <span class="keyword">new</span> Worker(firstTask);</span><br><span class="line">            <span class="keyword">final</span> Thread t = w.thread;</span><br><span class="line">            <span class="keyword">if</span> (t != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">                mainLock.lock();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// Recheck while holding lock.</span></span><br><span class="line">                    <span class="comment">// Back out on ThreadFactory failure or if</span></span><br><span class="line">                    <span class="comment">// shut down before lock acquired.</span></span><br><span class="line">                    <span class="keyword">int</span> rs = runStateOf(ctl.get());</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (rs &lt; SHUTDOWN ||</span><br><span class="line">                        (rs == SHUTDOWN &amp;&amp; firstTask == <span class="keyword">null</span>)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (t.isAlive()) <span class="comment">// precheck that t is startable</span></span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalThreadStateException();</span><br><span class="line">                        workers.add(w);</span><br><span class="line">                        <span class="keyword">int</span> s = workers.size();</span><br><span class="line">                        <span class="keyword">if</span> (s &gt; largestPoolSize)</span><br><span class="line">                            largestPoolSize = s;</span><br><span class="line">                        workerAdded = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    mainLock.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (workerAdded) &#123;</span><br><span class="line">                    t.start();</span><br><span class="line">                    workerStarted = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (! workerStarted)</span><br><span class="line">                addWorkerFailed(w);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> workerStarted;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Rolls back the worker thread creation.</span></span><br><span class="line"><span class="comment">     * - removes worker from workers, if present</span></span><br><span class="line"><span class="comment">     * - decrements worker count</span></span><br><span class="line"><span class="comment">     * - rechecks for termination, in case the existence of this</span></span><br><span class="line"><span class="comment">     *   worker was holding up termination</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addWorkerFailed</span><span class="params">(Worker w)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">        mainLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (w != <span class="keyword">null</span>)</span><br><span class="line">                workers.remove(w);</span><br><span class="line">            decrementWorkerCount();</span><br><span class="line">            tryTerminate();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mainLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Performs cleanup and bookkeeping for a dying worker. Called</span></span><br><span class="line"><span class="comment">     * only from worker threads. Unless completedAbruptly is set,</span></span><br><span class="line"><span class="comment">     * assumes that workerCount has already been adjusted to account</span></span><br><span class="line"><span class="comment">     * for exit.  This method removes thread from worker set, and</span></span><br><span class="line"><span class="comment">     * possibly terminates the pool or replaces the worker if either</span></span><br><span class="line"><span class="comment">     * it exited due to user task exception or if fewer than</span></span><br><span class="line"><span class="comment">     * corePoolSize workers are running or queue is non-empty but</span></span><br><span class="line"><span class="comment">     * there are no workers.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> w the worker</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> completedAbruptly if the worker died due to user exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processWorkerExit</span><span class="params">(Worker w, <span class="keyword">boolean</span> completedAbruptly)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (completedAbruptly) <span class="comment">// If abrupt, then workerCount wasn&#x27;t adjusted</span></span><br><span class="line">            decrementWorkerCount();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">        mainLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            completedTaskCount += w.completedTasks;</span><br><span class="line">            workers.remove(w);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mainLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        tryTerminate();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">        <span class="keyword">if</span> (runStateLessThan(c, STOP)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!completedAbruptly) &#123;</span><br><span class="line">                <span class="keyword">int</span> min = allowCoreThreadTimeOut ? <span class="number">0</span> : corePoolSize;</span><br><span class="line">                <span class="keyword">if</span> (min == <span class="number">0</span> &amp;&amp; ! workQueue.isEmpty())</span><br><span class="line">                    min = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (workerCountOf(c) &gt;= min)</span><br><span class="line">                    <span class="keyword">return</span>; <span class="comment">// replacement not needed</span></span><br><span class="line">            &#125;</span><br><span class="line">            addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Performs blocking or timed wait for a task, depending on</span></span><br><span class="line"><span class="comment">     * current configuration settings, or returns null if this worker</span></span><br><span class="line"><span class="comment">     * must exit because of any of:</span></span><br><span class="line"><span class="comment">     * 1. There are more than maximumPoolSize workers (due to</span></span><br><span class="line"><span class="comment">     *    a call to setMaximumPoolSize).</span></span><br><span class="line"><span class="comment">     * 2. The pool is stopped.</span></span><br><span class="line"><span class="comment">     * 3. The pool is shutdown and the queue is empty.</span></span><br><span class="line"><span class="comment">     * 4. This worker timed out waiting for a task, and timed-out</span></span><br><span class="line"><span class="comment">     *    workers are subject to termination (that is,</span></span><br><span class="line"><span class="comment">     *    &#123;<span class="doctag">@code</span> allowCoreThreadTimeOut || workerCount &gt; corePoolSize&#125;)</span></span><br><span class="line"><span class="comment">     *    both before and after the timed wait, and if the queue is</span></span><br><span class="line"><span class="comment">     *    non-empty, this worker is not the last thread in the pool.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> task, or null if the worker must exit, in which case</span></span><br><span class="line"><span class="comment">     *         workerCount is decremented</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Runnable <span class="title">getTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> timedOut = <span class="keyword">false</span>; <span class="comment">// Did the last poll() time out?</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">            <span class="keyword">int</span> rs = runStateOf(c);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check if queue empty only if necessary.</span></span><br><span class="line">            <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123;</span><br><span class="line">                decrementWorkerCount();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> wc = workerCountOf(c);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Are workers subject to culling?</span></span><br><span class="line">            <span class="keyword">boolean</span> timed = allowCoreThreadTimeOut || wc &gt; corePoolSize;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))</span><br><span class="line">                &amp;&amp; (wc &gt; <span class="number">1</span> || workQueue.isEmpty())) &#123;</span><br><span class="line">                <span class="keyword">if</span> (compareAndDecrementWorkerCount(c))</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Runnable r = timed ?</span><br><span class="line">                    workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :</span><br><span class="line">                    workQueue.take();</span><br><span class="line">                <span class="keyword">if</span> (r != <span class="keyword">null</span>)</span><br><span class="line">                    <span class="keyword">return</span> r;</span><br><span class="line">                timedOut = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException retry) &#123;</span><br><span class="line">                timedOut = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Main worker run loop.  Repeatedly gets tasks from queue and</span></span><br><span class="line"><span class="comment">     * executes them, while coping with a number of issues:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 1. We may start out with an initial task, in which case we</span></span><br><span class="line"><span class="comment">     * don&#x27;t need to get the first one. Otherwise, as long as pool is</span></span><br><span class="line"><span class="comment">     * running, we get tasks from getTask. If it returns null then the</span></span><br><span class="line"><span class="comment">     * worker exits due to changed pool state or configuration</span></span><br><span class="line"><span class="comment">     * parameters.  Other exits result from exception throws in</span></span><br><span class="line"><span class="comment">     * external code, in which case completedAbruptly holds, which</span></span><br><span class="line"><span class="comment">     * usually leads processWorkerExit to replace this thread.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 2. Before running any task, the lock is acquired to prevent</span></span><br><span class="line"><span class="comment">     * other pool interrupts while the task is executing, and then we</span></span><br><span class="line"><span class="comment">     * ensure that unless pool is stopping, this thread does not have</span></span><br><span class="line"><span class="comment">     * its interrupt set.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 3. Each task run is preceded by a call to beforeExecute, which</span></span><br><span class="line"><span class="comment">     * might throw an exception, in which case we cause thread to die</span></span><br><span class="line"><span class="comment">     * (breaking loop with completedAbruptly true) without processing</span></span><br><span class="line"><span class="comment">     * the task.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 4. Assuming beforeExecute completes normally, we run the task,</span></span><br><span class="line"><span class="comment">     * gathering any of its thrown exceptions to send to afterExecute.</span></span><br><span class="line"><span class="comment">     * We separately handle RuntimeException, Error (both of which the</span></span><br><span class="line"><span class="comment">     * specs guarantee that we trap) and arbitrary Throwables.</span></span><br><span class="line"><span class="comment">     * Because we cannot rethrow Throwables within Runnable.run, we</span></span><br><span class="line"><span class="comment">     * wrap them within Errors on the way out (to the thread&#x27;s</span></span><br><span class="line"><span class="comment">     * UncaughtExceptionHandler).  Any thrown exception also</span></span><br><span class="line"><span class="comment">     * conservatively causes thread to die.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 5. After task.run completes, we call afterExecute, which may</span></span><br><span class="line"><span class="comment">     * also throw an exception, which will also cause thread to</span></span><br><span class="line"><span class="comment">     * die. According to JLS Sec 14.20, this exception is the one that</span></span><br><span class="line"><span class="comment">     * will be in effect even if task.run throws.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * The net effect of the exception mechanics is that afterExecute</span></span><br><span class="line"><span class="comment">     * and the thread&#x27;s UncaughtExceptionHandler have as accurate</span></span><br><span class="line"><span class="comment">     * information as we can provide about any problems encountered by</span></span><br><span class="line"><span class="comment">     * user code.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> w the worker</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">runWorker</span><span class="params">(Worker w)</span> </span>&#123;</span><br><span class="line">        Thread wt = Thread.currentThread();</span><br><span class="line">        Runnable task = w.firstTask;</span><br><span class="line">        w.firstTask = <span class="keyword">null</span>;</span><br><span class="line">        w.unlock(); <span class="comment">// allow interrupts</span></span><br><span class="line">        <span class="keyword">boolean</span> completedAbruptly = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (task != <span class="keyword">null</span> || (task = getTask()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                w.lock();</span><br><span class="line">                <span class="comment">// If pool is stopping, ensure thread is interrupted;</span></span><br><span class="line">                <span class="comment">// if not, ensure thread is not interrupted.  This</span></span><br><span class="line">                <span class="comment">// requires a recheck in second case to deal with</span></span><br><span class="line">                <span class="comment">// shutdownNow race while clearing interrupt</span></span><br><span class="line">                <span class="keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||</span><br><span class="line">                     (Thread.interrupted() &amp;&amp;</span><br><span class="line">                      runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</span><br><span class="line">                    !wt.isInterrupted())</span><br><span class="line">                    wt.interrupt();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    beforeExecute(wt, task);</span><br><span class="line">                    Throwable thrown = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        task.run();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (RuntimeException x) &#123;</span><br><span class="line">                        thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Error x) &#123;</span><br><span class="line">                        thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable x) &#123;</span><br><span class="line">                        thrown = x; <span class="keyword">throw</span> <span class="keyword">new</span> Error(x);</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        afterExecute(task, thrown);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    task = <span class="keyword">null</span>;</span><br><span class="line">                    w.completedTasks++;</span><br><span class="line">                    w.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            completedAbruptly = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            processWorkerExit(w, completedAbruptly);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Public constructors and methods</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new &#123;<span class="doctag">@code</span> ThreadPoolExecutor&#125; with the given initial</span></span><br><span class="line"><span class="comment">     * parameters and default thread factory and rejected execution handler.</span></span><br><span class="line"><span class="comment">     * It may be more convenient to use one of the &#123;<span class="doctag">@link</span> Executors&#125; factory</span></span><br><span class="line"><span class="comment">     * methods instead of this general purpose constructor.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> corePoolSize the number of threads to keep in the pool, even</span></span><br><span class="line"><span class="comment">     *        if they are idle, unless &#123;<span class="doctag">@code</span> allowCoreThreadTimeOut&#125; is set</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> maximumPoolSize the maximum number of threads to allow in the</span></span><br><span class="line"><span class="comment">     *        pool</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keepAliveTime when the number of threads is greater than</span></span><br><span class="line"><span class="comment">     *        the core, this is the maximum time that excess idle threads</span></span><br><span class="line"><span class="comment">     *        will wait for new tasks before terminating.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unit the time unit for the &#123;<span class="doctag">@code</span> keepAliveTime&#125; argument</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> workQueue the queue to use for holding tasks before they are</span></span><br><span class="line"><span class="comment">     *        executed.  This queue will hold only the &#123;<span class="doctag">@code</span> Runnable&#125;</span></span><br><span class="line"><span class="comment">     *        tasks submitted by the &#123;<span class="doctag">@code</span> execute&#125; method.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException if one of the following holds:&lt;br&gt;</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> corePoolSize &lt; 0&#125;&lt;br&gt;</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> keepAliveTime &lt; 0&#125;&lt;br&gt;</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> maximumPoolSize &lt;= 0&#125;&lt;br&gt;</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> maximumPoolSize &lt; corePoolSize&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if &#123;<span class="doctag">@code</span> workQueue&#125; is null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">int</span> maximumPoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">long</span> keepAliveTime,</span></span></span><br><span class="line"><span class="function"><span class="params">                              TimeUnit unit,</span></span></span><br><span class="line"><span class="function"><span class="params">                              BlockingQueue&lt;Runnable&gt; workQueue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,</span><br><span class="line">             Executors.defaultThreadFactory(), defaultHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new &#123;<span class="doctag">@code</span> ThreadPoolExecutor&#125; with the given initial</span></span><br><span class="line"><span class="comment">     * parameters and default rejected execution handler.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> corePoolSize the number of threads to keep in the pool, even</span></span><br><span class="line"><span class="comment">     *        if they are idle, unless &#123;<span class="doctag">@code</span> allowCoreThreadTimeOut&#125; is set</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> maximumPoolSize the maximum number of threads to allow in the</span></span><br><span class="line"><span class="comment">     *        pool</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keepAliveTime when the number of threads is greater than</span></span><br><span class="line"><span class="comment">     *        the core, this is the maximum time that excess idle threads</span></span><br><span class="line"><span class="comment">     *        will wait for new tasks before terminating.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unit the time unit for the &#123;<span class="doctag">@code</span> keepAliveTime&#125; argument</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> workQueue the queue to use for holding tasks before they are</span></span><br><span class="line"><span class="comment">     *        executed.  This queue will hold only the &#123;<span class="doctag">@code</span> Runnable&#125;</span></span><br><span class="line"><span class="comment">     *        tasks submitted by the &#123;<span class="doctag">@code</span> execute&#125; method.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> threadFactory the factory to use when the executor</span></span><br><span class="line"><span class="comment">     *        creates a new thread</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException if one of the following holds:&lt;br&gt;</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> corePoolSize &lt; 0&#125;&lt;br&gt;</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> keepAliveTime &lt; 0&#125;&lt;br&gt;</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> maximumPoolSize &lt;= 0&#125;&lt;br&gt;</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> maximumPoolSize &lt; corePoolSize&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if &#123;<span class="doctag">@code</span> workQueue&#125;</span></span><br><span class="line"><span class="comment">     *         or &#123;<span class="doctag">@code</span> threadFactory&#125; is null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">int</span> maximumPoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">long</span> keepAliveTime,</span></span></span><br><span class="line"><span class="function"><span class="params">                              TimeUnit unit,</span></span></span><br><span class="line"><span class="function"><span class="params">                              BlockingQueue&lt;Runnable&gt; workQueue,</span></span></span><br><span class="line"><span class="function"><span class="params">                              ThreadFactory threadFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,</span><br><span class="line">             threadFactory, defaultHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new &#123;<span class="doctag">@code</span> ThreadPoolExecutor&#125; with the given initial</span></span><br><span class="line"><span class="comment">     * parameters and default thread factory.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> corePoolSize the number of threads to keep in the pool, even</span></span><br><span class="line"><span class="comment">     *        if they are idle, unless &#123;<span class="doctag">@code</span> allowCoreThreadTimeOut&#125; is set</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> maximumPoolSize the maximum number of threads to allow in the</span></span><br><span class="line"><span class="comment">     *        pool</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keepAliveTime when the number of threads is greater than</span></span><br><span class="line"><span class="comment">     *        the core, this is the maximum time that excess idle threads</span></span><br><span class="line"><span class="comment">     *        will wait for new tasks before terminating.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unit the time unit for the &#123;<span class="doctag">@code</span> keepAliveTime&#125; argument</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> workQueue the queue to use for holding tasks before they are</span></span><br><span class="line"><span class="comment">     *        executed.  This queue will hold only the &#123;<span class="doctag">@code</span> Runnable&#125;</span></span><br><span class="line"><span class="comment">     *        tasks submitted by the &#123;<span class="doctag">@code</span> execute&#125; method.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler the handler to use when execution is blocked</span></span><br><span class="line"><span class="comment">     *        because the thread bounds and queue capacities are reached</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException if one of the following holds:&lt;br&gt;</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> corePoolSize &lt; 0&#125;&lt;br&gt;</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> keepAliveTime &lt; 0&#125;&lt;br&gt;</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> maximumPoolSize &lt;= 0&#125;&lt;br&gt;</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> maximumPoolSize &lt; corePoolSize&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if &#123;<span class="doctag">@code</span> workQueue&#125;</span></span><br><span class="line"><span class="comment">     *         or &#123;<span class="doctag">@code</span> handler&#125; is null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">int</span> maximumPoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">long</span> keepAliveTime,</span></span></span><br><span class="line"><span class="function"><span class="params">                              TimeUnit unit,</span></span></span><br><span class="line"><span class="function"><span class="params">                              BlockingQueue&lt;Runnable&gt; workQueue,</span></span></span><br><span class="line"><span class="function"><span class="params">                              RejectedExecutionHandler handler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,</span><br><span class="line">             Executors.defaultThreadFactory(), handler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new &#123;<span class="doctag">@code</span> ThreadPoolExecutor&#125; with the given initial</span></span><br><span class="line"><span class="comment">     * parameters.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> corePoolSize the number of threads to keep in the pool, even</span></span><br><span class="line"><span class="comment">     *        if they are idle, unless &#123;<span class="doctag">@code</span> allowCoreThreadTimeOut&#125; is set</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> maximumPoolSize the maximum number of threads to allow in the</span></span><br><span class="line"><span class="comment">     *        pool</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keepAliveTime when the number of threads is greater than</span></span><br><span class="line"><span class="comment">     *        the core, this is the maximum time that excess idle threads</span></span><br><span class="line"><span class="comment">     *        will wait for new tasks before terminating.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unit the time unit for the &#123;<span class="doctag">@code</span> keepAliveTime&#125; argument</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> workQueue the queue to use for holding tasks before they are</span></span><br><span class="line"><span class="comment">     *        executed.  This queue will hold only the &#123;<span class="doctag">@code</span> Runnable&#125;</span></span><br><span class="line"><span class="comment">     *        tasks submitted by the &#123;<span class="doctag">@code</span> execute&#125; method.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> threadFactory the factory to use when the executor</span></span><br><span class="line"><span class="comment">     *        creates a new thread</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler the handler to use when execution is blocked</span></span><br><span class="line"><span class="comment">     *        because the thread bounds and queue capacities are reached</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException if one of the following holds:&lt;br&gt;</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> corePoolSize &lt; 0&#125;&lt;br&gt;</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> keepAliveTime &lt; 0&#125;&lt;br&gt;</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> maximumPoolSize &lt;= 0&#125;&lt;br&gt;</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> maximumPoolSize &lt; corePoolSize&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if &#123;<span class="doctag">@code</span> workQueue&#125;</span></span><br><span class="line"><span class="comment">     *         or &#123;<span class="doctag">@code</span> threadFactory&#125; or &#123;<span class="doctag">@code</span> handler&#125; is null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">int</span> maximumPoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">long</span> keepAliveTime,</span></span></span><br><span class="line"><span class="function"><span class="params">                              TimeUnit unit,</span></span></span><br><span class="line"><span class="function"><span class="params">                              BlockingQueue&lt;Runnable&gt; workQueue,</span></span></span><br><span class="line"><span class="function"><span class="params">                              ThreadFactory threadFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">                              RejectedExecutionHandler handler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (corePoolSize &lt; <span class="number">0</span> ||</span><br><span class="line">            maximumPoolSize &lt;= <span class="number">0</span> ||</span><br><span class="line">            maximumPoolSize &lt; corePoolSize ||</span><br><span class="line">            keepAliveTime &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        <span class="keyword">if</span> (workQueue == <span class="keyword">null</span> || threadFactory == <span class="keyword">null</span> || handler == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">this</span>.corePoolSize = corePoolSize;</span><br><span class="line">        <span class="keyword">this</span>.maximumPoolSize = maximumPoolSize;</span><br><span class="line">        <span class="keyword">this</span>.workQueue = workQueue;</span><br><span class="line">        <span class="keyword">this</span>.keepAliveTime = unit.toNanos(keepAliveTime);</span><br><span class="line">        <span class="keyword">this</span>.threadFactory = threadFactory;</span><br><span class="line">        <span class="keyword">this</span>.handler = handler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Executes the given task sometime in the future.  The task</span></span><br><span class="line"><span class="comment">     * may execute in a new thread or in an existing pooled thread.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * If the task cannot be submitted for execution, either because this</span></span><br><span class="line"><span class="comment">     * executor has been shutdown or because its capacity has been reached,</span></span><br><span class="line"><span class="comment">     * the task is handled by the current &#123;<span class="doctag">@code</span> RejectedExecutionHandler&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> command the task to execute</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> RejectedExecutionException at discretion of</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> RejectedExecutionHandler&#125;, if the task</span></span><br><span class="line"><span class="comment">     *         cannot be accepted for execution</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if &#123;<span class="doctag">@code</span> command&#125; is null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (command == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Proceed in 3 steps:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 1. If fewer than corePoolSize threads are running, try to</span></span><br><span class="line"><span class="comment">         * start a new thread with the given command as its first</span></span><br><span class="line"><span class="comment">         * task.  The call to addWorker atomically checks runState and</span></span><br><span class="line"><span class="comment">         * workerCount, and so prevents false alarms that would add</span></span><br><span class="line"><span class="comment">         * threads when it shouldn&#x27;t, by returning false.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 2. If a task can be successfully queued, then we still need</span></span><br><span class="line"><span class="comment">         * to double-check whether we should have added a thread</span></span><br><span class="line"><span class="comment">         * (because existing ones died since last checking) or that</span></span><br><span class="line"><span class="comment">         * the pool shut down since entry into this method. So we</span></span><br><span class="line"><span class="comment">         * recheck state and if necessary roll back the enqueuing if</span></span><br><span class="line"><span class="comment">         * stopped, or start a new thread if there are none.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 3. If we cannot queue task, then we try to add a new</span></span><br><span class="line"><span class="comment">         * thread.  If it fails, we know we are shut down or saturated</span></span><br><span class="line"><span class="comment">         * and so reject the task.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">        <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</span><br><span class="line">            <span class="keyword">if</span> (addWorker(command, <span class="keyword">true</span>))</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            c = ctl.get();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class="line">            <span class="keyword">int</span> recheck = ctl.get();</span><br><span class="line">            <span class="keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command))</span><br><span class="line">                reject(command);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</span><br><span class="line">                addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="keyword">false</span>))</span><br><span class="line">            reject(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initiates an orderly shutdown in which previously submitted</span></span><br><span class="line"><span class="comment">     * tasks are executed, but no new tasks will be accepted.</span></span><br><span class="line"><span class="comment">     * Invocation has no additional effect if already shut down.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;This method does not wait for previously submitted tasks to</span></span><br><span class="line"><span class="comment">     * complete execution.  Use &#123;<span class="doctag">@link</span> #awaitTermination awaitTermination&#125;</span></span><br><span class="line"><span class="comment">     * to do that.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> SecurityException &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">        mainLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            checkShutdownAccess();</span><br><span class="line">            advanceRunState(SHUTDOWN);</span><br><span class="line">            interruptIdleWorkers();</span><br><span class="line">            onShutdown(); <span class="comment">// hook for ScheduledThreadPoolExecutor</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mainLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        tryTerminate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Attempts to stop all actively executing tasks, halts the</span></span><br><span class="line"><span class="comment">     * processing of waiting tasks, and returns a list of the tasks</span></span><br><span class="line"><span class="comment">     * that were awaiting execution. These tasks are drained (removed)</span></span><br><span class="line"><span class="comment">     * from the task queue upon return from this method.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;This method does not wait for actively executing tasks to</span></span><br><span class="line"><span class="comment">     * terminate.  Use &#123;<span class="doctag">@link</span> #awaitTermination awaitTermination&#125; to</span></span><br><span class="line"><span class="comment">     * do that.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;There are no guarantees beyond best-effort attempts to stop</span></span><br><span class="line"><span class="comment">     * processing actively executing tasks.  This implementation</span></span><br><span class="line"><span class="comment">     * cancels tasks via &#123;<span class="doctag">@link</span> Thread#interrupt&#125;, so any task that</span></span><br><span class="line"><span class="comment">     * fails to respond to interrupts may never terminate.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> SecurityException &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Runnable&gt; <span class="title">shutdownNow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Runnable&gt; tasks;</span><br><span class="line">        <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">        mainLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            checkShutdownAccess();</span><br><span class="line">            advanceRunState(STOP);</span><br><span class="line">            interruptWorkers();</span><br><span class="line">            tasks = drainQueue();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mainLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        tryTerminate();</span><br><span class="line">        <span class="keyword">return</span> tasks;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isShutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ! isRunning(ctl.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns true if this executor is in the process of terminating</span></span><br><span class="line"><span class="comment">     * after &#123;<span class="doctag">@link</span> #shutdown&#125; or &#123;<span class="doctag">@link</span> #shutdownNow&#125; but has not</span></span><br><span class="line"><span class="comment">     * completely terminated.  This method may be useful for</span></span><br><span class="line"><span class="comment">     * debugging. A return of &#123;<span class="doctag">@code</span> true&#125; reported a sufficient</span></span><br><span class="line"><span class="comment">     * period after shutdown may indicate that submitted tasks have</span></span><br><span class="line"><span class="comment">     * ignored or suppressed interruption, causing this executor not</span></span><br><span class="line"><span class="comment">     * to properly terminate.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if terminating but not yet terminated</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTerminating</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">        <span class="keyword">return</span> ! isRunning(c) &amp;&amp; runStateLessThan(c, TERMINATED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTerminated</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> runStateAtLeast(ctl.get(), TERMINATED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">awaitTermination</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> nanos = unit.toNanos(timeout);</span><br><span class="line">        <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">        mainLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="keyword">if</span> (runStateAtLeast(ctl.get(), TERMINATED))</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">if</span> (nanos &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                nanos = termination.awaitNanos(nanos);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mainLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Invokes &#123;<span class="doctag">@code</span> shutdown&#125; when this executor is no longer</span></span><br><span class="line"><span class="comment">     * referenced and it has no threads.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets the thread factory used to create new threads.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> threadFactory the new thread factory</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if threadFactory is null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #getThreadFactory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setThreadFactory</span><span class="params">(ThreadFactory threadFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (threadFactory == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">this</span>.threadFactory = threadFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the thread factory used to create new threads.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the current thread factory</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #setThreadFactory(ThreadFactory)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ThreadFactory <span class="title">getThreadFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> threadFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets a new handler for unexecutable tasks.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler the new handler</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if handler is null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #getRejectedExecutionHandler</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRejectedExecutionHandler</span><span class="params">(RejectedExecutionHandler handler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (handler == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">this</span>.handler = handler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the current handler for unexecutable tasks.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the current handler</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #setRejectedExecutionHandler(RejectedExecutionHandler)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RejectedExecutionHandler <span class="title">getRejectedExecutionHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> handler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets the core number of threads.  This overrides any value set</span></span><br><span class="line"><span class="comment">     * in the constructor.  If the new value is smaller than the</span></span><br><span class="line"><span class="comment">     * current value, excess existing threads will be terminated when</span></span><br><span class="line"><span class="comment">     * they next become idle.  If larger, new threads will, if needed,</span></span><br><span class="line"><span class="comment">     * be started to execute any queued tasks.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> corePoolSize the new core size</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException if &#123;<span class="doctag">@code</span> corePoolSize &lt; 0&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #getCorePoolSize</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCorePoolSize</span><span class="params">(<span class="keyword">int</span> corePoolSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (corePoolSize &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        <span class="keyword">int</span> delta = corePoolSize - <span class="keyword">this</span>.corePoolSize;</span><br><span class="line">        <span class="keyword">this</span>.corePoolSize = corePoolSize;</span><br><span class="line">        <span class="keyword">if</span> (workerCountOf(ctl.get()) &gt; corePoolSize)</span><br><span class="line">            interruptIdleWorkers();</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (delta &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// We don&#x27;t really know how many new threads are &quot;needed&quot;.</span></span><br><span class="line">            <span class="comment">// As a heuristic, prestart enough new workers (up to new</span></span><br><span class="line">            <span class="comment">// core size) to handle the current number of tasks in</span></span><br><span class="line">            <span class="comment">// queue, but stop if queue becomes empty while doing so.</span></span><br><span class="line">            <span class="keyword">int</span> k = Math.min(delta, workQueue.size());</span><br><span class="line">            <span class="keyword">while</span> (k-- &gt; <span class="number">0</span> &amp;&amp; addWorker(<span class="keyword">null</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (workQueue.isEmpty())</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the core number of threads.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the core number of threads</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #setCorePoolSize</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCorePoolSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> corePoolSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Starts a core thread, causing it to idly wait for work. This</span></span><br><span class="line"><span class="comment">     * overrides the default policy of starting core threads only when</span></span><br><span class="line"><span class="comment">     * new tasks are executed. This method will return &#123;<span class="doctag">@code</span> false&#125;</span></span><br><span class="line"><span class="comment">     * if all core threads have already been started.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if a thread was started</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">prestartCoreThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> workerCountOf(ctl.get()) &lt; corePoolSize &amp;&amp;</span><br><span class="line">            addWorker(<span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Same as prestartCoreThread except arranges that at least one</span></span><br><span class="line"><span class="comment">     * thread is started even if corePoolSize is 0.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ensurePrestart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> wc = workerCountOf(ctl.get());</span><br><span class="line">        <span class="keyword">if</span> (wc &lt; corePoolSize)</span><br><span class="line">            addWorker(<span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (wc == <span class="number">0</span>)</span><br><span class="line">            addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Starts all core threads, causing them to idly wait for work. This</span></span><br><span class="line"><span class="comment">     * overrides the default policy of starting core threads only when</span></span><br><span class="line"><span class="comment">     * new tasks are executed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the number of threads started</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">prestartAllCoreThreads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (addWorker(<span class="keyword">null</span>, <span class="keyword">true</span>))</span><br><span class="line">            ++n;</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns true if this pool allows core threads to time out and</span></span><br><span class="line"><span class="comment">     * terminate if no tasks arrive within the keepAlive time, being</span></span><br><span class="line"><span class="comment">     * replaced if needed when new tasks arrive. When true, the same</span></span><br><span class="line"><span class="comment">     * keep-alive policy applying to non-core threads applies also to</span></span><br><span class="line"><span class="comment">     * core threads. When false (the default), core threads are never</span></span><br><span class="line"><span class="comment">     * terminated due to lack of incoming tasks.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if core threads are allowed to time out,</span></span><br><span class="line"><span class="comment">     *         else &#123;<span class="doctag">@code</span> false&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.6</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">allowsCoreThreadTimeOut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> allowCoreThreadTimeOut;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets the policy governing whether core threads may time out and</span></span><br><span class="line"><span class="comment">     * terminate if no tasks arrive within the keep-alive time, being</span></span><br><span class="line"><span class="comment">     * replaced if needed when new tasks arrive. When false, core</span></span><br><span class="line"><span class="comment">     * threads are never terminated due to lack of incoming</span></span><br><span class="line"><span class="comment">     * tasks. When true, the same keep-alive policy applying to</span></span><br><span class="line"><span class="comment">     * non-core threads applies also to core threads. To avoid</span></span><br><span class="line"><span class="comment">     * continual thread replacement, the keep-alive time must be</span></span><br><span class="line"><span class="comment">     * greater than zero when setting &#123;<span class="doctag">@code</span> true&#125;. This method</span></span><br><span class="line"><span class="comment">     * should in general be called before the pool is actively used.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value &#123;<span class="doctag">@code</span> true&#125; if should time out, else &#123;<span class="doctag">@code</span> false&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException if value is &#123;<span class="doctag">@code</span> true&#125;</span></span><br><span class="line"><span class="comment">     *         and the current keep-alive time is not greater than zero</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.6</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">allowCoreThreadTimeOut</span><span class="params">(<span class="keyword">boolean</span> value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value &amp;&amp; keepAliveTime &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Core threads must have nonzero keep alive times&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (value != allowCoreThreadTimeOut) &#123;</span><br><span class="line">            allowCoreThreadTimeOut = value;</span><br><span class="line">            <span class="keyword">if</span> (value)</span><br><span class="line">                interruptIdleWorkers();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets the maximum allowed number of threads. This overrides any</span></span><br><span class="line"><span class="comment">     * value set in the constructor. If the new value is smaller than</span></span><br><span class="line"><span class="comment">     * the current value, excess existing threads will be</span></span><br><span class="line"><span class="comment">     * terminated when they next become idle.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> maximumPoolSize the new maximum</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException if the new maximum is</span></span><br><span class="line"><span class="comment">     *         less than or equal to zero, or</span></span><br><span class="line"><span class="comment">     *         less than the &#123;<span class="doctag">@linkplain</span> #getCorePoolSize core pool size&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #getMaximumPoolSize</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMaximumPoolSize</span><span class="params">(<span class="keyword">int</span> maximumPoolSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (maximumPoolSize &lt;= <span class="number">0</span> || maximumPoolSize &lt; corePoolSize)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        <span class="keyword">this</span>.maximumPoolSize = maximumPoolSize;</span><br><span class="line">        <span class="keyword">if</span> (workerCountOf(ctl.get()) &gt; maximumPoolSize)</span><br><span class="line">            interruptIdleWorkers();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the maximum allowed number of threads.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the maximum allowed number of threads</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #setMaximumPoolSize</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMaximumPoolSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> maximumPoolSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets the time limit for which threads may remain idle before</span></span><br><span class="line"><span class="comment">     * being terminated.  If there are more than the core number of</span></span><br><span class="line"><span class="comment">     * threads currently in the pool, after waiting this amount of</span></span><br><span class="line"><span class="comment">     * time without processing a task, excess threads will be</span></span><br><span class="line"><span class="comment">     * terminated.  This overrides any value set in the constructor.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time the time to wait.  A time value of zero will cause</span></span><br><span class="line"><span class="comment">     *        excess threads to terminate immediately after executing tasks.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unit the time unit of the &#123;<span class="doctag">@code</span> time&#125; argument</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException if &#123;<span class="doctag">@code</span> time&#125; less than zero or</span></span><br><span class="line"><span class="comment">     *         if &#123;<span class="doctag">@code</span> time&#125; is zero and &#123;<span class="doctag">@code</span> allowsCoreThreadTimeOut&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #getKeepAliveTime(TimeUnit)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setKeepAliveTime</span><span class="params">(<span class="keyword">long</span> time, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (time &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        <span class="keyword">if</span> (time == <span class="number">0</span> &amp;&amp; allowsCoreThreadTimeOut())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Core threads must have nonzero keep alive times&quot;</span>);</span><br><span class="line">        <span class="keyword">long</span> keepAliveTime = unit.toNanos(time);</span><br><span class="line">        <span class="keyword">long</span> delta = keepAliveTime - <span class="keyword">this</span>.keepAliveTime;</span><br><span class="line">        <span class="keyword">this</span>.keepAliveTime = keepAliveTime;</span><br><span class="line">        <span class="keyword">if</span> (delta &lt; <span class="number">0</span>)</span><br><span class="line">            interruptIdleWorkers();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the thread keep-alive time, which is the amount of time</span></span><br><span class="line"><span class="comment">     * that threads in excess of the core pool size may remain</span></span><br><span class="line"><span class="comment">     * idle before being terminated.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unit the desired time unit of the result</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the time limit</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #setKeepAliveTime(long, TimeUnit)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getKeepAliveTime</span><span class="params">(TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> unit.convert(keepAliveTime, TimeUnit.NANOSECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* User-level queue utilities */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the task queue used by this executor. Access to the</span></span><br><span class="line"><span class="comment">     * task queue is intended primarily for debugging and monitoring.</span></span><br><span class="line"><span class="comment">     * This queue may be in active use.  Retrieving the task queue</span></span><br><span class="line"><span class="comment">     * does not prevent queued tasks from executing.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the task queue</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BlockingQueue&lt;Runnable&gt; <span class="title">getQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> workQueue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Removes this task from the executor&#x27;s internal queue if it is</span></span><br><span class="line"><span class="comment">     * present, thus causing it not to be run if it has not already</span></span><br><span class="line"><span class="comment">     * started.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;This method may be useful as one part of a cancellation</span></span><br><span class="line"><span class="comment">     * scheme.  It may fail to remove tasks that have been converted</span></span><br><span class="line"><span class="comment">     * into other forms before being placed on the internal queue. For</span></span><br><span class="line"><span class="comment">     * example, a task entered using &#123;<span class="doctag">@code</span> submit&#125; might be</span></span><br><span class="line"><span class="comment">     * converted into a form that maintains &#123;<span class="doctag">@code</span> Future&#125; status.</span></span><br><span class="line"><span class="comment">     * However, in such cases, method &#123;<span class="doctag">@link</span> #purge&#125; may be used to</span></span><br><span class="line"><span class="comment">     * remove those Futures that have been cancelled.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> task the task to remove</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if the task was removed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Runnable task)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> removed = workQueue.remove(task);</span><br><span class="line">        tryTerminate(); <span class="comment">// In case SHUTDOWN and now empty</span></span><br><span class="line">        <span class="keyword">return</span> removed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Tries to remove from the work queue all &#123;<span class="doctag">@link</span> Future&#125;</span></span><br><span class="line"><span class="comment">     * tasks that have been cancelled. This method can be useful as a</span></span><br><span class="line"><span class="comment">     * storage reclamation operation, that has no other impact on</span></span><br><span class="line"><span class="comment">     * functionality. Cancelled tasks are never executed, but may</span></span><br><span class="line"><span class="comment">     * accumulate in work queues until worker threads can actively</span></span><br><span class="line"><span class="comment">     * remove them. Invoking this method instead tries to remove them now.</span></span><br><span class="line"><span class="comment">     * However, this method may fail to remove tasks in</span></span><br><span class="line"><span class="comment">     * the presence of interference by other threads.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">purge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; q = workQueue;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Iterator&lt;Runnable&gt; it = q.iterator();</span><br><span class="line">            <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                Runnable r = it.next();</span><br><span class="line">                <span class="keyword">if</span> (r <span class="keyword">instanceof</span> Future&lt;?&gt; &amp;&amp; ((Future&lt;?&gt;)r).isCancelled())</span><br><span class="line">                    it.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ConcurrentModificationException fallThrough) &#123;</span><br><span class="line">            <span class="comment">// Take slow path if we encounter interference during traversal.</span></span><br><span class="line">            <span class="comment">// Make copy for traversal and call remove for cancelled entries.</span></span><br><span class="line">            <span class="comment">// The slow path is more likely to be O(N*N).</span></span><br><span class="line">            <span class="keyword">for</span> (Object r : q.toArray())</span><br><span class="line">                <span class="keyword">if</span> (r <span class="keyword">instanceof</span> Future&lt;?&gt; &amp;&amp; ((Future&lt;?&gt;)r).isCancelled())</span><br><span class="line">                    q.remove(r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        tryTerminate(); <span class="comment">// In case SHUTDOWN and now empty</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Statistics */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the current number of threads in the pool.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the number of threads</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPoolSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">        mainLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Remove rare and surprising possibility of</span></span><br><span class="line">            <span class="comment">// isTerminated() &amp;&amp; getPoolSize() &gt; 0</span></span><br><span class="line">            <span class="keyword">return</span> runStateAtLeast(ctl.get(), TIDYING) ? <span class="number">0</span></span><br><span class="line">                : workers.size();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mainLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the approximate number of threads that are actively</span></span><br><span class="line"><span class="comment">     * executing tasks.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the number of threads</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getActiveCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">        mainLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> n = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (Worker w : workers)</span><br><span class="line">                <span class="keyword">if</span> (w.isLocked())</span><br><span class="line">                    ++n;</span><br><span class="line">            <span class="keyword">return</span> n;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mainLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the largest number of threads that have ever</span></span><br><span class="line"><span class="comment">     * simultaneously been in the pool.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the number of threads</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getLargestPoolSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">        mainLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> largestPoolSize;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mainLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the approximate total number of tasks that have ever been</span></span><br><span class="line"><span class="comment">     * scheduled for execution. Because the states of tasks and</span></span><br><span class="line"><span class="comment">     * threads may change dynamically during computation, the returned</span></span><br><span class="line"><span class="comment">     * value is only an approximation.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the number of tasks</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getTaskCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">        mainLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">long</span> n = completedTaskCount;</span><br><span class="line">            <span class="keyword">for</span> (Worker w : workers) &#123;</span><br><span class="line">                n += w.completedTasks;</span><br><span class="line">                <span class="keyword">if</span> (w.isLocked())</span><br><span class="line">                    ++n;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> n + workQueue.size();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mainLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the approximate total number of tasks that have</span></span><br><span class="line"><span class="comment">     * completed execution. Because the states of tasks and threads</span></span><br><span class="line"><span class="comment">     * may change dynamically during computation, the returned value</span></span><br><span class="line"><span class="comment">     * is only an approximation, but one that does not ever decrease</span></span><br><span class="line"><span class="comment">     * across successive calls.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the number of tasks</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getCompletedTaskCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">        mainLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">long</span> n = completedTaskCount;</span><br><span class="line">            <span class="keyword">for</span> (Worker w : workers)</span><br><span class="line">                n += w.completedTasks;</span><br><span class="line">            <span class="keyword">return</span> n;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mainLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a string identifying this pool, as well as its state,</span></span><br><span class="line"><span class="comment">     * including indications of run state and estimated worker and</span></span><br><span class="line"><span class="comment">     * task counts.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> a string identifying this pool, as well as its state</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> ncompleted;</span><br><span class="line">        <span class="keyword">int</span> nworkers, nactive;</span><br><span class="line">        <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">        mainLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ncompleted = completedTaskCount;</span><br><span class="line">            nactive = <span class="number">0</span>;</span><br><span class="line">            nworkers = workers.size();</span><br><span class="line">            <span class="keyword">for</span> (Worker w : workers) &#123;</span><br><span class="line">                ncompleted += w.completedTasks;</span><br><span class="line">                <span class="keyword">if</span> (w.isLocked())</span><br><span class="line">                    ++nactive;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mainLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">        String rs = (runStateLessThan(c, SHUTDOWN) ? <span class="string">&quot;Running&quot;</span> :</span><br><span class="line">                     (runStateAtLeast(c, TERMINATED) ? <span class="string">&quot;Terminated&quot;</span> :</span><br><span class="line">                      <span class="string">&quot;Shutting down&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.toString() +</span><br><span class="line">            <span class="string">&quot;[&quot;</span> + rs +</span><br><span class="line">            <span class="string">&quot;, pool size = &quot;</span> + nworkers +</span><br><span class="line">            <span class="string">&quot;, active threads = &quot;</span> + nactive +</span><br><span class="line">            <span class="string">&quot;, queued tasks = &quot;</span> + workQueue.size() +</span><br><span class="line">            <span class="string">&quot;, completed tasks = &quot;</span> + ncompleted +</span><br><span class="line">            <span class="string">&quot;]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Extension hooks */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Method invoked prior to executing the given Runnable in the</span></span><br><span class="line"><span class="comment">     * given thread.  This method is invoked by thread &#123;<span class="doctag">@code</span> t&#125; that</span></span><br><span class="line"><span class="comment">     * will execute task &#123;<span class="doctag">@code</span> r&#125;, and may be used to re-initialize</span></span><br><span class="line"><span class="comment">     * ThreadLocals, or to perform logging.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;This implementation does nothing, but may be customized in</span></span><br><span class="line"><span class="comment">     * subclasses. Note: To properly nest multiple overridings, subclasses</span></span><br><span class="line"><span class="comment">     * should generally invoke &#123;<span class="doctag">@code</span> super.beforeExecute&#125; at the end of</span></span><br><span class="line"><span class="comment">     * this method.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t the thread that will run task &#123;<span class="doctag">@code</span> r&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> r the task that will be executed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeExecute</span><span class="params">(Thread t, Runnable r)</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Method invoked upon completion of execution of the given Runnable.</span></span><br><span class="line"><span class="comment">     * This method is invoked by the thread that executed the task. If</span></span><br><span class="line"><span class="comment">     * non-null, the Throwable is the uncaught &#123;<span class="doctag">@code</span> RuntimeException&#125;</span></span><br><span class="line"><span class="comment">     * or &#123;<span class="doctag">@code</span> Error&#125; that caused execution to terminate abruptly.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;This implementation does nothing, but may be customized in</span></span><br><span class="line"><span class="comment">     * subclasses. Note: To properly nest multiple overridings, subclasses</span></span><br><span class="line"><span class="comment">     * should generally invoke &#123;<span class="doctag">@code</span> super.afterExecute&#125; at the</span></span><br><span class="line"><span class="comment">     * beginning of this method.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;&lt;b&gt;Note:&lt;/b&gt; When actions are enclosed in tasks (such as</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> FutureTask&#125;) either explicitly or via methods such as</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> submit&#125;, these task objects catch and maintain</span></span><br><span class="line"><span class="comment">     * computational exceptions, and so they do not cause abrupt</span></span><br><span class="line"><span class="comment">     * termination, and the internal exceptions are &lt;em&gt;not&lt;/em&gt;</span></span><br><span class="line"><span class="comment">     * passed to this method. If you would like to trap both kinds of</span></span><br><span class="line"><span class="comment">     * failures in this method, you can further probe for such cases,</span></span><br><span class="line"><span class="comment">     * as in this sample subclass that prints either the direct cause</span></span><br><span class="line"><span class="comment">     * or the underlying exception if a task has been aborted:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *  &lt;pre&gt; &#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment">     * class ExtendedExecutor extends ThreadPoolExecutor &#123;</span></span><br><span class="line"><span class="comment">     *   // ...</span></span><br><span class="line"><span class="comment">     *   protected void afterExecute(Runnable r, Throwable t) &#123;</span></span><br><span class="line"><span class="comment">     *     super.afterExecute(r, t);</span></span><br><span class="line"><span class="comment">     *     if (t == null &amp;&amp; r instanceof Future&lt;?&gt;) &#123;</span></span><br><span class="line"><span class="comment">     *       try &#123;</span></span><br><span class="line"><span class="comment">     *         Object result = ((Future&lt;?&gt;) r).get();</span></span><br><span class="line"><span class="comment">     *       &#125; catch (CancellationException ce) &#123;</span></span><br><span class="line"><span class="comment">     *           t = ce;</span></span><br><span class="line"><span class="comment">     *       &#125; catch (ExecutionException ee) &#123;</span></span><br><span class="line"><span class="comment">     *           t = ee.getCause();</span></span><br><span class="line"><span class="comment">     *       &#125; catch (InterruptedException ie) &#123;</span></span><br><span class="line"><span class="comment">     *           Thread.currentThread().interrupt(); // ignore/reset</span></span><br><span class="line"><span class="comment">     *       &#125;</span></span><br><span class="line"><span class="comment">     *     &#125;</span></span><br><span class="line"><span class="comment">     *     if (t != null)</span></span><br><span class="line"><span class="comment">     *       System.out.println(t);</span></span><br><span class="line"><span class="comment">     *   &#125;</span></span><br><span class="line"><span class="comment">     * &#125;&#125;&lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> r the runnable that has completed</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t the exception that caused termination, or null if</span></span><br><span class="line"><span class="comment">     * execution completed normally</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterExecute</span><span class="params">(Runnable r, Throwable t)</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Method invoked when the Executor has terminated.  Default</span></span><br><span class="line"><span class="comment">     * implementation does nothing. Note: To properly nest multiple</span></span><br><span class="line"><span class="comment">     * overridings, subclasses should generally invoke</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> super.terminated&#125; within this method.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">terminated</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Predefined RejectedExecutionHandlers */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A handler for rejected tasks that runs the rejected task</span></span><br><span class="line"><span class="comment">     * directly in the calling thread of the &#123;<span class="doctag">@code</span> execute&#125; method,</span></span><br><span class="line"><span class="comment">     * unless the executor has been shut down, in which case the task</span></span><br><span class="line"><span class="comment">     * is discarded.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CallerRunsPolicy</span> <span class="keyword">implements</span> <span class="title">RejectedExecutionHandler</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Creates a &#123;<span class="doctag">@code</span> CallerRunsPolicy&#125;.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CallerRunsPolicy</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Executes task r in the caller&#x27;s thread, unless the executor</span></span><br><span class="line"><span class="comment">         * has been shut down, in which case the task is discarded.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> r the runnable task requested to be executed</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> e the executor attempting to execute this task</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!e.isShutdown()) &#123;</span><br><span class="line">                r.run();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A handler for rejected tasks that throws a</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> RejectedExecutionException&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AbortPolicy</span> <span class="keyword">implements</span> <span class="title">RejectedExecutionHandler</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Creates an &#123;<span class="doctag">@code</span> AbortPolicy&#125;.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AbortPolicy</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Always throws RejectedExecutionException.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> r the runnable task requested to be executed</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> e the executor attempting to execute this task</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> RejectedExecutionException always</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RejectedExecutionException(<span class="string">&quot;Task &quot;</span> + r.toString() +</span><br><span class="line">                                                 <span class="string">&quot; rejected from &quot;</span> +</span><br><span class="line">                                                 e.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A handler for rejected tasks that silently discards the</span></span><br><span class="line"><span class="comment">     * rejected task.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscardPolicy</span> <span class="keyword">implements</span> <span class="title">RejectedExecutionHandler</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Creates a &#123;<span class="doctag">@code</span> DiscardPolicy&#125;.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DiscardPolicy</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Does nothing, which has the effect of discarding task r.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> r the runnable task requested to be executed</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> e the executor attempting to execute this task</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A handler for rejected tasks that discards the oldest unhandled</span></span><br><span class="line"><span class="comment">     * request and then retries &#123;<span class="doctag">@code</span> execute&#125;, unless the executor</span></span><br><span class="line"><span class="comment">     * is shut down, in which case the task is discarded.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscardOldestPolicy</span> <span class="keyword">implements</span> <span class="title">RejectedExecutionHandler</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Creates a &#123;<span class="doctag">@code</span> DiscardOldestPolicy&#125; for the given executor.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DiscardOldestPolicy</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Obtains and ignores the next task that the executor</span></span><br><span class="line"><span class="comment">         * would otherwise execute, if one is immediately available,</span></span><br><span class="line"><span class="comment">         * and then retries execution of task r, unless the executor</span></span><br><span class="line"><span class="comment">         * is shut down, in which case task r is instead discarded.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> r the runnable task requested to be executed</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> e the executor attempting to execute this task</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!e.isShutdown()) &#123;</span><br><span class="line">                e.getQueue().poll();</span><br><span class="line">                e.execute(r);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/java/">java</a>
                
                    <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">多线程</a>
                
            </div>
        
    </section>
</article>

    </div>
  
    <div class='post-wrapper'>
      <article class="post reveal">
    <section class="meta">
        
            <h2 class="title">
                <a href="/2015/09/12/JAVA%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B8%80/">
                    设计模式分类
                </a>
            </h2>
        
        <time>
            9月 12, 2015
        </time>
        
    
    <div class='cats'>
        <a href="/categories/%E6%8A%80%E6%9C%AF/">技术</a>
    </div>

    </section>
    <section class="article typo">
        <blockquote>
<p>平时工作代码进行重构时也会涉及到设计模式，另外在看一些开源框架时也会涉及到很多的设计模式。只是平时没有太全面的了解，最近面试时有同事问汲到这里，所以在这里整理以备将来随时查看。<br>这里我举一个最容易理解的例子来解释每种设计模式<br>首先看一下设计模式的分类及关系 </p>
</blockquote>
<img  src='/images/pattern/pattern.png' class='col-xs-12 thumbnail'/>

<p>它们之间的关系如图：<br><img  src='/images/pattern/relation.png' class='col-xs-12 thumbnail'/></p>
<p>##创建型模式<br>这六个模式都是与创建对象相关的</p>
<ul>
<li>简单工厂模式（Simple Factory）；</li>
<li>工厂方法模式（Factory Method）；</li>
<li>抽象工厂模式（Abstract Factory）；</li>
<li>创建者模式（Builder）；</li>
<li>原型模式（Prototype）；</li>
<li>单例模式（Singleton）；</li>
</ul>
<p>##结构型模式</p>
<p>创建对象后，对象与对象之间的依赖关系，设计好了会为后续代码的维护带来很大的方便。</p>
<ul>
<li>外观模式（Facade）；</li>
<li>适配器模式（Adapter）；</li>
<li>代理模式（Proxy）；</li>
<li>装饰模式（Decorator）；</li>
<li>桥模式（Bridge）；</li>
<li>组合模式（Composite）；</li>
<li>享元模式（Flyweight）</li>
</ul>
<p>##行为型模式</p>
<p>对象的创建和结构定义好后，就是他们的行为的设计了。<br>模板方法模式（Template Method）；</p>
<ul>
<li>观察者模式（Observer）；</li>
<li>状态模式（State）；</li>
<li>策略模式（Strategy）；</li>
<li>职责链模式（Chain of Responsibility）；</li>
<li>命令模式（Command）；</li>
<li>访问者模式（Visitor）；</li>
<li>调停者模式（Mediator）；</li>
<li>备忘录模式（Memento）；</li>
<li>迭代器模式（Iterator）；</li>
<li>解释器模式（Interpreter）</li>
</ul>


        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/java/">java</a>
                
                    <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a>
                
            </div>
        
    </section>
</article>

    </div>
  
    <div class='post-wrapper'>
      <article class="post reveal">
    <section class="meta">
        
            <h2 class="title">
                <a href="/2015/09/10/%E6%88%91%E7%9A%84%E4%B9%A6%E6%9E%B6/">
                    个人书架
                </a>
            </h2>
        
        <time>
            9月 10, 2015
        </time>
        
    
    <div class='cats'>
        <a href="/categories/%E4%B9%A6%E6%9E%B6/">书架</a>
    </div>

    </section>
    <section class="article typo">
        <h3 id="最近在看的书籍："><a href="#最近在看的书籍：" class="headerlink" title="最近在看的书籍："></a>最近在看的书籍：</h3><ul>
<li>2020.09.23 <a target="_blank" rel="noopener" href="https://github.com/Vonng/ddia">《设计数据密集型应用》</a></li>
</ul>
<h3 id="曾经看过的书籍："><a href="#曾经看过的书籍：" class="headerlink" title="曾经看过的书籍："></a>曾经看过的书籍：</h3><h4 id="工具类技术书籍"><a href="#工具类技术书籍" class="headerlink" title="工具类技术书籍"></a>工具类技术书籍</h4><ul>
<li>《Developing an ionic Edge》</li>
<li>《Angular JS权威教程》(Ari Lerner)</li>
<li>《O’Reilly：Python学习手册（第4版）》</li>
<li>《Python Cookbook（第3版）中文版》</li>
<li>《Vim使用技巧》</li>
<li>《JAVA编程思想》</li>
<li>《JAVA并发编程实战》</li>
<li>《Java JDK 7学习笔记》</li>
<li><a target="_blank" rel="noopener" href="http://search.dangdang.com/?key=%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%C4%A3%CA%BD">《大话设计模式（交互启发式教学 谈笑间详解设计模式 让你爱不释手）》</a> 程杰　著 </li>
<li><a target="_blank" rel="noopener" href="http://product.dangdang.com/9349959.html">《精通CSS+DIV网页样式布局》</a>前沿科技 编著</li>
</ul>
<h4 id="业务专业相关"><a href="#业务专业相关" class="headerlink" title="业务专业相关"></a>业务专业相关</h4><ul>
<li>《流程优化与再造》</li>
</ul>
<h4 id="思维构建相关"><a href="#思维构建相关" class="headerlink" title="思维构建相关"></a>思维构建相关</h4><ul>
<li>《黑客与画家》</li>
<li>《大教堂与集市》</li>
<li>《重来》</li>
<li>《启示录 打造用户喜爱的产品》Marty Cagan著 七印部落 译</li>
<li><a target="_blank" rel="noopener" href="http://search.dangdang.com/?key=%EF%BF%BD%EF%BF%BD0%EF%BF%BD%EF%BF%BD1">《从0到1：开启商业与未来的秘密》</a>【美】彼得 蒂尔 Peter Thiel</li>
<li><a target="_blank" rel="noopener" href="http://product.dangdang.com/23734636.html">《重构 改善既有代码的设计》</a> 【美】Martin Fowler　著，熊节　译</li>
<li><a target="_blank" rel="noopener" href="http://product.dangdang.com/22722790.html">《JavaScript权威指南（第6版）》</a>（美）弗兰纳根　著,淘宝前端团队　译</li>
<li><a target="_blank" rel="noopener" href="http://product.dangdang.com/20848036.html">《干法》</a> 【日】稻盛和夫　著，曹岫云　译　</li>
<li><a target="_blank" rel="noopener" href="http://product.dangdang.com/21032154.html">《失控》</a> 凯文凯利　著，东西文库　译</li>
</ul>
<h4 id="生活向导"><a href="#生活向导" class="headerlink" title="生活向导"></a>生活向导</h4><ul>
<li>《平凡的世界》(路遥)</li>
<li>《尼古拉.特斯拉传》(Steve Law)</li>
</ul>
<h3 id="要看的书籍"><a href="#要看的书籍" class="headerlink" title="要看的书籍"></a>要看的书籍</h3><ul>
<li><a target="_blank" rel="noopener" href="http://www.amazon.cn/%E9%9B%86%E8%A3%85%E7%AE%B1%E6%94%B9%E5%8F%98%E4%B8%96%E7%95%8C-%E9%A9%AC%E5%85%8B%C2%B7%E8%8E%B1%E6%96%87%E6%A3%AE/dp/B00HE1PK58/ref=sr_1_1?s=books&ie=UTF8&qid=1442883290&sr=1-1&keywords=%E9%9B%86%E8%A3%85%E7%AE%B1%E6%94%B9%E5%8F%98%E4%B8%96%E7%95%8C">《集装箱改变世界》</a> <blockquote>
<p>本书从集装箱的发明史娓娓道来，将一个看似平凡的主题衍变成一个个非同寻常的有趣故事，展现了一项技术的进步是如何改变世界经济形态的。它的价值不在于是什么，而在于怎样使用。在集装箱出现之前，美国的沃尔玛、法国的成衣绝对不会遍地开花。而在集装箱出现之后，货运变得如此便宜，以至于某件产品产自东半球，运至纽约销售，远比在纽约近郊生产该产品来得划算。中国也从此登上国际集装箱海运和世界工厂的舞台。读者在享受阅读的同时，还会有趣地发现，即便是一个简单的创新，也会彻底改变我们的生活</p>
</blockquote>
</li>
</ul>


        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/book/">book</a>
                
            </div>
        
    </section>
</article>

    </div>
  
    <div class='post-wrapper'>
      <article class="post reveal">
    <section class="meta">
        
            <h2 class="title">
                <a href="/2015/09/06/Linux%20sed%E5%91%BD%E4%BB%A4%E4%B8%8Eawk%E5%91%BD%E4%BB%A4/">
                    sed,awk
                </a>
            </h2>
        
        <time>
            9月 6, 2015
        </time>
        
    
    <div class='cats'>
        <a href="/categories/%E6%89%A9%E5%B1%95%E7%9F%A5%E8%AF%86/">扩展知识</a>, <a href="/categories/%E6%89%A9%E5%B1%95%E7%9F%A5%E8%AF%86/linux/">linux</a>
    </div>

    </section>
    <section class="article typo">
        <p>Linux shell编程从初学到精通 </p>
<blockquote>
<p>最近工作时遇到了一个问题，就是查看进行时，只查看某些进行的进程号，若直接用ps aux|grep sms  这样会得到一大堆的东东，所以同事推荐用awk,同<br>时也提及了sed。</p>
</blockquote>
<blockquote>
<p>这里抽时间对这两个命令做一个总结，仅为个人学习工作所用。</p>
</blockquote>
<p>##sed、awk是什么？</p>
<pre><code>它们是linux\unix系统中的两种功能强大的文本处理工具。</code></pre>
<ul>
<li>有一个sed的编辑器，才有了sed（stream editor）这个名字,它是一个将一系列编辑命令作用于一个文本文件的理想工具。</li>
<li>由于创建awk的三个作者名称 是Aho、Weinberger和Kernighan，所以得名为AWK,是一种能够对结构化数据进行操作并产生格式化报表的编程语言。</li>
</ul>
<p>##sed的使用</p>
<p>###使用场合</p>
<ul>
<li>编辑相对交互式广西编辑器而言太大的文件</li>
<li>编辑命令太复杂，在交互式文本编辑器中难以输入的情况</li>
<li>对文件扫描一遍，但是需要执行多个编辑函数的情况</li>
</ul>
<p>sed只对缓冲区中的原始文件的副本进行编辑，并不编辑原始的文件。so，若要保存个性后的文件，压根将输出重定向到另一个文件。如：</p>
<pre><code>sed &#39;sed command&#39; source-file &gt; target-file</code></pre>
<p>###调用方式<br><code>如何没有指定输入文件sed将从标准输入中接受输入</code></p>
<ul>
<li><p>在shell命令行输入命令调用sed，格式为：</p>
<p>  sed [option] ‘sed command’ 输入文件<br><code>注意此处为单引号将命令引起来</code></p>
</li>
<li><p>将sed命令插入脚本文件后，然后通过sed命令调用它，格式为：</p>
<p>  sed [option] -f sed脚本文件 输入文件</p>
</li>
<li><p>将sed命令插入脚本文件后，最常用的方法是设置该脚本文件为可执行，然后直接执行该脚本，格式为：</p>
<p>  ./sed脚本文件 输入文件</p>
</li>
</ul>
<p><code>但此命令脚本文件，应该以sha-bang(#!)开头，sha-bang后面是解析这个脚本的程序名。</code></p>
<p>####sed命令选项及其意义</p>
<ul>
<li>-n:不打印所有行到标准输出</li>
<li>-e:将下一个字符串解析为sed编辑命令，如果只传递一个编辑命令给sed，-e选项可以省略</li>
<li>-f:表示正在调用sed脚本文件</li>
</ul>
<p>###命令组成方式</p>
<pre><code>定位文本行和编辑命令两部分组成</code></pre>
<p>####定位文本</p>
<ul>
<li>使用行号，指定一行，或指定行号范围</li>
<li>使用正则表达式</li>
</ul>
<p><code>下面是sed命令定位文本的方法</code></p>
<ul>
<li>x 为指定的行号</li>
<li>x，y 指定行号范围</li>
<li>/pattern/ 查询包含模式的行</li>
<li>/pattern/pattern/ 查询包含两个模式的行</li>
<li>/pattern/，x 从与模式匹配到x号行之间的行  反之类似</li>
<li>x，y！查询不包括x和y行号的行</li>
</ul>
<p>####常用编辑命令</p>
<ul>
<li>p 打印匹配行</li>
<li>= 打印文件行号</li>
<li>a\ 在定位行号之后追加文本信息</li>
<li>i\ 在定们行号之前插入文本信息</li>
<li>d 删除定位行</li>
<li>c\ 用新文本替换定位文本</li>
<li>s 使用替换模式替换相应模式</li>
<li>r 从另一个文件中读广西</li>
<li>w 将文本写入到一个文件</li>
<li>y 变换字符</li>
<li>q 第一个模式匹配完成后退出</li>
<li>l 显示与八进制ASCII码等价的控制字符</li>
<li>{} 在定位行执行的命令组</li>
<li>n 读取下一个输入行，用下一个命令处理新的行</li>
<li>h 将模式缓冲区的文本复制到保持缓冲区</li>
<li>H 将模式缓冲区的文本追加到保持缓冲区</li>
<li>x 互换模式缓冲区和保持缓冲区的内容</li>
<li>g 将保持缓冲区的内容复制到模式缓冲区</li>
<li>G 将保持缓冲区的内容追加到模式缓冲区</li>
</ul>
<p>###实例<br>我们就用下面这个文件内容作为事例参考：</p>
<pre><code>#!/usr/bin/env python
import os
import sys

if __name__ == &quot;__main__&quot;:
    os.environ.setdefault(&quot;DJANGO_SETTINGS_MODULE&quot;, &quot;test.settings&quot;)

    from django.core.management import execute_from_command_line

    execute_from_command_line(sys.argv)</code></pre>
<h4 id="n-选项的使用"><a href="#n-选项的使用" class="headerlink" title="-n 选项的使用"></a>-n 选项的使用</h4><ul>
<li>使用-n 不输出所有的内容  1p 输出第一行</li>
</ul>
<pre><code>➜  linuxstudy  sed -n &#39;1p&#39; manage.py2
#!/usr/bin/env python</code></pre>
<ul>
<li>打印3到6行</li>
</ul>
<pre><code>➜  linuxstudy  sed -n &#39;3,6p&#39; manage.py2
import sys

if __name__ == &quot;__main__&quot;:
    os.environ.setdefault(&quot;DJANGO_SETTINGS_MODULE&quot;, &quot;test.settings&quot;)</code></pre>
<ul>
<li>模式匹配</li>
</ul>
<pre><code>➜  linuxstudy  sed -n &#39;/environ/p&#39; manage.py2
    os.environ.setdefault(&quot;DJANGO_SETTINGS_MODULE&quot;, &quot;test.settings&quot;)</code></pre>
<h4 id="e-选项的使用"><a href="#e-选项的使用" class="headerlink" title="- e 选项的使用"></a>- e 选项的使用</h4><ul>
<li>打印行号：</li>
</ul>
<pre><code>    ➜  linuxstudy  sed -n &#39;/env/=&#39; manage.py2
    1
    6

添加e选项：

    ➜  linuxstudy  sed -n -e &#39;/env/p&#39; -e &#39;/env/=&#39; manage.py2 
    #!/usr/bin/env python
    1
        os.environ.setdefault(&quot;DJANGO_SETTINGS_MODULE&quot;, &quot;test.settings&quot;)
    6

    `sed不支持多个编辑命令的用法，带多个编辑命令的用法，一般格式为：`

    sed [option] -e 编辑命令 -e 编辑命令 ... -e 编辑命令 输入文件

    将下面命令操作存放到一个后缀为.sed的文件中，让其可执行
    #!/usr/bin/sed -f 
    /command/a\
    we append a new line</code></pre>
<h4 id="sed文本定位"><a href="#sed文本定位" class="headerlink" title="sed文本定位"></a>sed文本定位</h4><ul>
<li>匹配元字符 $和.</li>
</ul>
<pre><code>    ➜  linuxstudy  sed -n &#39;/\./p&#39; manage.py2
        os.environ.setdefault(&quot;DJANGO_SETTINGS_MODULE&quot;, &quot;test.settings&quot;)
        from django$.core.management import execute_from_command_line
        execute_from_command_line(sys.argv)
    ➜  linuxstudy  sed -n &#39;/\$/p&#39; manage.py2
        from django$.core.management import execute_from_command_line</code></pre>
<ul>
<li>元字符进行匹配</li>
</ul>
<pre><code>    $在正则中表示行尾，但在这里表示最后一行
    sed的基本命令，可以放在单引号外或内都行，根据自己的习惯
    ➜  linuxstudy  sed  &#39;$p&#39; manage.py2 得取最后一行

    ➜  linuxstudy sed  -n &#39;/.*line/p&#39; manage.py2 找出以line结尾的行</code></pre>
<ul>
<li><p>! 符号，表示取反，但是不能用于模式匹配的取反</p>
<pre><code>  ➜  linuxstudy  sed -n &#39;2,4!p&#39; manage.py2 不打印2到4行 </code></pre>
</li>
<li><p>使用行号与关键字匹配限定行范围</p>
<pre><code>  /pattern/,x和x,/pattern/ 这两种形式其实与x,y一样的，只是将x或y代替罢了

  ➜  linuxstudy  sed -n &#39;4,/mana/p&#39; manage.py2  得到的是从第四行起到与mana匹配的行的内容

  if __name__ == &quot;__main__&quot;:
      os.environ.setdefault(&quot;DJANGO_SETTINGS_MODULE&quot;, &quot;hwbuluo.settings&quot;)

      from django$.core.management import execute_from_command_line</code></pre>
</li>
</ul>
<h4 id="sed文本编辑"><a href="#sed文本编辑" class="headerlink" title="sed文本编辑"></a>sed文本编辑</h4><ul>
<li><p>插入文本    i\</p>
<pre><code>  在匹配行的前端插入
  sed &#39;定位i\text&#39; 文件

  修改上面的追加脚本：
  #!/usr/bin/sed -f 
  /command/i\
  we append a new line</code></pre>
</li>
<li><p>修改文本 modify.sed    c\</p>
<pre><code>  -------------------
  #!/usr/bin/sed -f

  /command/c\
  I modify the file.
  -------------------

  执行：./modify.sed</code></pre>
</li>
<li><p>删除文本  d  与追加和插入修改有所不同，这里在后面不需要添加\</p>
<pre><code>  sed &#39;1,3d&#39; manage.py2</code></pre>
</li>
<li><p>替换文本 替换文本与修改文本类似，只是修改是对一整行的个性，替换则是对局部进行修改</p>
<pre><code>  s/被替换的字符串/新字符串/[替换选项]

  替换选项及意义：
      g:替换文本中所有出现被替换字符串之处,若不使用此选项，则只替换每行的第一个匹配上的字符串
      p:与-n选项结合，只打印替换行
      w 文件名:表示将输出定向到一个文件

  ➜  linuxstudy  sed -n &#39;s/command/============/p&#39; manage.py2 
      from django$.core.management import execute_from_============_line
      execute_from_============_line(sys.argv)

  也可以 linuxstudy  sed -n &#39;s/command/============/2p&#39; manage.py2   来替换每行出现的第几个 </code></pre>
</li>
</ul>
<ul>
<li></li>
</ul>
<p>##<a target="_blank" rel="noopener" href="http://www.cnblogs.com/chengmo/archive/2010/10/08/1845913.html">awk的使用</a></p>
<p>###使用场合<br>###调用方式<br>###实例</p>
<pre><code>awk -F &#39;:&#39; &#39;BEGIN &#123;count=0;&#125; &#123;name[count] = $1;count++;&#125;;END &#123;for (i=0;i&lt;NR;i++) print i,name[i]&#125;&#39;   /etc/passwd

0 root
1 daemon
2 bin
3 sys
4 sync
5 games
6 man
7 lp
8 mail

ls -l |awk &#39;BEGIN &#123;size=0;&#125; &#123;size=size+$5;&#125; END&#123;print &quot;[end]size is&quot;,size/1024/1024 ,&quot;M&quot;&#125;&#39;

[end]size is 0.098505 M</code></pre>


        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/linux/">linux</a>
                
            </div>
        
    </section>
</article>

    </div>
  
    <div class='post-wrapper'>
      <article class="post reveal">
    <section class="meta">
        
            <h2 class="title">
                <a href="/2015/09/06/%E8%BF%90%E7%BB%B4%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/">
                    常用运维知识大杂烩
                </a>
            </h2>
        
        <time>
            9月 6, 2015
        </time>
        
    
    <div class='cats'>
        <a href="/categories/%E6%89%A9%E5%B1%95%E7%9F%A5%E8%AF%86/">扩展知识</a>, <a href="/categories/%E6%89%A9%E5%B1%95%E7%9F%A5%E8%AF%86/linux/">linux</a>
    </div>

    </section>
    <section class="article typo">
        <p>##日常系统操作</p>
<ul>
<li>将远程文件拷贝到本地</li>
</ul>
<pre><code>    scp username@ip:remote_filepath /local_dir</code></pre>
<ul>
<li><p>同步目录</p>
<pre><code>  rsync -avzr 172.xx.xx.11:/opt/jagent/tomcat* .

  sudo chown -R fsdevops.fsdevops sms-service/</code></pre>
</li>
<li><p><a target="_blank" rel="noopener" href="http://bian5399.blog.51cto.com/3848702/963662">linux 最大文件限制数 ulimit</a></p>
<pre><code>  ulimit -n</code></pre>
</li>
<li><p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/likehua/p/3831331.html">资源暂时不可用，资源已耗尽</a></p>
<pre><code>    $ ps
        -bash: fork: retry: 资源暂时不可用
        -bash: fork: retry: 资源暂时不可用
        -bash: fork: retry: 资源暂时不可用
        -bash: fork: retry: 资源暂时不可用

    IT组哥们分析说是每个用户句柄数只有1024个，目前超了

    ulimit -a 即可查询linux相关的参数     </code></pre>
</li>
<li><p>查看进程号</p>
</li>
</ul>
<pre><code>    ps aux|grep sms|awk -F  &#39; &#39; &#39;&#123;print $2&#125;&#39;

    ps aux|grep sms|awk -F  &#39; &#39; &#39;&#123;kill $2&#125;&#39;</code></pre>
<ul>
<li>grep的使用</li>
</ul>
<pre><code>    cat rmq_bk_gc.log|grep -E -o &#39;\w+&#39;|sort|uniq -c|sort -k 2,1
    -E 正则
    -o 输出 -O 标示出 
    sort排序
    uniq group</code></pre>
<ul>
<li><p>强制用sudo保存</p>
<pre><code>  :w !sudo tee %</code></pre>
</li>
<li><p>设置服务自启动</p>
<p>  chkconfig</p>
</li>
<li><p>查看某端口被谁占用</p>
<pre><code>   netstat -apn
   netstat -apn|grep 8013
   ps -aux | grep 33514/java</code></pre>
</li>
<li><p>查看文件占用<br>  du -hs .</p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/ggjucheng/archive/2012/01/14/2322659.html">监视指定网络的数据包</a></p>
<pre><code>   监视指定主机和端口的数据包      
   tcpdump tcp port 23 and host 210.27.48.1</code></pre>
</li>
<li><p>防火墙</p>
<pre><code>    hostname
    iptables -t filter -I INPUT -p tcp --dport 27107 -m state --state NEW -j ACCEPT

    sudo iptables -A INPUT -p tcp --dport 13710 -j ACCEPT
    sudo iptables -A OUTPUT -p tcp --sport 13710 -j ACCEPT

    service iptables save
    vim /etc/puppet/puppet.conf 

    service puppet restart
    iptables -L
    more /etc/sysconfig/iptables
    vim /etc/sysconfig/iptables
    service iptables reload</code></pre>
</li>
</ul>
<pre><code>      停止防火墙

      sudo su
      service iptables stop</code></pre>
<ul>
<li><p>安装telnet</p>
<pre><code>    yum install -y telnet</code></pre>
</li>
<li><p>查询某类文件</p>
<pre><code>    grep netty -R .</code></pre>
</li>
</ul>
<ul>
<li><p>查看内存</p>
<pre><code>    free </code></pre>
</li>
<li><p>curl 发送请求</p>
<pre><code>  目的1：通过脚本发送post请求。
  答案： curl -d &quot;leaderboard_id=7778a8143f111272&amp;score=19&amp;app_key=8d49f16fe034b98b&amp;_test_user=test01&quot; &quot;http://172.16.102.208:8089/wiapi/score&quot;

  目的2：通过脚本发送post请求，顺便附带文本数据，比如通过&quot;浏览&quot;选择本地的card.txt并上传发送post请求
  答案：  curl  -F &quot;blob=@card.txt;type=text/plain&quot;  &quot;http://172.16.102.208:8089/wiapi/score?leaderboard_id=7778a8143f111272&amp;score=40&amp;app_key=8d49f16fe034b98b&amp;_test_user=test01&quot;   </code></pre>
</li>
<li><p>ssh免密码登陆</p>
</li>
</ul>
<pre><code>ssh-keygen -t rsa -P &#39;&#39;

将生成的文件拷到目标主机，交添加到keys文件中

cat sshnopw.pub &gt;&gt; /root/.ssh/authorized_keys</code></pre>
<ul>
<li>vmstat  相比top，我可以看到整个机器的CPU,内存,IO的使用情况，而不是单单看到各个进程的CPU使用率和内存使用率</li>
</ul>
<pre><code>    2表示每个两秒采集一次服务器状态，1表示只采集一次。
    procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
     r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
     0  0      0 779304  67972 706748    0    0   135    45  538 1117 10  3 86  2  0

     r 表示运行队列(就是说多少个进程真的分配到CPU)，我测试的服务器目前CPU比较空闲，没什么程序在跑，当这个值超过了CPU数目，就会出现CPU瓶颈了。这个也和top的负载有关系，一般负载超过了3就比较高，超过了5就高，超过了10就不正常了，服务器的状态很危险。top的负载类似每秒的运行队列。如果运行队列过大，表示你的CPU很繁忙，一般会造成CPU使用率很高。

     b 表示阻塞的进程,这个不多说，进程阻塞，大家懂的。

     swpd 虚拟内存已使用的大小，如果大于0，表示你的机器物理内存不足了，如果不是程序内存泄露的原因，那么你该升级内存了或者把耗内存的任务迁移到其他机器。

     free   空闲的物理内存的大小，我的机器内存总共8G，剩余3415M。

     buff   Linux/Unix系统是用来存储，目录里面有什么内容，权限等的缓存，我本机大概占用300多M

     cache cache直接用来记忆我们打开的文件,给文件做缓冲，我本机大概占用300多M(这里是Linux/Unix的聪明之处，把空闲的物理内存的一部分拿来做文件和目录的缓存，是为了提高 程序执行的性能，当程序使用内存时，buffer/cached会很快地被使用。)

     si  每秒从磁盘读入虚拟内存的大小，如果这个值大于0，表示物理内存不够用或者内存泄露了，要查找耗内存进程解决掉。我的机器内存充裕，一切正常。

     so  每秒虚拟内存写入磁盘的大小，如果这个值大于0，同上。

     bi  块设备每秒接收的块数量，这里的块设备是指系统上所有的磁盘和其他块设备，默认块大小是1024byte，我本机上没什么IO操作，所以一直是0，但是我曾在处理拷贝大量数据(2-3T)的机器上看过可以达到140000/s，磁盘写入速度差不多140M每秒

     bo 块设备每秒发送的块数量，例如我们读取文件，bo就要大于0。bi和bo一般都要接近0，不然就是IO过于频繁，需要调整。

     in 每秒CPU的中断次数，包括时间中断

     cs 每秒上下文切换次数，例如我们调用系统函数，就要进行上下文切换，线程的切换，也要进程上下文切换，这个值要越小越好，太大了，要考虑调低线程或者进程的数目,例如在apache和nginx这种web服务器中，我们一般做性能测试时会进行几千并发甚至几万并发的测试，选择web服务器的进程可以由进程或者线程的峰值一直下调，压测，直到cs到一个比较小的值，这个进程和线程数就是比较合适的值了。系统调用也是，每次调用系统函数，我们的代码就会进入内核空间，导致上下文切换，这个是很耗资源，也要尽量避免频繁调用系统函数。上下文切换次数过多表示你的CPU大部分浪费在上下文切换，导致CPU干正经事的时间少了，CPU没有充分利用，是不可取的。

     us 用户CPU时间，我曾经在一个做加密解密很频繁的服务器上，可以看到us接近100,r运行队列达到80(机器在做压力测试，性能表现不佳)。

     sy 系统CPU时间，如果太高，表示系统调用时间长，例如是IO操作频繁。

     id  空闲 CPU时间，一般来说，id + us + sy = 100,一般我认为id是空闲CPU使用率，us是用户CPU使用率，sy是系统CPU使用率。

     wt 等待IO CPU时间。</code></pre>
<ul>
<li>jstat java虚拟机 垃圾回收状态查看</li>
</ul>
<pre><code>    命令格式
    jstat命令命令格式：
    jstat [Options] vmid [interval] [count]
    参数说明：
    Options，选项，我们一般使用 -gcutil 查看gc情况
    vmid，VM的进程号，即当前运行的java进程号
    interval，间隔时间，单位为秒或者毫秒
    count，打印次数，如果缺省则打印无数次
    示例说明
    示例
    通常运行命令如下：
    jstat -gc 12538 5000
    即会每5秒一次显示进程号为12538的java进成的GC情况，
    显示内容如下图：

    jstat -gc 19014 1000
     S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT   
    10752.0 10752.0  0.0   5293.9 65536.0  65224.5   175104.0     16.0    13056.0 12799.5 1536.0 1495.2      1    0.009   0      0.000    0.009
    10752.0 10752.0  0.0   5293.9 65536.0  65224.5   175104.0     16.0    13056.0 12799.5 1536.0 1495.2      1    0.009   0      0.000    0.009

    结果说明
    显示内容说明如下（部分结果是通过其他其他参数显示的，暂不说明）：
             S0C：年轻代中第一个survivor（幸存区）的容量 (字节) 
             S1C：年轻代中第二个survivor（幸存区）的容量 (字节) 
             S0U：年轻代中第一个survivor（幸存区）目前已使用空间 (字节) 
             S1U：年轻代中第二个survivor（幸存区）目前已使用空间 (字节) 
             EC：年轻代中Eden（伊甸园）的容量 (字节) 
             EU：年轻代中Eden（伊甸园）目前已使用空间 (字节) 
             OC：Old代的容量 (字节) 
             OU：Old代目前已使用空间 (字节) 
             PC：Perm(持久代)的容量 (字节) 
             PU：Perm(持久代)目前已使用空间 (字节) 
             YGC：从应用程序启动到采样时年轻代中gc次数 
             YGCT：从应用程序启动到采样时年轻代中gc所用时间(s) 
             FGC：从应用程序启动到采样时old代(全gc)gc次数 
             FGCT：从应用程序启动到采样时old代(全gc)gc所用时间(s) 
             GCT：从应用程序启动到采样时gc用的总时间(s) 
             NGCMN：年轻代(young)中初始化(最小)的大小 (字节) 
             NGCMX：年轻代(young)的最大容量 (字节) 
             NGC：年轻代(young)中当前的容量 (字节) 
             OGCMN：old代中初始化(最小)的大小 (字节) 
             OGCMX：old代的最大容量 (字节) 
             OGC：old代当前新生成的容量 (字节) 
             PGCMN：perm代中初始化(最小)的大小 (字节) 
             PGCMX：perm代的最大容量 (字节)   
             PGC：perm代当前新生成的容量 (字节) 
             S0：年轻代中第一个survivor（幸存区）已使用的占当前容量百分比 
             S1：年轻代中第二个survivor（幸存区）已使用的占当前容量百分比 
             E：年轻代中Eden（伊甸园）已使用的占当前容量百分比 
             O：old代已使用的占当前容量百分比 
             P：perm代已使用的占当前容量百分比 
             S0CMX：年轻代中第一个survivor（幸存区）的最大容量 (字节) 
             S1CMX ：年轻代中第二个survivor（幸存区）的最大容量 (字节) 
             ECMX：年轻代中Eden（伊甸园）的最大容量 (字节) 
             DSS：当前需要survivor（幸存区）的容量 (字节)（Eden区已满） 
             TT： 持有次数限制 
             MTT ： 最大持有次数限制 </code></pre>
<ul>
<li><p>jstack pid java查看java程序的状态</p>
</li>
<li><p>grep <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Regular_expression">正则</a>输出 </p>
</li>
</ul>
<pre><code>    grep -o -E &quot;[0-9]&#123;11&#125;&quot; xx.log

    cat error.log |grep &#39;Failed to invoke the method&#39;|grep &#39;2015-12-08 20&#39;|awk -F&#39;Failed to invoke the method&#39; &#39;&#123;print $2&#125;&#39;|awk &#39;&#123;print $1&#125;&#39;  |sort|uniq -c</code></pre>
<ul>
<li><p>删除某些文件</p>
<pre><code>  find ./ -name &#39;xx.log&#39; |xargs rm -rf</code></pre>
</li>
<li><p>删除某个文件外的其它文件</p>
<pre><code>  ls | grep -v keep | xargs rm #删除keep文件之外的所有文件
  说明： ls先得到当前的所有文件和文件夹的名字， grep -v keep，进行grep正则匹配查找keep，-v参数决定了结果为匹配之外的结果，也就是的到了keep之外的所有文件名，然后 xargs用于从 标准输入获得参数 并且传递给后面的命令，这里使用的命令是 rm，然后由rm删除前面选择的文件</code></pre>
</li>
<li><p>查看磁盘信息</p>
</li>
</ul>
<pre><code>    查看当前文件夹下所有文件大小（包括子文件夹）
       ➜  ~  du -sh
        47G    .
    查看指定文件夹大小
       # du -hs ftp
       6.3G    ftp

    查看磁盘空间大小命令
    df -h Df命令是linux系统以磁盘分区为单位查看文件系统，可以加上参数查看磁盘剩余空间信息，命令格式： df -hl 显示格式为： 文件系统 容量 已用 可用 已用% 挂载点 Filesystem Size Used Avail Use% Mounted on /dev/hda2 45G 19G 24G 44% / /dev/hda1 494

    df   -h

    Df命令是linux系统以磁盘分区为单位查看文件系统，可以加上参数查看磁盘剩余空间信息，命令格式：

    df -hl

    显示格式为：　

    文件系统              容量 已用 可用 已用% 挂载点　

    Filesystem            Size Used Avail Use% Mounted on

    /dev/hda2              45G   19G   24G 44% /</code></pre>
<ul>
<li><p>gz解压</p>
<pre><code>  gzip -x ...     </code></pre>
</li>
<li><p>proc 启动应用程序时，找不到log去哪了</p>
<pre><code>  ls -l /proc/63220/fd|grep log</code></pre>
</li>
</ul>
<ul>
<li>查看内存信息 </li>
</ul>
<p>#linux 下安装软件</p>
<ul>
<li>yum</li>
</ul>
<pre><code>    指定源进行安装
    yum install 软件名 --enablerepo=安装包地址</code></pre>
<ul>
<li>重新安装JDK</li>
</ul>
<pre><code>    删除JDK:
        rpm -qa | grep jdk|xargs sudo rpm -e --nodeps
    download jdk
     wget -c -P ./ http://download.oracle.com/otn-pub/java/jdk/8u65-b17/jdk-8u65-linux-x64.rpm?AuthParam=1448637274_af870ccf6c2c78750a5977e6da301744

     安装

     以JDK1.8为例

     拷贝到/usr/share下，mv jdk-8u65-linux-x64.rpm /usr/share

     用rpm -ivh命令安装



     配置环境变量

     在/etc/profile下增加

     # set Java environment
     JAVA_HOME=/usr/share/jdk-8u65-linux-x64
     PATH=$JAVA_HOME/bin:$PATH
     CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar
     export JAVA_HOME
     export PATH
     export CLASSPATH



     测试

     [root@localhost ~]# echo $JAVA_HOME
     /usr/share/jdk1.6.0_43
     [root@localhost ~]# echo $PATH
     /usr/share/jdk1.6.0_43/bin:/usr/lib64/qt-3.3/bin:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin
     [root@localhost ~]# echo $CLASSPATH
     .:/usr/share/jdk1.6.0_43/lib/dt.jar:/usr/share/jdk1.6.0_43/lib/tools.jar

     [root@localhost ~]# java -version
     java version &quot;1.6.0_43&quot;
     Java(TM) SE Runtime Environment (build 1.6.0_43-b01)
     Java HotSpot(TM) 64-Bit Server VM (build 20.14-b01, mixed mode)

    Managing Java

    sudo update-alternatives --config java
    有 2 个候选项可用于替换 java (提供 /usr/bin/java)。</code></pre>
<h2 id="数据库操作"><a href="#数据库操作" class="headerlink" title="数据库操作"></a>数据库操作</h2><ul>
<li><p>mysql授权</p>
<pre><code>  ALL PRIVILEGES ON *.* TO &#39;root&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;root&#39; WITH GRANT OPTION;</code></pre>
</li>
</ul>
<h2 id="安装apt-get"><a href="#安装apt-get" class="headerlink" title="安装apt-get"></a>安装apt-get</h2><p><a target="_blank" rel="noopener" href="http://everyday-tech.com/apt-get-on-centos/">http://everyday-tech.com/apt-get-on-centos/</a></p>
<h2 id="lsof"><a href="#lsof" class="headerlink" title="lsof"></a>lsof</h2><p>lsof语法格式是：<br>lsof ［options］ filename<br>复制代码</p>
<p>lsof abc.txt 显示开启文件abc.txt的进程<br>lsof -c abc 显示abc进程现在打开的文件<br>lsof -c -p 1234 列出进程号为1234的进程所打开的文件<br>lsof -g gid 显示归属gid的进程情况<br>lsof +d /usr/local/ 显示目录下被进程开启的文件<br>lsof +D /usr/local/ 同上，但是会搜索目录下的目录，时间较长<br>lsof -d 4 显示使用fd为4的进程<br>lsof -i 用以显示符合条件的进程情况<br>lsof -i[46] [protocol][@hostname|hostaddr][:service|port]<br>  46 –&gt; IPv4 or IPv6<br>  protocol –&gt; TCP or UDP<br>  hostname –&gt; Internet host name<br>  hostaddr –&gt; IPv4地址<br>  service –&gt; /etc/service中的 service name (可以不止一个)<br>  port –&gt; 端口号 (可以不止一个)</p>
<h2 id="traceroute-IP"><a href="#traceroute-IP" class="headerlink" title="traceroute IP"></a>traceroute IP</h2><h2 id="监控某台机器到某IP的链路的连通性"><a href="#监控某台机器到某IP的链路的连通性" class="headerlink" title="监控某台机器到某IP的链路的连通性"></a>监控某台机器到某IP的链路的连通性</h2><pre><code>    nohup ping -W 1 172.31.xx.xx &amp;&gt;/tmp/ping.log &amp;
    crontab -e
    * * * * *       echo &quot;`date +%d-%H:%M`&quot; &gt;&gt; /tmp/ping.log</code></pre>


        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/linux%E5%91%BD%E4%BB%A4/">linux命令</a>
                
            </div>
        
    </section>
</article>

    </div>
  
    <div class='post-wrapper'>
      <article class="post reveal">
    <section class="meta">
        
            <h2 class="title">
                <a href="/2015/09/02/Django+Mysql+%E5%AE%9E%E7%8E%B0%E5%91%A8%E8%BE%B9%E6%9F%A5%E8%AF%A2/">
                    Django,Mysql,空间数据是通过Google地图和高德地图进行采集的
                </a>
            </h2>
        
        <time>
            9月 2, 2015
        </time>
        
    
    <div class='cats'>
        <a href="/categories/%E6%96%B9%E6%A1%88/">方案</a>
    </div>

    </section>
    <section class="article typo">
        <p>##环境</p>
<p>Django,Mysql,空间数据是通过Google地图和高德地图进行采集的</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">$ mysql -V</span><br><span class="line">mysql  Ver <span class="number">14.14</span> Distrib <span class="number">5.6</span><span class="number">.20</span>, <span class="keyword">for</span> osx10<span class="number">.9</span> (x86_64) <span class="keyword">using</span>  EditLine <span class="keyword">wrapper</span></span><br></pre></td></tr></table></figure>

<p>##需求描述</p>
<p>mysql中存储了一些地理空间点类型的数，要进行周边查询。</p>
<p>##MySQL空间相关的局限性</p>
<p><a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.6/en/spatial-relation-functions.html">MySQL空间扩展的功能</a>仅支持包络框相关的操作(MySQL称之为最小边框，或简称为 MBR)。也就是说，MySQL符合OGC标准。</p>
<blockquote>
<p>目前,MySQL没有实现Contains,Crosses,Disjoint,Intersects,Overlaps,Touches函数，可以通过MBR来实现同样效果操作。</p>
</blockquote>
<p>也就是说，在MySQL进行如contains类似的空间查询时，可以通过bbcontains来实现同样效果的操作。</p>
<p><code>注意：</code></p>
<figure class="highlight gcode"><table><tr><td class="code"><pre><span class="line">只有MyISAM引擎的MySQL表才真正的支持空间索引<span class="comment">(R-trees)</span>。也就是说，当你要使用MySQL提供的空间扩展时，你要在快速查询空间数据和数据的完整性之间做一个选择 － MyISAM的表不支持事务和外键约束。</span><br></pre></td></tr></table></figure>


<p>##数据库配置</p>
<p>空间表引擎 Engine:InnoDB</p>
<p>###创建数据库</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">mysql&gt;<span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> project_test@localhost IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;project_test&#x27;</span> <span class="keyword">WITH</span> <span class="keyword">GRANT</span> <span class="keyword">OPTION</span>; </span><br><span class="line">mysql&gt;<span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> project_test@&quot;%&quot; IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;project_test&#x27;</span> <span class="keyword">WITH</span> <span class="keyword">GRANT</span> <span class="keyword">OPTION</span>; </span><br></pre></td></tr></table></figure>

<ul>
<li><p>第一句增加了一个 project_test 用户授权通过本地机（localhost)访问，密码“project_test”。</p>
</li>
<li><p>第二句则是授与 project_test 用户从任何其它主机发起的访问（通配符％）。 </p>
</li>
</ul>
<p>###配置数据源</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.contrib.gis.db.backends.mysql&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;project_test&#x27;</span>,        # <span class="keyword">Or</span> <span class="type">path</span> <span class="keyword">to</span> <span class="keyword">database</span> file <span class="keyword">if</span> <span class="keyword">using</span> sqlite3.</span><br><span class="line">    <span class="string">&#x27;USER&#x27;</span>: <span class="string">&#x27;project_test&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PASSWORD&#x27;</span>: <span class="string">&#x27;project_test&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;HOST&#x27;</span>: <span class="string">&#x27;127.0.0.1&#x27;</span>,           # Empty <span class="keyword">for</span> localhost through <span class="keyword">domain</span> sockets <span class="keyword">or</span> <span class="string">&#x27;127.0.0.1&#x27;</span> <span class="keyword">for</span> localhost through TCP.</span><br><span class="line">    <span class="string">&#x27;PORT&#x27;</span>: <span class="string">&#x27;3306&#x27;</span>,                # <span class="keyword">Set</span> <span class="keyword">to</span> empty string <span class="keyword">for</span> <span class="keyword">default</span>.</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>##数据模型的构建</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.gis.db <span class="keyword">import</span> models <span class="keyword">as</span> gismodels</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppPoint</span>(<span class="params">gismodels.Model</span>):</span></span><br><span class="line">    description = gismodels.TextField(verbose_name=_(<span class="string">u&quot;描述信息&quot;</span>), max_length=<span class="number">500</span>,</span><br><span class="line">                                      blank=<span class="literal">True</span>, null=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    point = gismodels.PointField(spatial_index=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    objects = gismodels.GeoManager()</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<h2 id="Django-Geographic-framework-1-7"><a href="#Django-Geographic-framework-1-7" class="headerlink" title="Django Geographic framework 1.7"></a><a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/1.7/">Django Geographic framework 1.7</a></h2><p><a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/1.7/ref/contrib/gis/">GeoDjango</a>打算做世界级的地理学Web框架。它的目标是尽可能方便是的利用强大空间数据构建GIS Web 应用。</p>
<p>###GeoQuerySet API</p>
<p><code>class GeoQuerySet([model=None])</code></p>
<p>####空间查询</p>
<p>正如使用<a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/1.7/ref/models/querysets/#queryset-api">QuerySet API</a>时一样，在过滤器链(<a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/1.7/topics/db/queries/#chaining-filters">chaining filters</a>)上加上GeoQuerySet进行筛选。除了通常的字段(<a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/1.7/ref/models/querysets/#field-lookups">Field lookups</a>)查询，它还提供了空间字段<a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/1.7/ref/contrib/gis/model-api/#django.contrib.gis.db.models.GeometryField">GeometryField</a>的查询。</p>
<p>可以在<a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/1.7/ref/contrib/gis/db-api/#spatial-lookups-intro">这里</a>查看空间查询介绍</p>
<p>下面Django对不同数据库 空间查询操作支持统计表：</p>
<pre><code>    Lookup Type            PostGIS    Oracle    MySQL [7]    SpatiaLite

    bbcontains            X                X             X
    bboverlaps            X                 X             X
    contained            X                 X             X
    contains            X         X        X             X
    contains_properly    X               
    coveredby            X         X          
    covers                X         X          
    crosses                X                               X
    disjoint            X         X        X             X
    distance_gt            X         X                      X
    distance_gte        X         X                      X
    distance_lt            X         X                      X
    distance_lte           X         X                      X
    dwithin                X         X          
    equals                X         X        X             X
    exact                X         X        X             X
    intersects            X         X        X             X
    overlaps            X         X        X             X
    relate                X         X                     X
    same_as                X         X        X             X
    touches                X         X        X             X
    within                X         X        X             X
    left                X               
    right                X               
    overlaps_left       X               
    overlaps_right      X               
    overlaps_above      X               
    overlaps_below      X               
    strictly_above      X               
    strictly_below      X               </code></pre>
<p>####我这里只关注一下对mysql的空间操作支持</p>
<blockquote>
<p>按我们的需要我们选用 <code>within</code></p>
</blockquote>
<ol>
<li><p>bbcontains</p>
<p> 支持：<code>PostGIS</code>,<code>MySQL</code>,<code>SpatiaLite</code></p>
<p> 查询数据库中空间数据的bbox包含在指定的空间bbox内的数据。</p>
<pre><code> 数据库         操作  

 PostGIS       poly ~ geom
 MySQL         MBRContains(poly,geom)
 SpatiaLite    MbrContains(poly,geom)</code></pre>
</li>
</ol>
<ol start="2">
<li><p>bboverlaps</p>
<p> 支持：<code>PostGIS</code>,<code>MySQL</code>,<code>SpatiaLite</code></p>
<p> 查询数据库中空间数据的bbox与指定的空间bbox相交的数据。</p>
<pre><code> 数据库         操作  

 PostGIS       poly &amp;&amp; geom
 MySQL         MBROverlops(poly,geom)
 SpatiaLite    MbrOverlops(poly,geom)</code></pre>
</li>
<li><p>contained</p>
<p> 支持：<code>PostGIS</code>,<code>MySQL</code>,<code>SpatiaLite</code></p>
<p> 查询数据库中空间数据的bbox完全包含指定的空间bbox的数据。</p>
<pre><code> 数据库         操作  

 PostGIS       poly @ geom
 MySQL         MBRWithin(poly,geom)
 SpatiaLite    MbrWithin(poly,geom)</code></pre>
</li>
<li><p>contains</p>
<p> 支持：<code>PostGIS</code>,<code>Oracle</code>,<code>MySQL</code>,<code>SpatiaLite</code></p>
<p> Example:</p>
<pre><code> Zipcode.objects.filter(poly__contains=geom)</code></pre>
<p> 查询数据库中空间数据包含指定的空间图形的数据。</p>
<pre><code> 数据库         操作  

 PostGIS       ST_Contains(poly, geom)
 Oracle        SDO_CONTAINS(poly, geom)
 MySQL         MBRContains(poly, geom)
 SpatiaLite    Contains(poly, geom)</code></pre>
</li>
</ol>
<ol start="5">
<li><p>disjoint</p>
<p> 支持：<code>PostGIS</code>,<code>Oracle</code>,<code>MySQL</code>,<code>SpatiaLite</code></p>
<p> Example:</p>
<pre><code> Zipcode.objects.filter(poly__disjoint=geom)</code></pre>
<p> 查询数据库中与指定的空间图形相离的空间数据。</p>
<pre><code> 数据库         操作  

 PostGIS       ST_Disjoint(poly, geom)
 Oracle        SDO_GEOM.RELATE(poly, geom)
 MySQL         MBRDisjoint(poly, geom)
 SpatiaLite    Disjoint(poly, geom)</code></pre>
</li>
<li><p>equals</p>
<p> 支持：<code>PostGIS</code>,<code>Oracle</code>,<code>MySQL</code>,<code>SpatiaLite</code></p>
</li>
<li><p>exact，same_as</p>
<p> 支持：<code>PostGIS</code>,<code>Oracle</code>,<code>MySQL</code>,<code>SpatiaLite</code></p>
</li>
<li><p>intersects</p>
<p> 支持：<code>PostGIS</code>,<code>Oracle</code>,<code>MySQL</code>,<code>SpatiaLite</code></p>
<p> 查询数据库中与指定的空间图形相交的空间数据。</p>
<p> Example:</p>
<pre><code>     Zipcode.objects.filter(poly__intersects=geom)</code></pre>
</li>
</ol>
<pre><code>        数据库         操作  

        PostGIS       ST_Intersects(poly, geom)
        Oracle        SDO_OVERLAPBDYINTERSECT(poly, geom)
        MySQL         MBRIntersects(poly, geom)
        SpatiaLite    Intersects(poly, geom)</code></pre>
<ol start="9">
<li><p>overlaps</p>
<p> 支持：<code>PostGIS</code>,<code>Oracle</code>,<code>MySQL</code>,<code>SpatiaLite</code></p>
</li>
</ol>
<ol start="10">
<li><p>touches</p>
<p>支持：<code>PostGIS</code>,<code>Oracle</code>,<code>MySQL</code>,<code>SpatiaLite</code></p>
<p>Example:</p>
<pre><code>    Zipcode.objects.filter(poly__touches=geom)</code></pre>
<p>查询与指定的空间几何图形相接的数据。</p>
<pre><code>    数据库         操作  

    PostGIS       ST_Touches(poly, geom)
    Oracle        SDO_TOUCH(poly, geom)
    MySQL         MBRTouches(poly, geom)
    SpatiaLite    Touches(poly, geom)</code></pre>
</li>
<li><p>within</p>
<p>支持：<code>PostGIS</code>,<code>Oracle</code>,<code>MySQL</code>,<code>SpatiaLite</code></p>
<p>Example:</p>
<pre><code>    Zipcode.objects.filter(poly__within=geom)</code></pre>
<p>查询包含在指定的空间几何图形中的数据。</p>
<pre><code>    数据库         操作  

    PostGIS       ST_Within(poly, geom)
    Oracle        SDO_INSIDE(poly, geom)
    MySQL         MBRWithin(poly, geom)
    SpatiaLite    Within(poly, geom)</code></pre>
</li>
</ol>
<blockquote>
<p>现在知道了要用 within 来查询数据，另一个问题来了，如何生成半径大小为R中心坐标为(x,y)的geom呢。</p>
</blockquote>
<p>####创建空间几何图形</p>
<p>可以通过多种方式创建<a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/1.7/ref/contrib/gis/geos/#django.contrib.gis.geos.GEOSGeometry">GeosGeometry</a>。第一种方法，就是通过一些参数直接实例化。</p>
<ul>
<li>下面是分别通过WKT,HEX,WKB和GeoJSON方式直接创建 Geometry 的方法：</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">30</span>]: pnt = GEOSGeometry(<span class="string">&#x27;POINT(5 23)&#x27;</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">31</span>]: pnt = GEOSGeometry(<span class="string">&#x27;010100000000000000000014400000000000003740&#x27;</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">32</span>]: pnt = GEOSGeometry(buffer(<span class="string">&#x27;\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x14@\x00\x00\x00\x00\x00\x007@&#x27;</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="number">33</span>]: pnt = GEOSGeometry(<span class="string">&#x27;&#123; &quot;type&quot;: &quot;Point&quot;, &quot;coordinates&quot;: [ 5.000000, 23.000000 ] &#125;&#x27;</span>) <span class="comment"># GeoJSON   </span></span><br><span class="line">        </span><br></pre></td></tr></table></figure>

<ul>
<li>另一种方式就是通过特定类型的空间几何对象的构造器来进行创建该类型的Geometry实例</li>
</ul>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">In [<span class="number">34</span>]: <span class="keyword">from</span> django.contrib.gis.geos <span class="keyword">import</span> Point</span><br><span class="line"></span><br><span class="line">In [<span class="number">35</span>]: pnt = Point(<span class="number">5</span>,<span class="number">23</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">36</span>]: pnt</span><br><span class="line">Out[<span class="number">36</span>]: &lt;Point object at <span class="number">0x10735bb50</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>最后一种方法就是通过 <a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/1.7/ref/contrib/gis/geos/#django.contrib.gis.geos.fromstr">fromstr()</a>和 <a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/1.7/ref/contrib/gis/geos/#django.contrib.gis.geos.fromfile">fromfile</a> 工厂方法来创建Geometry实例。它们分别接收字符串或文件</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">37</span>]: <span class="keyword">from</span> django.contrib.gis.geos <span class="keyword">import</span> fromstr,fromfile</span><br><span class="line"></span><br><span class="line">In [<span class="number">38</span>]: pnt = fromstr(<span class="string">&#x27;POINT(5 23)&#x27;</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">39</span>]: pnt = fromfile(<span class="string">&#x27;/path/to/pnt.wkt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">34</span>]: pnt = fromfile(open(<span class="string">&#x27;/path/to/pnt.wkt&#x27;</span>))</span><br></pre></td></tr></table></figure>



<p>####实现查询周边几何点的功能</p>
<blockquote>
<p>通过上面的学习，在Django中实现mysql数据的周边查询只能通过模糊的查询，<br>我们这里通过构建一个包络框进行模糊查询：</p>
</blockquote>
<ul>
<li>构建一个包络框</li>
</ul>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.gis.geos <span class="keyword">import</span> (<span class="type">Polygon</span>,<span class="type">Point</span>)</span><br><span class="line"></span><br><span class="line"><span class="type">point</span> = <span class="type">Point</span>(<span class="number">130</span>,<span class="number">39</span>)</span><br><span class="line"></span><br><span class="line">buffer=<span class="type">point</span>.buffer(degree)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ul>
<li>进行within查询</li>
</ul>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="module-access"><span class="module"><span class="identifier">AppPoint</span>.</span></span>objects.filter(point__within=buffer)</span><br></pre></td></tr></table></figure>


<ul>
<li>问题</li>
</ul>
<p>这里给的半径通常是米为km，但是这个构建buffer的方法需要的参数是一个度。</p>
<pre><code>degree=l*180/(math.pi*6371)</code></pre>
<p>##测试方法和数据</p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="function">def <span class="title">get_point</span><span class="params">(<span class="built_in">point</span>,r)</span>:</span></span><br><span class="line"><span class="function">    EARTH_R</span>=<span class="number">6378.137</span></span><br><span class="line">    <span class="built_in">buffer</span> = <span class="built_in">point</span>.<span class="built_in">buffer</span>(r*<span class="number">180</span>/(math.pi*EARTH_R))</span><br><span class="line">    aps=AppPoint.objects.filter(point__within=<span class="built_in">buffer</span>)</span><br><span class="line">    <span class="keyword">for</span> ap in aps:</span><br><span class="line">        <span class="built_in">print</span> ap.<span class="built_in">point</span>.json,(math.pi*EARTH_R*ap.<span class="built_in">point</span>.distance(<span class="built_in">point</span>)/<span class="number">180</span>)</span><br><span class="line">        </span><br></pre></td></tr></table></figure>
<p>其中点与点间的距离方法distance在django中解释为：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">Returns the distance between the closest points on this Geometry</span><br><span class="line"><span class="keyword">and</span> the other. Units will be <span class="keyword">in</span> those of the coordinate<span class="built_in"> system </span>of</span><br><span class="line">the Geometry.</span><br></pre></td></tr></table></figure>

<p>下面是测试数据：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">b</span> <span class="string">=</span> [[<span class="number">116.27497</span>,<span class="number">39.95708</span>,<span class="number">2573</span>],</span><br><span class="line">[<span class="number">116.48103</span>,<span class="number">39.96657</span>,<span class="number">4292</span>],</span><br><span class="line"><span class="string">...</span></span><br><span class="line">[<span class="number">116.13621</span>,<span class="number">39.92686</span>,<span class="number">528</span>],</span><br><span class="line">[<span class="number">116.39494</span>,<span class="number">39.87986</span>,<span class="number">138</span>],</span><br><span class="line">[<span class="number">116.389</span>,<span class="number">39.8799</span>,<span class="number">2151</span>],</span><br><span class="line">[<span class="number">116.4858</span>,<span class="number">39.9361</span>,<span class="number">4709</span>]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">创建数据：</span></span><br><span class="line"><span class="attr">for b in a:</span>                                   </span><br><span class="line">    <span class="string">AppPoint.objects.create(description=b.count,point=Point(b[0],b[1]))</span></span><br><span class="line">    </span><br><span class="line"><span class="string">输出结果：</span></span><br><span class="line"> <span class="string">get_point(Point(116.4,39.8),8)</span></span><br><span class="line">&#123; <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;Point&quot;</span>, <span class="attr">&quot;coordinates&quot;:</span> [ <span class="number">116.4214</span>, <span class="number">39.85925</span> ] &#125; <span class="number">7.01270604176</span></span><br><span class="line">&#123; <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;Point&quot;</span>, <span class="attr">&quot;coordinates&quot;:</span> [ <span class="number">116.33663</span>, <span class="number">39.79076</span> ] &#125; <span class="number">7.1289114023</span></span><br><span class="line">&#123; <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;Point&quot;</span>, <span class="attr">&quot;coordinates&quot;:</span> [ <span class="number">116.43555</span>, <span class="number">39.80307</span> ] &#125; <span class="number">3.97213681829</span></span><br><span class="line">&#123; <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;Point&quot;</span>, <span class="attr">&quot;coordinates&quot;:</span> [ <span class="number">116.42803</span>, <span class="number">39.86696</span> ] &#125; <span class="number">8.08069287815</span></span><br><span class="line">&#123; <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;Point&quot;</span>, <span class="attr">&quot;coordinates&quot;:</span> [ <span class="number">116.41776</span>, <span class="number">39.8526</span> ] &#125; <span class="number">6.18016458489</span></span><br><span class="line">&#123; <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;Point&quot;</span>, <span class="attr">&quot;coordinates&quot;:</span> [ <span class="number">116.41467</span>, <span class="number">39.86627</span> ] &#125; <span class="number">7.5557334976</span></span><br><span class="line">&#123; <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;Point&quot;</span>, <span class="attr">&quot;coordinates&quot;:</span> [ <span class="number">116.37254</span>, <span class="number">39.82765</span> ] &#125; <span class="number">4.33799658047</span></span><br><span class="line">&#123; <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;Point&quot;</span>, <span class="attr">&quot;coordinates&quot;:</span> [ <span class="number">116.36128</span>, <span class="number">39.85648</span> ] &#125; <span class="number">7.62292984489</span></span><br><span class="line">&#123; <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;Point&quot;</span>, <span class="attr">&quot;coordinates&quot;:</span> [ <span class="number">116.41574</span>, <span class="number">39.80051</span> ] &#125; <span class="number">1.75308830872</span></span><br><span class="line">&#123; <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;Point&quot;</span>, <span class="attr">&quot;coordinates&quot;:</span> [ <span class="number">116.40075</span>, <span class="number">39.81592</span> ] &#125; <span class="number">1.77417182449</span></span><br><span class="line">&#123; <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;Point&quot;</span>, <span class="attr">&quot;coordinates&quot;:</span> [ <span class="number">116.45339</span>, <span class="number">39.83341</span> ] &#125; <span class="number">7.01111345466</span></span><br><span class="line">&#123; <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;Point&quot;</span>, <span class="attr">&quot;coordinates&quot;:</span> [ <span class="number">116.39799</span>, <span class="number">39.84366</span> ] &#125; <span class="number">4.86535674431</span></span><br><span class="line">&#123; <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;Point&quot;</span>, <span class="attr">&quot;coordinates&quot;:</span> [ <span class="number">116.38116</span>, <span class="number">39.85952</span> ] &#125; <span class="number">6.94973919946</span></span><br><span class="line">&#123; <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;Point&quot;</span>, <span class="attr">&quot;coordinates&quot;:</span> [ <span class="number">116.3385</span>, <span class="number">39.82914</span> ] &#125; <span class="number">7.57577153659</span></span><br><span class="line">&#123; <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;Point&quot;</span>, <span class="attr">&quot;coordinates&quot;:</span> [ <span class="number">116.3777</span>, <span class="number">39.86207</span> ] &#125; <span class="number">7.34200348969</span></span><br><span class="line">&#123; <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;Point&quot;</span>, <span class="attr">&quot;coordinates&quot;:</span> [ <span class="number">116.39454</span>, <span class="number">39.86518</span> ] &#125; <span class="number">7.28121719546</span></span><br><span class="line">&#123; <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;Point&quot;</span>, <span class="attr">&quot;coordinates&quot;:</span> [ <span class="number">116.41095</span>, <span class="number">39.84127</span> ] &#125; <span class="number">4.75311465912</span></span><br></pre></td></tr></table></figure>

<p>##总结</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">    <span class="keyword">from</span> django.contrib.gis.geos <span class="keyword">import</span> (<span class="type">Polygon</span>,<span class="type">Point</span>)</span><br><span class="line">    <span class="keyword">import</span> math</span><br><span class="line">    <span class="type">point</span> = <span class="type">Point</span>(<span class="number">130</span>,<span class="number">39</span>)</span><br><span class="line">    EARTH_R=<span class="number">6378.137</span></span><br><span class="line">    buffer = <span class="type">point</span>.buffer(r*<span class="number">180</span>/(math.pi*EARTH_R))</span><br><span class="line">    aps=AppPoint.objects.<span class="keyword">filter</span>(point__within=buffer)</span><br><span class="line"></span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">##新的问题</span><br><span class="line">###上面这种方法得到的是没有排序的结果，目前要进行由近到远进行排序，通过</span><br><span class="line">`SQRT(POW( ABS( X(<span class="keyword">Location</span>) – X(@center)), <span class="number">2</span>) + POW(ABS(Y(<span class="keyword">Location</span>) – Y(@center)), <span class="number">2</span>))`得到一个大致的距离因子，然后根据这个进行排序。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>queryset.extra(select={‘distance_factor’: “SQRT(POWER(ABS(X(point) - “+str(x)+”),2) + POWER(ABS(Y(point) - “+str(y)+”),2))”}).order_by(‘distance_factor’)</p>
<figure class="highlight clean"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">###在线上遇到了下面的问题：</span><br></pre></td></tr></table></figure>
<p>rps[0].point.distance(rps[1].point)<br>python: GeometryComponentFilter.cpp:35: virtual void geos::geom::GeometryComponentFilter::filter_ro(const geos::geom::Geometry*): Assertion `0’ failed.</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line">线上直接使用<span class="selector-tag">distance</span>时报错。</span><br><span class="line"></span><br><span class="line">然后比较了一下<span class="selector-tag">python</span>的<span class="selector-tag">distance</span>得到的值，其实是和`<span class="selector-tag">SQRT</span>(POW( ABS( X(Location) – X(<span class="variable">@center</span>)), <span class="number">2</span>) + POW(ABS(Y(Location) – Y(<span class="variable">@center</span>)), <span class="number">2</span>))`得到的值是一样的。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>(‘…..python’, 0.0071949078163964595)<br>(‘self’, 0.0071949078163964595)</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">故处些最终到终心点的距离使用了 <span class="code">`distance_factor`</span> 来代替。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">##注意</span></span><br><span class="line"></span><br><span class="line"><span class="section">###[<span class="string">经纬度坐标系采用GCJ-2标准,对于Google,高德地图和腾讯地图可以直接使用</span>](<span class="link">http://wangsheng2008love.blog.163.com/blog/static/78201689201461674727642/</span>)</span></span><br><span class="line"><span class="section">###地球坐标系 (WGS-84) 到火星坐标系 (GCJ-02) 的转换算法</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">####下面是通过html5获取坐标，然后转化后的当前我的位置截图</span></span><br><span class="line">![<span class="string">loading</span>](<span class="link">/images/project/xy_trans_position.png =x400</span>)</span><br><span class="line"><span class="section">####腾讯高德对其转化都有现成的实现</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<pre><code>    var a = 6378245.0
    var ee = 0.00669342162296594323

    function out_of_china(lat,lon)&#123;
        if (lon &lt; 72.004 || lon &gt; 137.8347)
            return true
        if (lat &lt; 0.8293 || lat &gt; 55.8271)
            return true
    &#125;
    function transformlat(x, y) &#123;

        var result = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x))
        result += (20.0 * Math.sin(6.0 * Math.PI * x) + 20.0 * Math.sin(2.0 * Math.PI * x)) * 2.0 / 3.0
        result += (20.0 * Math.sin(Math.PI * y) + 40.0 * Math.sin(Math.PI / 3.0 * y)) * 2.0 / 3.0
        result += (160.0 * Math.sin(Math.PI / 12.0 * y) + 320.0 * Math.sin(Math.PI / 30.0 * y)) * 2.0 / 3.0
        return result
    &#125;
    function transformlon(x, y) &#123;
        var result = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x))
        result += (20.0 * Math.sin(6.0 * Math.PI * x) + 20.0 * Math.sin(2.0 * Math.PI * x)) * 2.0 / 3.0
        result += (20.0 * Math.sin(Math.PI * x) + 40.0 * Math.sin(Math.PI / 3.0 * x)) * 2.0 / 3.0
        result += (150.0 * Math.sin(Math.PI / 12.0 * x) + 300.0 * Math.sin(Math.PI / 30.0 * x)) * 2.0 / 3.0
        return result
    &#125;

    function wgs2gcj(wgslat, wgslon) &#123;
        if (out_of_china(wgslat, wgslon)) &#123;
            return [wgslat, wgslon]
        &#125;
        var lat = transformlat(wgslon - 105.0, wgslat - 35.0)
        var lon = transformlon(wgslon - 105.0, wgslat - 35.0)
        var rad_lat = Math.PI / 180.0 * wgslat
       var  magic = Math.sin(rad_lat)
        magic = 1 - ee * magic * magic
        var sqrt_magic = Math.sqrt(magic)
        lat = (180.0 * lat) / (Math.PI * (a * (1 - ee)) / (magic * sqrt_magic))
        lon = (180.0 * lon) / (Math.PI * a * Math.cos(rad_lat) / sqrt_magic)
        var chnlat = wgslat + lat
        var chnlon = wgslon + lon
        return [chnlat, chnlon]
    &#125;</code></pre>
<pre><code>
##参考
&gt;0. [JAVSCRIPT Math](http://www.w3school.com.cn/jsref/jsref_obj_math.asp)

&gt;1. [MySQL空间数据库–查询点到多点间的最短路径](http://www.javabloger.com/article/mysql-spatial-database.html)

&gt;2. [W3 Geolocation API Specification](http://www.w3.org/TR/geolocation-API/#position_interface)

&gt;3. [关于百度map和高德map，关于map坐标系](http://wangsheng2008love.blog.163.com/blog/static/78201689201461674727642/)

&gt;4. [iOS 火星坐标相关整理及解决方案汇总](http://it.taocms.org/04/507.htm)

</code></pre>


        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/python/">python</a>
                
                    <a href="/tags/GIS/">GIS</a>
                
                    <a href="/tags/mysql/">mysql</a>
                
            </div>
        
    </section>
</article>

    </div>
  
</section>


  <nav id="page-nav">
    
    <a class="prev" rel="prev" href="/page/3/">
      <span class="icon icon-chevron-left"></span>
      <span class="text">Previous</span>
    </a>
    
    
    <a class="next" rel="next" href="/page/5/">
      <span class="text">Next</span>
      <span class="icon icon-chevron-right"></span>
    </a>
    
  </nav>
  

      </div>
      <aside class='l_side'>
        
  <section class='m_widget about'>

<img class='avatar waves-image' src='/images/head/photo2.jpeg' />

<div class='header'>万松</div>
<div class='content'>
<div class='desc'>生活点滴和知识分享</div>
</div>
</section>


  <section class='m_widget links'>
<div class='header'>友情链接</div>
<div class='content'>
    <ul class="entry">
    
        <li><a class="flat-box" target="_blank" href="https://www.fxiaoke.com/">
            <div class='name'>fxiaoke</div>
        </a></li>
    
    </ul>
</div>
</section>


  <section class='m_widget categories'>
<div class='header'>所有分类</div>
<div class='content'>
    
    <ul class="entry">
    
        <li><a class="flat-box" href="/categories/%E6%89%A9%E5%B1%95%E7%9F%A5%E8%AF%86/linux/"><div class='name'>linux</div><div class='badget'>2</div></a></li>
    
        <li><a class="flat-box" href="/categories/%E6%97%A5%E5%B8%B8%E5%B7%A5%E5%85%B7/mac/"><div class='name'>mac</div><div class='badget'>1</div></a></li>
    
        <li><a class="flat-box" href="/categories/%E4%B9%A6%E6%9E%B6/"><div class='name'>书架</div><div class='badget'>1</div></a></li>
    
        <li><a class="flat-box" href="/categories/%E6%89%A9%E5%B1%95%E7%9F%A5%E8%AF%86/"><div class='name'>扩展知识</div><div class='badget'>7</div></a></li>
    
        <li><a class="flat-box" href="/categories/%E6%8A%80%E6%9C%AF/"><div class='name'>技术</div><div class='badget'>28</div></a></li>
    
        <li><a class="flat-box" href="/categories/%E6%96%B9%E6%A1%88/"><div class='name'>方案</div><div class='badget'>4</div></a></li>
    
        <li><a class="flat-box" href="/categories/%E6%97%A5%E5%B8%B8%E5%B7%A5%E5%85%B7/"><div class='name'>日常工具</div><div class='badget'>3</div></a></li>
    
        <li><a class="flat-box" href="/categories/%E7%94%9F%E6%B4%BB/"><div class='name'>生活</div><div class='badget'>5</div></a></li>
    
        <li><a class="flat-box" href="/categories/%E6%8A%80%E6%9C%AF/%E7%AE%97%E6%B3%95/"><div class='name'>算法</div><div class='badget'>1</div></a></li>
    
        <li><a class="flat-box" href="/categories/%E6%8A%80%E6%9C%AF/%E8%AF%AD%E8%A8%80/"><div class='name'>语言</div><div class='badget'>1</div></a></li>
    
        <li><a class="flat-box" href="/categories/%E6%89%A9%E5%B1%95%E7%9F%A5%E8%AF%86/%E8%AF%BB%E4%B9%A6%E5%AD%A6%E4%B9%A0/"><div class='name'>读书学习</div><div class='badget'>5</div></a></li>
    
        <li><a class="flat-box" href="/categories/%E6%8A%80%E6%9C%AF/%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/"><div class='name'>问题总结</div><div class='badget'>1</div></a></li>
    
    </ul>
    
</div>
</section>


  
<div class="m_widget tagcloud">
    <div class="header">标签云</div>
    <div class='content'>
        <a href="/tags/CAP/" style="font-size: 15.2px; color: #666">CAP</a> <a href="/tags/GIS/" style="font-size: 14px; color: #808080">GIS</a> <a href="/tags/Protobuf/" style="font-size: 14px; color: #808080">Protobuf</a> <a href="/tags/alfred/" style="font-size: 14px; color: #808080">alfred</a> <a href="/tags/angularjs/" style="font-size: 16.4px; color: #4d4d4d">angularjs</a> <a href="/tags/ansible/" style="font-size: 14px; color: #808080">ansible</a> <a href="/tags/arm/" style="font-size: 14px; color: #808080">arm</a> <a href="/tags/book/" style="font-size: 15.2px; color: #666">book</a> <a href="/tags/bug/" style="font-size: 14px; color: #808080">bug</a> <a href="/tags/django/" style="font-size: 14px; color: #808080">django</a> <a href="/tags/dubbo/" style="font-size: 14px; color: #808080">dubbo</a> <a href="/tags/fastcgi/" style="font-size: 14px; color: #808080">fastcgi</a> <a href="/tags/fastfs/" style="font-size: 14px; color: #808080">fastfs</a> <a href="/tags/git/" style="font-size: 14px; color: #808080">git</a> <a href="/tags/ionic/" style="font-size: 16.4px; color: #4d4d4d">ionic</a> <a href="/tags/java/" style="font-size: 20px; color: #000">java</a> <a href="/tags/jdk/" style="font-size: 14px; color: #808080">jdk</a> <a href="/tags/jdk8-java/" style="font-size: 15.2px; color: #666">jdk8.java</a> <a href="/tags/jmeter/" style="font-size: 14px; color: #808080">jmeter</a> <a href="/tags/linux/" style="font-size: 14px; color: #808080">linux</a> <a href="/tags/linux%E5%91%BD%E4%BB%A4/" style="font-size: 14px; color: #808080">linux命令</a> <a href="/tags/mac/" style="font-size: 15.2px; color: #666">mac</a> <a href="/tags/maven/" style="font-size: 14px; color: #808080">maven</a> <a href="/tags/mp3/" style="font-size: 14px; color: #808080">mp3</a> <a href="/tags/mysql/" style="font-size: 14px; color: #808080">mysql</a> <a href="/tags/nginx/" style="font-size: 14px; color: #808080">nginx</a> <a href="/tags/nocomment/" style="font-size: 14px; color: #808080">nocomment</a> <a href="/tags/poi/" style="font-size: 14px; color: #808080">poi</a> <a href="/tags/python/" style="font-size: 16.4px; color: #4d4d4d">python</a> <a href="/tags/redis/" style="font-size: 15.2px; color: #666">redis</a> <a href="/tags/rpc/" style="font-size: 14px; color: #808080">rpc</a> <a href="/tags/rsa/" style="font-size: 14px; color: #808080">rsa</a> <a href="/tags/schedule/" style="font-size: 14px; color: #808080">schedule</a> <a href="/tags/workflow/" style="font-size: 14px; color: #808080">workflow</a> <a href="/tags/zookeeper/" style="font-size: 14px; color: #808080">zookeeper</a> <a href="/tags/%E4%B8%80%E8%87%B4%E6%80%A7%E7%AE%97%E6%B3%95/" style="font-size: 14px; color: #808080">一致性算法</a> <a href="/tags/%E4%BA%BA%E7%94%9F/" style="font-size: 15.2px; color: #666">人生</a> <a href="/tags/%E4%BA%BA%E7%94%9F%E6%84%9F%E6%82%9F/" style="font-size: 14px; color: #808080">人生感悟</a> <a href="/tags/%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/" style="font-size: 14px; color: #808080">人脸识别</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E4%BB%93%E5%BA%93/" style="font-size: 14px; color: #808080">代码仓库</a> <a href="/tags/%E5%81%A5%E5%BA%B7/" style="font-size: 14px; color: #808080">健康</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 17.6px; color: #333">分布式</a> <a href="/tags/%E5%8A%A0%E5%AF%86%E8%A7%A3%E5%AF%86/" style="font-size: 14px; color: #808080">加密解密</a> <a href="/tags/%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/" style="font-size: 14px; color: #808080">压力测试</a> <a href="/tags/%E5%9B%BE%E7%89%87%E5%A4%84%E7%90%86/" style="font-size: 15.2px; color: #666">图片处理</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 16.4px; color: #4d4d4d">多线程</a> <a href="/tags/%E5%AD%98%E5%82%A8/" style="font-size: 14px; color: #808080">存储</a> <a href="/tags/%E5%AE%9A%E6%97%B6/" style="font-size: 14px; color: #808080">定时</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 14px; color: #808080">工具</a> <a href="/tags/%E5%B9%B6%E5%8F%91/" style="font-size: 14px; color: #808080">并发</a> <a href="/tags/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/" style="font-size: 14px; color: #808080">性能测试</a> <a href="/tags/%E6%84%9F%E6%82%9F/" style="font-size: 15.2px; color: #666">感悟</a> <a href="/tags/%E6%8E%92%E5%BA%8F/" style="font-size: 14px; color: #808080">排序</a> <a href="/tags/%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86/" style="font-size: 15.2px; color: #666">服务治理</a> <a href="/tags/%E6%9F%A5%E6%89%BE/" style="font-size: 14px; color: #808080">查找</a> <a href="/tags/%E6%B5%8B%E8%AF%95/" style="font-size: 14px; color: #808080">测试</a> <a href="/tags/%E7%88%AC%E5%B1%B1/" style="font-size: 14px; color: #808080">爬山</a> <a href="/tags/%E7%96%91%E6%83%91/" style="font-size: 15.2px; color: #666">疑惑</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 18.8px; color: #1a1a1a">算法</a> <a href="/tags/%E7%BB%8F%E9%AA%8C/" style="font-size: 14px; color: #808080">经验</a> <a href="/tags/%E7%BC%93%E5%AD%98/" style="font-size: 15.2px; color: #666">缓存</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 16.4px; color: #4d4d4d">设计模式</a> <a href="/tags/%E8%BD%AF%E4%BB%B6/" style="font-size: 14px; color: #808080">软件</a> <a href="/tags/%E8%BF%90%E5%8A%A8/" style="font-size: 14px; color: #808080">运动</a> <a href="/tags/%E8%BF%90%E7%BB%B4/" style="font-size: 15.2px; color: #666">运维</a> <a href="/tags/%E9%9F%B3%E4%B9%90/" style="font-size: 14px; color: #808080">音乐</a> <a href="/tags/%E9%9F%B3%E9%A2%91%E8%BD%AC%E6%8D%A2/" style="font-size: 14px; color: #808080">音频转换</a>
    </div>
</div>



      </aside>
      <script>setLoadingBarProgress(60);</script>
    </div>
  </div>
  <footer id="footer" class="clearfix">

	<div class="social-wrapper">
  	
      
        <a href="https://github.com/AaronWan" class="social github"
          target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
        <a href="/atom.xml" class="social rss"
          target="_blank" rel="external">
          <span class="icon icon-rss"></span>
        </a>
      
    
  </div>
  
    
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <span id="busuanzi_container_site_pv">本站浏览总访问量: <span id="busuanzi_value_site_pv"></span></span>
        <span class="post-meta-divider">|</span>
        <span id="busuanzi_container_site_uv">本站访问人数: <span id="busuanzi_value_site_uv"></span></span>
    
</footer>

  <script>setLoadingBarProgress(80);</script>
  

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src='//cdn.bootcss.com/node-waves/0.7.5/waves.min.js'></script>
<script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script>

<script src="/js/jquery.fitvids.js"></script>

<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "hexo";
  var ROOT = "/"||"/";
  if(!ROOT.endsWith('/'))ROOT += '/';
</script>

<script src="/js/search.js"></script>


<script src="/js/app.js"></script>



  <script>setLoadingBarProgress(100);</script>
</body>
</html>
